系统发布流程
===========

首先可以看一下《扫码支付网络结构图.pdf》，系统结构整体来说，是很简单的：一个代理、两个应用、
三个数据库。

应用是集群部署的，也就是说有多台服务器上部署着相同的应用，这些应用一方面负载均衡，另一方面互
为备份。系统平滑升级正是利用了集群这一特性。

Nginx 可以通过改变配置，然后重新加载配置，来平滑切换后端应用服务器，不处理逻辑的服务器可以
从 Nginx 上拿掉。由于 Nginx 平滑重启特性，配置加载过程中，不影响正在处理的请求。

数据库是副本集模式的，逻辑上可以认为是一个，理论上不影响系统发布。

系统发布分为如下几步：

1. 发布到测试环境，并验证
2. 标记生产环境源码，更新 ChangeLog
3. 第一台服务器上发布应用
4. 生产测试，若失败，则回滚
5. 同理发布其他服务器


下面对每个步骤做详细说明：


### 发布到测试环境，并验证

测试环境验证必不可少，严格来说，这个应该不算发布流程，因为发布总是在测试完全通过后才开始的。

平时，大多时候工作在 develop 分支，也可能有其他独立分支，但最终会合并到 develop 分支。

要发布到测试环境时，先切换到 testing 分支 `git checkout develop`，然后把 develop 分支
合并到 testing 分支 `git merge develop --no-ff`。然后执行 `./publish.sh test`，完成
发布。

当然也可以从 develop 分支直接发布到测试环境，但是这样测试环境的版本就没有对应的标签，找不到对应，
不方便管理。当然 `./quickpay -version` 会打印版本信息和编译信息，但一般来说每个环境一个分
支，不会错乱。

测试环境只部署了一个应用，非集群模式，所以发布期间，系统有 8s 左右的服务中断，需注意。

注意：发布完成后记得切换回 develop 分支做开发，最好不要在 testing 上做开发。


### 标记生产环境源码，更新 ChangeLog

测试环境全部测试通过后，切换到 master 分支，`git checkout master`，然后把 testing 分支
合并到 master 分支。务必确定 testing 分支是对应测试环境的最新代码。

执行 `git tag` 找到上一次发布的标签，比如 v1.3.7，然后执行
`git log --pretty=format:'* %s' master...v1.3.7`，把输出结果复制到 ChangeLog.md 中，
并以这些注释为指导，整理一份变更清单。版本号增加，比如 v1.3.8。

执行 `git tag v1.3.8`，打好版本，并提交到 github `git push --tags cil master`。


### 第一台服务器上发布应用

先从 Nginx 上拿掉一台后端服务器，比如 app1，需要修改配置文件。为了方便发布时修改文件，Nginx
除日志外的所有文件都加入了 git 管理。目前有 3 个分支：master、yun-app1、yun-app2。

* master 包含了完整的配置和所有服务器，正常情况下都用这个分支的配置；
* yun-app1 去掉了后端服务器 app2，只有 app1；
* yun-app2 去掉了后端服务器 app1，只有 app2。

所以要发布 app1，只需要切换到 yun-app2 即可（注意，这时可用服务器是 app2 不是 app1，要停
掉的服务器是 app1）。到 Nginx 目录下，`cd /opt/nginx`，`git checkout yun-app2`，
然后 `sbin/nginx -s reload`，这时可以发布了。保险起见，监控 app1 和 app2 的日志，
`tail -f /opt/quickpay/logs/quickpay.log`，等待一段时间，如果 app1 日志不动了，而
 app2 日志速度变快了，说明切换成功，才可以开始发布 app1。一般发布时必须监控日志，避免误操作。

发布很简单，执行 `./publish.sh app1`, 确认一次即可。


### 生产测试，若失败，则回滚

虽然发布了一台，但还没有生效，如果要生效，需要切换 Nginx 配置文件到 app1，执行
 `git checkout yun-app1`，然后 `sbin/nginx -s reload`，这时系统已经是最新版了。

开始生产验证。。。
验证即便没发现问题，也一定要观察一段时间，不能立即发布第二台，否则发现问题不能及时回滚，因为
老版本被覆盖，要回滚非常麻烦。

如果验证失败，立即执行 `git checkout yun-app2`，然后 `sbin/nginx -s reload`，退回到老
版本，检查代码后，重新打 tag，重新发布。

条件允许的情况下，可以再部署一台 Nginx 专门做预发布验证，这样更加安全。


### 同理发布其他服务器

当生产验证通过后，可以发布另一台服务器了。这时 Nginx 配置文件在 yun-app1 分支。

执行 `./publish.sh app2`，发布完后，Nginx 切换到 master 分支 `git checkout master`，
然后 `sbin/nginx -s reload`，监控日志，理论上两台服务器代码完全相同，应该不会再有问题，但
必须防止意外情况发生。

如果一切正常，代码切换回 develop 分支，然后 `git merge master`。

至此，发布流程结束。

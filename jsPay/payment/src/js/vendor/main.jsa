'use strict';

var Main = function() {
	var merID, inscd;
	var submit = false;

	var init = function() {
		var merchantCode = Util._getUrlParam('merchantCode');
		if (merchantCode === null) {
			return;
		}
		var data = 'merchantCode=' + merchantCode
			//var url = 'http://test.quick.ipay.so/scanpay/fixed/merInfo';
		var url = Util.getServer() + '/scanpay/fixed/merInfo';
		$.ajax({
			type: 'POST',
			url: url,
			async: true,
			data: data,
			dataType: 'json',
			success: function(data) {

				if (data.response === '00') {
					merID = data.merID;
					inscd = data.inscd;
					var titleOne = data['title_one'];
					var titleTwo = data['title_two'];
					document.getElementById('title_one').innerHTML = '欢迎光临' + titleOne;
					document.getElementById('title_two').innerHTML = '本店名称-' + titleTwo;
					document.title = titleOne;
					window.localStorage.setItem('title_one', titleOne);
				} else {
					window.alert(data.errorDetail);
					back();
				}
			},

			error: function(message) {
				window.alert(JSON.stringify(message));
				back();
			}
		});

	}

	var back = function(index) {
		WeixinJSBridge.call('closeWindow');

	}

	var getCode = function() {
		var merchantCode = Util._getUrlParam('merchantCode');
		var redirectUri = Util.getServer() + '/scanpay/weChat/oauth2?merchantCode=' + merchantCode + '&showwxpaytitle=1';
		window.location.href = redirectUri;
	}

	var wpay = function() {
		if (submit) {
			return;
		}
		var code = Util._getUrlParam('code');
		var money = document.getElementById('money').value;
		if (check(money)) {
			submit = true;
			var orderAmount = parseFloat(money);
			orderAmount = orderAmount.toFixed(2);
			var currency = 'CNY',
				now = new Date();
			var orderNum = now.Format('YYMMddHHmmss');
			var veriCode = ''
			for (var i = 0; i < 5; i++) {
				orderNum = orderNum + Math.floor(Math.random() * 10);
			}

			for (var j = 0; j < 4; j++) {
				veriCode = veriCode + Math.floor(Math.random() * 10);
			}

			var orderData = {
				orderNum: orderNum,
				txamt: '' + Util.getTxamt(orderAmount),
				orderCurrency: currency,
				backUrl: 'http://wx.vtpayment.com/wapdemo/agent/onekeypay/result',
				frontUrl: 'payresult.html',
				mchntid: merID,
				inscd: inscd,
				goodsInfo: '云收银wap客户端',
				attach: '用户附加数据原样返回',
				veriCode: veriCode

			};

			yunshouyin.startWPay1(orderData, code);

		}


	}


	function check(v) {
		if (v.length === 0) {
			window.alert('金额不能为空');
			return false;
		}
		var a = /^[0-9]*(\.[0-9]{1,2})?$/;
		if (!a.test(v)) {
			window.alert('金额不正确');
			return false;
		} else {
			return true;
		}
	}

	var getResult = function() {
		var state = Util._getUrlParam('state');
		if (state === '0') {
			window.location.replace('result.html?code=' + Util._getUrlParam('code') + '&orderAmount=' + Util.getNormalTxamt(Util._getUrlParam('txamt')));
		} else {
			window.location.replace('fail.html');
		}
	}

	var initResult = function() {

		var code = Util._getUrlParam('code');
		var orderAmount = Util._getUrlParam('orderAmount');
		document.getElementById('code').innerHTML = code;
		document.getElementById('amount').innerHTML = '付款金额:¥' + orderAmount;
		document.title = window.localStorage.getItem('title_one');
	}

	var initFailResult = function() {
		document.title = window.localStorage.getItem('title_one');
	}


	return {
		init: init,
		wpay: wpay,
		getResult: getResult,
		back: back,
		initResult: initResult,
		initFailResult: initFailResult,
		getCode: getCode
	}

}();

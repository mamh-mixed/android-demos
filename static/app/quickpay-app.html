<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/app-router/app-router.html">
<link rel="import" href="layouts/scaffold-layout.html">
<link rel="import" href="elements/login-form/login-form.html">
<dom-module id="quickpay-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <app-router id="appRouter" init="manual"
      on-state-change="handleStateChangeEvent"
      on-activate-route-start="handleActivateRouteStartEvent"
      on-logout="handleLogoutEvent"
      on-toast-open="handleToastOpenEvent"
      on-page-jump="handlePageJumpEvent">
      <app-route path="/" import="pages/user-login.html" bindRouter on-login-success="handleLoginSuccessEvent"></app-route>

      <app-route path="/system/users" name="user-list" import="pages/users-page.html"></app-route>

      <app-route path="/config/agents" name="agentList" import="pages/agents-page.html"></app-route>
      <app-route path="/config/subAgents" name="subAgentList" import="pages/sub-agents-page.html"></app-route>
      <app-route path="/config/groups" name="group-list" import="pages/groups-page.html"></app-route>
      <app-route path="/config/configMer" name="config-merchant" import="pages/config-merchant-page.html"></app-route>
      <app-route path="/config/upload" name="upload-page" import="pages/file-upload-page.html"></app-route>
      <app-route path="/config/merchants" name="merchant-list" import="pages/merchants-page.html"></app-route>
      <app-route path="/config/merchant/:merId" name="merchant-edit" import="pages/config-merchant-page.html"></app-route>
      <app-route path="/config/chanMers" name="channel-merchant-list" import="pages/channel-merchants-page.html"></app-route>
      <app-route path="/config/routes" name="route-list" import="pages/routes-page.html"></app-route>
      <app-route path="/config/route/:merId" name="routeListOfMerchant" import="pages/routes-page.html"></app-route>

      <app-route path="/quickPay/merchants" name="quick-merchant-list" import="pages/quick-pay/qp-merchants-page.html"></app-route>
      <app-route path="/quickPay/chanMers" name="quick-chanMer-list" import="pages/quick-pay/qp-channel-merchants-page.html"></app-route>
      <app-route path="/quickPay/routes" name="quick-route-list" import="pages/quick-pay/qp-routes-page.html"></app-route>
      <app-route path="/quickPay/route/:merId" name="quickRouteListOfMerchant" import="pages/quick-pay/qp-routes-page.html"></app-route>

      <app-route path="/trade/list" name="trade-list" import="pages/trade/scan-pay-page.html"></app-route>
      <app-route path="/trade/bindingpay/list" name="trade-bindingpay-list" import="pages/trade/binding-pay-page.html"></app-route>
      <app-route path="/trade/reports" name="report-list" import="pages/trade/reports-page.html"></app-route>
      <app-route path="/trade/old/reports" name="report-list-old" import="pages/trade/old-system-page.html"></app-route>

      <app-route path="/test/scanpay" name="test-scanpay" import="pages/test/scanpay-page.html"></app-route>
      <app-route path="/test/bindingpay" name="test-bindingpay" import="pages/test/bindingpay-page.html"></app-route>
      <app-route path="/test/qiniu" name="test-qiniu" import="pages/test/qiniu-page.html"></app-route>
      <app-route path="/test/filereader" name="test-filereader" import="pages/test/file-reader-page.html"></app-route>
      <app-route path="/404" name="not-found" import="pages/common/not-found-page.html"></app-route>
      <app-route path="*" name="not-found" import="pages/common/not-found-page.html"></app-route>
    </app-router>

    <paper-toast id="toast" duration="5000" visible="true" text$="{{toastText}}" style="z-index:1000;"></paper-toast>
    <paper-dialog id="reloginDialog" hidden modal>
      <login-form style="width:252px;"></login-form>
    </paper-dialog>
    <iron-localstorage name="SESSIONID" value="{{sessionId}}" on-iron-localstorage-load-empty="handleNotLogin"></iron-localstorage>
    <iron-localstorage name="USERTYPE" value="{{userType}}"></iron-localstorage>
    <iron-localstorage name="CILUSER" value="{{nickName}}"></iron-localstorage>
    <x-ajax id="findSessionAjax" method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleFindSessionResponse"></x-ajax>
    <x-ajax id="deleteSessionAjax" method="GET" url="/master/session/delete" handle-as="json" debounce-duration="1000" on-response="handleDeleteSessionResponse"></x-ajax>
  </template>
  <script>
    (function() {
      'use strict';
      var notAuthPath = [
        '/404',
        '/'
      ];
      var agentRoutes = ['/trade/list', '/trade/reports'];

      Polymer({
        is: 'quickpay-app',

        properties: {
          route: {
            type: Object,
            value: {},
          }
        },
        attached: function() {
          this.$.appRouter.init();
        },
        // 当没有登入的时候，跳转到登入页面
        handleNotLogin: function() {
          // document.querySelector('#appRouter').go('/');
          this.$.appRouter.go('/')
          return;
        },
        // // 查找session的响应事件
        // handleFindSessionResponse: function(e) {
        //   var response = e.detail.response;
        //   // 如果没有登录
        //   if (response.status !== 0) {
        //     // 当前页面就是登录页
        //     if (this.route.path === "/") {
        //       return
        //     }
        //     // 当前页面不是登录页，则跳转到登录页
        //     this.$.appRouter.go('/');
        //     return;
        //   }
        //
        //   // 登录了，但当前页是登录页，不必再登录了，跳走
        //   if (this.route.path === "/") {
        //     this.$.appRouter.go('/trade/list');
        //     return
        //   }
        //
        //   // 登录了，但当前页不是登录页，渲染菜单
        //   this.set('user', response.data);
        //   this.set('userType', response.data.userType);
        //   if (this.userType === 'admin') {
        //     this.menus = this.adminMenus;
        //   } else if (this.userType === 'agent' || this.userType === 'group' || this.userType === 'merchant') {
        //     this.menus = this.agentMenus;
        //   }
        // },
        // 路由改变事件
        handleStateChangeEvent: function(e) {
          console.log(e.type, e.detail.path);
          if (notAuthPath.indexOf(e.detail.path) >= 0) {
            return;
          }
          var isAccess = false;

          if (this.userType === 'admin') {
            return;
          }

          if (this.userType !== 'agent' && this.userType !== 'group' && this.userType !== 'merchant') {
            this.$.appRouter.go('/');
            return;
          }

          // TODO 按照不同的用户类型给定不同的菜单权限
          for (var i = 0; i < agentRoutes.length; i++) {
            if (agentRoutes[i] === e.detail.path) {
              isAccess = true;
              break;
            }
          }
          if (!isAccess) {
            this.$.appRouter.go('/404');
            e.preventDefault();
          }
        },
        // 新路由进入前
        handleActivateRouteStartEvent: function(e){
          this.set('route.path', e.detail.path);
        },
        // 处理子孙元素冒泡的登录成功事件
        handleLoginSuccessEvent: function(e){
          console.log('login success', e.detail);
          this.set('sessionId', e.detail.sessionId);
          this.set('userType', e.detail.userType);
          this.set('nickName', e.detail.nickName);
        },
        // 处理子孙元素冒泡的登出事件
        handleLogoutEvent: function(e){
          // 删除后台sesseion信息
          this.$.deleteSessionAjax.params = {
            'sessionId': this.sessionId,
          };
          this.$.deleteSessionAjax.generateRequest();
        },
        handleDeleteSessionResponse: function(e) {
          // 清除客户端 SessionID
          document.cookie = 'QUICKMASTERID=; path=/master; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          // 清除localStorage中的信息
          this.set('sessionId','');
          this.set('userType','');
          this.set('user', {});
          // 跳转至登录页面
          this.$.appRouter.go('/');
        },
        // 处理子孙元素冒泡的toast open事件
        handleToastOpenEvent: function(e){
          this.set('toastText', e.detail);
          this.$.toast.show();
        },
        // 处理子孙元素冒泡的页面跳转事件
        handlePageJumpEvent: function(e){
          this.$.appRouter.go(e.detail);
        }
      });
    })();
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="config-merchant">
  <style>
    :host {
      display: block;
    }

    paper-tabs {
      background-color: var(--default-primary-color);
      color: var(--text-primary-color);
      box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
    }

    paper-tabs[noink][no-bar] paper-tab.iron-selected {
      color: #ffff8d;
    }

    paper-tabs[align-bottom] {
      box-shadow: 0px -2px 6px rgba(0, 0, 0, 0.15);
    }

    iron-pages section {}

    .row {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }

    .row paper-input,
    .row pre,
    .row label,
    .row paper-textarea,
    .row paper-checkbox,
    .row paper-radio-button,
    .row .check-box-group,
    .row x-select {
      @apply(--layout-flex-6);
      margin-right: 20px;
    }

    .row paper-input:last-child,
    .row pre:last-child,
    .row label:last-child,
    .row paper-textarea:last-child,
    .row paper-checkbox:last-child,
    .row paper-radio-button:last-child,
    .row .check-box-group:last-child,
    .row x-select:last-child {
      margin-right: 0;
    }

    .row paper-checkbox,
    .row paper-radio-button {
      padding-top: 20px;
    }

    .check-box-group > label {
      color: #727272;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 12px;
      font-weight: 400;
      line-height: 24px;
    }

    .check-box-area paper-checkbox {
      padding-top: 0;
    }

    paper-button.colorful {
      background: var(--dark-primary-color);
      color: var(--text-primary-color);
    }
  </style>
  <template>
    <paper-tabs selected="{{idx}}">
      <paper-tab>商户</paper-tab>
      <paper-tab>支付宝</paper-tab>
      <paper-tab>微信</paper-tab>
      <paper-tab>QQ 钱包</paper-tab>
    </paper-tabs>

    <iron-pages selected="{{idx}}">
      <section>
        <div class="row">
          <paper-input label="代理代码/机构代码" value="{{merchant.insCode::input}}"></paper-input>
          <paper-input label="代理名称/机构名称" value="{{merchant.agentName::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="集团商户代码" value="{{merchant.groupCode::input}}"></paper-input>
          <paper-input label="集团商户名称" value="{{merchant.groupName::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="商户编号" value="{{merchant.merId::input}}"></paper-input>
          <paper-input label="商户名称" value="{{merchant.detail.merName::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="商户交易币种" value="{{merchant.transCurr::input}}"></paper-input>
          <x-select items="[[merStatusMap]]" selected-item="{{merStatus}}" label="商户状态"></x-select>
        </div>
        <div class="row">
          <div class="check-box-group">
            <label for="permissionGroup">接口权限</label>
            <div id="permissionGroup" class="check-box-area">
              <template id="permissionRepeatDom" is="dom-repeat" items="{{permissionArray}}">
                <paper-checkbox checked$="{{item.isChecked}}" on-change="handlePermissionChangeEvent">
                  <span>{{item.value}}</span>
                </paper-checkbox>
              </template>
            </div>
          </div>
          <paper-radio-button id="sNeedSignCheck" checked$="{{merchant.isNeedSign}}" on-change="handleIsNeedSignChangeEvent"> 是否开启验签</paper-radio-button>
        </div>
        <div class="row">
          <paper-input label="商户加密密钥" value="{{merchant.encryptKey::input}}"></paper-input>
          <paper-input label="商户签名密钥" value="{{merchant.signKey::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="门店ID" value="{{merchant.detail.shopID::input}}"></paper-input>
          <paper-input label="门店类型" value="{{merchant.detail.shopType::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="品牌编号" value="{{merchant.detail.brandNum::input}}"></paper-input>
          <paper-input label="备注信息" value="{{merchant.remark::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-button class="colorful" raised on-tap="handleSaveMerchantTapped">保存商户信息</paper-button>
        </div>
      </section>
      <section>
        <div class="row">
          <paper-input label="商户号" value="{{alipay.chanMerId::input}}"></paper-input>
          <paper-input label="商户名称" value="{{alipay.chanMerName::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="讯联跟渠道费率" value="{{alipay.acqFee::input}}"></paper-input>
          <paper-input label="商户跟讯联费率" value="{{alipay.merFee::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="签名证书" value="{{alipay.signCert::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-button class="colorful" raised on-tap="handleSaveALPTapped">保存支付宝信息</paper-button>
        </div>
      </section>
      <section>
        <div class="row">
          <paper-input label="微信商户号" value="{{weixin.chanMerId::input}}"></paper-input>
          <paper-input label="微信商户名称" value="{{weixin.chanMerName::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-checkbox id="isAngentCheck" checked on-change="handleIsAgentChangeEvent"> 是否代理商模式</paper-checkbox>
          <paper-input label="大商户号" value="{{weixin.subMerId::input}}" disabled$="{{!weixin.isAgent}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="讯联跟渠道费率" value="{{weixin.acqFee::input}}"></paper-input>
          <paper-input label="商户跟讯联费率" value="{{weixin.merFee::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="微信支付App Id" value="{{weixin.wxpAppId::input}}"></paper-input>
          <paper-input label="签名证书" value="{{weixin.signCert::input}}"></paper-input>
        </div>
        <div class="row">
          <paper-input label="HTTP 证书" type="file" on-change="handleWeixinHttpCertFile"></paper-input>
          <paper-input label="HTTP 密钥" type="file" on-change="handleWeixinHttpKeyFile"></paper-input>
        </div>
        <div class="row">
          <label>HTTP 证书</label>
          <label>HTTP 密钥</label>
        </div>
        <div class="row">
          <pre>{{weixin.httpCert}}</pre>
          <pre>{{weixin.httpKey}}</pre>
        </div>
        <div class="row">
          <paper-button class="colorful" raised on-tap="handleSaveWXPTapped">保存微信信息</paper-button>
        </div>
      </section>
      <section>
        <div class="row">
          <paper-input label="即将上线。。。" value=""></paper-input>
        </div>
      </section>
    </iron-pages>
    <iron-ajax id="saveMerchantAjax" method="POST" url="/master/merchant/save" handle-as="json" debounce-duration="1000" on-response="handleSaveMerchantResponse"></iron-ajax>
    <iron-ajax id="saveChannelMerchantAjax" method="POST" url="/master/channelMerchant/save" handle-as="json" debounce-duration="1000" on-response="handleSaveChannelMerchantResponse"></iron-ajax>
    <iron-ajax id="saveRouterAjax" method="POST" url="/master/router/save" handle-as="json" debounce-duration="1000" on-response="handleSaveRouterResponse"></iron-ajax>
    <iron-ajax id="queryMerchantAjax" method="GET" url="/master/merchant/one" handle-as="json" debounce-duration="1000" on-response="handleQueryMerchantResponse"></iron-ajax>
    <iron-ajax id="alpChanMerAjax" method="GET" url="/master/channelMerchant/findByMerIdAndCardBrand" handle-as="json" debounce-duration="1000" on-response="handleAlpChanMerResponse"></iron-ajax>
    <iron-ajax id="wxpChanMerAjax" method="GET" url="/master/channelMerchant/findByMerIdAndCardBrand" handle-as="json" debounce-duration="1000" on-response="handleWxpChanMerResponse"></iron-ajax>
    <iron-ajax id="wxpRouterAjax" method="GET" url="/master/router/one" handle-as="json" debounce-duration="1000" on-response="handleWxpRouterResponse"></iron-ajax>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'config-merchant',
        properties: {
          merId: {
            type: String,
            reflectToAttribute: true
          },
          params: {
            type: Object
          },
          merStatusMap: {
            type: Array,
            value: [{
              key: 'Normal',
              value: '正常商户'
            }, {
              key: 'Test',
              value: '测试商户'
            }, {
              key: 'Deleted',
              value: '已删除商户'
            }]
          },
          permissionArray: {
            type: Array,
            value: [{
              key: 'PURC',
              value: '下单支付',
              isChecked: false
            }, {
              key: 'PAUT',
              value: '预下单',
              isChecked: false
            }, {
              key: 'QYFK',
              value: '企业付款',
              isChecked: false
            }, {
              key: 'INQY',
              value: '查询订单',
              isChecked: false
            }, {
              key: 'VOID',
              value: '撤销',
              isChecked: false
            }, {
              key: 'REFD',
              value: '退款',
              isChecked: false
            }, {
              key: 'CANC',
              value: '关单',
              isChecked: false
            }]
          }
        },
        attributeChanged: function() {
          if (!this.merId) {
            return;
          }
          this.set('merchant', {});
          this.set('alipay', {});
          this.set('weixin', {});

          // 根据merId查找商户信息
          var params = {
            merId: this.merId
          };
          this.$.queryMerchantAjax.params = params;
          this.$.queryMerchantAjax.generateRequest();

          // 根据merId查找支付宝渠道信息
          var alpParams = {
            merId: this.merId,
            cardBrand: 'ALP'
          };
          this.$.alpChanMerAjax.params = alpParams;
          this.$.alpChanMerAjax.generateRequest();

          // 根据merId查找微信渠道信息
          var wxpParams = {
            merId: this.merId,
            cardBrand: 'WXP'
          };
          this.$.wxpChanMerAjax.params = wxpParams;
          this.$.wxpChanMerAjax.generateRequest();
        },
        // 编辑的时候查询一个商户的响应事件
        handleQueryMerchantResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }


          var item = response.data,
            permissions = item.permission || [];
          this.set('merchant', item);
          // 遍历当前商户的权限列表，把它们映射到this.permissionArray上，然后在页面上展示
          for (var i = 0, il = permissions.length; i < il; i++) {
            var p = permissions[i];
            for (var j = 0, jl = this.permissionArray.length; j < jl; j++) {
              var pa = this.permissionArray[j];
              if (pa.key === p) {
                this.set('permissionArray.' + j + '.isChecked', true);
                break;
              }
            }
          }
          i = 0;
          for (var l = this.merStatusMap.length; i < l; i++) {
            var merStatusItem = this.merStatusMap[i];
            if (item.merStatus === merStatusItem.key) {
              this.set('merStatus', merStatusItem);
              break;
            }
          }
        },
        // 编辑的时候查询支付宝路由渠道商户请求的响应事件
        handleAlpChanMerResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0 || !response.data) {
            Util.toast(response.message, 3000);
            return;
          }

          this.set('alipay', response.data);
        },
        // 编辑的时候查询微信路由渠道商户请求的响应事件
        handleWxpChanMerResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0 || !response.data) {
            Util.toast(response.message, 3000);
            this.set('weixin.httpCert', '');
            this.set('weixin.httpKey', '');
            return;
          }

          this.set('weixin', response.data);

          // 加载微信路由信息
          var params = {
            merId: this.merId,
            cardBrand: 'WXP'
          };
          this.$.wxpRouterAjax.params = params;
          this.$.wxpRouterAjax.generateRequest();
        },
        // 编辑的时候查询微信路由请求的响应事件
        handleWxpRouterResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0 || !response.data) {
            Util.toast(response.message, 3000);
            return;
          }

          this.set('weixin.subMerId', response.data.subMerId);
          this.set('weixin.isAgent', response.data.isAgent);
        },
        ready: function() {
          this.idx = 0;
          this.merchant = {
            insCode: '',
            agentName: '',
            groupCode: '',
            groupName: '',
            merId: '',
            detail: {
              merName: '',
              brandNum: '',
              shopId: '',
              shopType: ''
            },
            merStatus: '',
            transCurr: '156',
            signKey: '',
            isNeedSign: false,
            encryptKey: '',
            permission: []
          };
          this.alipay = {
            chanCode: 'ALP',
            chanMerId: '',
            chanMerName: '',
            acqFee: '',
            merFee: '',
            signCert: ''
          };
          this.weixin = {
            chanCode: 'WXP',
            isAgent: true,
            subMerId: '1236593202',
            chanMerId: '',
            chanMerName: '',
            acqFee: '',
            merFee: '',
            wxpAppId: '',
            signCert: '',
            httpCert: '',
            httpKey: ''
          };
        },
        // 保存商户的按钮事件
        handleSaveMerchantTapped: function() {
          this.$.saveMerchantAjax.body = JSON.stringify(this.merchant);
          this.$.saveMerchantAjax.generateRequest();
        },
        // 保存商户的ajax响应事件
        handleSaveMerchantResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          Util.toast(response.message, 1000);
        },
        // 保存支付宝信息的按钮事件
        handleSaveALPTapped: function() {
          this.$.saveChannelMerchantAjax.body = JSON.stringify(this.alipay);
          this.$.saveChannelMerchantAjax.generateRequest();

          var obj = {
            merId: this.merchant.merId,
            cardBrand: 'ALP',
            chanCode: this.alipay.chanCode,
            chanMerId: this.alipay.chanMerId
          };

          this.$.saveRouterAjax.body = JSON.stringify(obj);
          this.$.saveRouterAjax.generateRequest();
        },
        // 保存微信信息的按钮事件
        handleSaveWXPTapped: function() {
          var router = {
            merId: this.merchant.merId,
            cardBrand: 'WXP',
            chanCode: this.weixin.chanCode,
            chanMerId: this.weixin.chanMerId
          };

          // 如果是代理上模式，交换 chanMerId 和
          if (this.weixin.isAgent) {
            router.isAgent = this.weixin.isAgent;
            router.subMerId = this.weixin.merId;
            router.chanMerId = this.weixin.subMerId;
          }
          this.$.saveChannelMerchantAjax.body = JSON.stringify(this.weixin);
          this.$.saveChannelMerchantAjax.generateRequest();

          this.$.saveRouterAjax.body = JSON.stringify(router);
          this.$.saveRouterAjax.generateRequest();
        },
        // 保存路由的ajax响应事件
        handleSaveRouterResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          Util.toast(response.message, 1000);
        },
        // 保存渠道商户ajax请求响应事件
        handleSaveChannelMerchantResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          Util.toast(response.message, 1000);
        },
        // 是否代理商模式的改变事件
        handleIsAgentChangeEvent: function() {
          this.set('weixin.isAgent', this.$.isAngentCheck.checked);
          //   if (!this.weixin.isAgent) {
          //     this.set('weixin.subMerId', '');
          //   }
        },
        // 是否需要验签的改变事件
        handleIsNeedSignChangeEvent: function() {
          this.set('merchant.isNeedSign', this.$.sNeedSignCheck.checked);
        },
        // 接口权限中的复选框组的改变事件
        handlePermissionChangeEvent: function(e) {
          var checkbox = e.target,
            item = e.model.item,
            index = this.merchant.permission.indexOf(item.key);

          if (checkbox.checked) {
            // 勾选了
            if (index >= 0) {
              return;
            }
            this.push('merchant.permission', item.key);
          } else {
            // 没勾选
            if (index < 0) {
              return;
            }
            this.splice('merchant.permission', index, 1);
          }
        },

        // html5 读取证书文件内容
        handleWeixinHttpCertFile: function(e) {
          var _this = this;
          var files = e.srcElement.files;
          // console.log(files);
          if (files.length) {
            var file = files[0];
            if ('application/x-x509-ca-cert' === file.type) {
              var reader = new FileReader();
              reader.onload = function() {
                //   console.log(this.result);
                if (/BEGIN CERTIFICATE/.test(this.result) === false) {
                  Util.toast('文件内容错误，请上传证书文件，该类文件以 ---BEGIN CERTIFICATE--- 开头', 3000);
                  return;
                }
                _this.set('weixin.httpCert', this.result);
              };
              reader.readAsText(file);
            } else {
              Util.toast('文件格式错误，只能上传 PEM 格式的文件', 3000);
            }
          }
        },
        handleWeixinHttpKeyFile: function(e) {
          var _this = this;
          var files = e.srcElement.files;
          // console.log(files);
          if (files.length) {
            var file = files[0];
            if ('application/x-x509-ca-cert' === file.type) {
              var reader = new FileReader();
              reader.onload = function() {
                // console.log(this.result);
                if (/BEGIN RSA PRIVATE KEY/.test(this.result) === false) {
                  Util.toast('文件内容错误，请上传密钥文件，该类文件以 -----BEGIN RSA PRIVATE KEY----- 开头', 3000);
                  return;
                }
                _this.set('weixin.httpKey', this.result);
              };
              reader.readAsText(file);
            } else {
              Util.toast('文件格式错误，只能上传 PEM 格式的文件', 3000);
            }
          }
        }
      });
    })();
  </script>
</dom-module>

<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="bindingpay-trade-list">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <form is="iron-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <paper-input name="startTime" label="* 交易时间从" on-tap="showStartTimeDialog" value="{{cond.startTime::input}}}"></paper-input>
        <paper-dialog id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
          <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <paper-input name="endTime" label="* 交易时间到" on-tap="showEndTimeDialog" value="{{cond.endTime::input}}}"></paper-input>
        <paper-dialog id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
          <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <paper-input label="代理代码" name="agentCode"></paper-input>
        <paper-input label="集团代码" name="groupCode"></paper-input>
        <paper-input label="商户代码" name="merId"></paper-input>
        <paper-input label="订单号" name="orderNum"></paper-input>
        <paper-input label="关联订单号" name="origOrderNum"></paper-input>
        <paper-input label="应答码" name="respcd"></paper-input>
        <x-select items="[[busicds]]" name="busicd" selected-item="{{busicd}}" label="交易类型"></x-select>
        <x-select items="[[transStatusMap]]" name="transStatus" selected-item="{{transStatus}}" label="交易状态"></x-select>
        <paper-input label="绑定ID" name="bindingId"></paper-input>
        <paper-input id="payType" name="pay" value="bp" hidden></paper-input>
        <paper-button class="colorful" raised on-tap="queryAction">查询</paper-button>
        <paper-button class="colorful" raised>
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href="{{reportUri}}">下载报表</a>
        </paper-button>
      </div>
      <table class="data-grid">
        <thead>
          <tr>
            <th align="center">序号</th>
            <th align="center">商户代码</th>
            <th align="left">订单号</th>
            <th align="center">绑定ID</th>
            <th align="center">交易类型</th>
            <th align="right">交易金额(元)</th>
            <th align="center">渠道</th>
            <th align="center">交易状态</th>
            <th align="center">应答码</th>
            <th align="center">退款</th>
            <th align="center">交易时间</th>
            <th align="center">更新时间</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{trades}}">
            <tr on-dblclick="showTradeViewHandler">
              <td align="center">{{addOneFilter(index)}}</td>
              <td align="center">{{item.merId}}</td>
              <td align="left">{{item.orderNum}}</td>
              <td align="center">{{item.bindingId}}</td>
              <td align="center">{{busicdFilter(item.busicd)}}</td>
              <td align="right">{{_currencyFilter(item.transAmt)}}</td>
              <td align="center">{{chanFilter(item.chanCode)}}</td>
              <td align="center">{{transStatusFilter(item.transStatus)}}</td>
              <td align="center" class$="{{getRespCodeColor(item.respcd)}}">{{item.respcd}}</td>
              <td align="center">{{item.refundStatus}}</td>
              <td align="center">{{item.transTime}}</td>
              <td align="center">{{item.updateTime}}</td>
            </tr>
          </template>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="255" align="right">
              <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
            </td>
          </tr>
        </tfoot>
      </table>
    </form>
  </template>
  <script>
    var TRANS_TYPE_MAP = {
      '1': '支付交易',
      '2': '退款交易',
      '7': '结算交易',
    };

    Polymer({
      is: 'bindingpay-trade-list',

      properties: {
        trades: {
          type: Array,
          value: []
        },
        busicd: {
          type: Object
        },
        busicds: {
          type: Array,
          value: (function() {
            var busicds = [],
              map = {};
            for (var k in TRANS_TYPE_MAP) {
              if (!map[k.toUpperCase()]) {
                map[k.toUpperCase()] = TRANS_TYPE_MAP[k];
              }
            }
            Object.keys(map).forEach(function(v) {
              busicds.push({
                key: v,
                value: map[v]
              });
            });
            return busicds;
          })()
        },
        transStatus: {
          type: Object
        },
        transStatusMap: {
          type: Array,
          value: [{
            key: '10',
            value: '处理中'
          }, {
            key: '20',
            value: '失败'
          }, {
            key: '30',
            value: '成功'
          }, {
            key: '40',
            value: '已关闭'
          }, ]
        }
      },
      ready: function() {
        this.cond = {
          startTime: new Date().format('yyyy-MM-dd'),
          endTime: new Date().format('yyyy-MM-dd'),
          total: 0,
          page: 1,
          size: 20
        };
        this.busicd = {};
        this.trades = [];
        this.transStatus = {};
      },
      observers: [
        // '_watchBusicdChange(busicd.key)',
        '_watchCondChange(cond.*)',
        // '_watchTransStatusChange(transStatus.key)'
      ],
      //   _watchBusicdChange: function(key) {
      //     this.cond.busicd = key;
      //   },
      _watchCondChange: function(newValue) {
        if (newValue.path !== 'cond.page') {
          this.set('cond.page', 1);
        }
        var t = new Date().format('yyyyMMdd-hhmmss');
        this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=报表_' + t + '.xlsx';
      },
      // 交易状态选择框改变
      //   _watchTransStatusChange: function(key) {
      //     this.cond.transStatus = key;
      //   },
      // 日期、时间控件
      dismissStartTimeDialog: function() {
        var startTime = this.$.startTimePicker.date;
        this.set('cond.startTime', this.$.startTimePicker.dateFormat(startTime, 'l'));
      },
      showStartTimeDialog: function() {
        this.$.startTimeDailog.toggle();
      },
      dismissEndTimeDialog: function() {
        var endTime = this.$.endTimePicker.date;
        this.set('cond.endTime', this.$.endTimePicker.dateFormat(endTime, 'l'));
      },
      showEndTimeDialog: function() {
        this.$.endTimeDailog.toggle();
      },
      queryAction: function() {
        this.$.formSearch.submit();
      },
      // 发送查询交易的ajax请求
      submitForm: function() {
        this.trades = [];
      },
      // ajax请求响应处理
      handleSearchResponse: function(e) {
        var response = e.detail;
        if (!response.respCode || response.respCode !== '000000') {
          Util.toast(response.respMsg || '系统错误', 3000);
          return;
        }
        if (!response.rec || response.rec.length === 0) {
          Util.toast('没有找到符合条件的数据', 3000);
          return;
        }

        this.trades = response.rec.slice(0);
        this.set('cond.total', response.total);
        this.set('cond.page', response.page);
      },
      chanFilter: function(chanCode) {
        var map = {
          'ALP': '支付宝',
          'WXP': '微信',
          'CFCA': '中金'
        };
        return map[chanCode];
      },
      busicdFilter: function(busicd) {
        return TRANS_TYPE_MAP[busicd] || busicd;
      },
      _currencyFilter: function(money) {
        return (money / 100).toFixed(2);
      },
      transStatusFilter: function(status) {
        var map = {
          '10': '处理中',
          '20': '失败',
          '30': '成功',
          '40': '已关闭'
        };
        return map[status];
      },
      addOneFilter: function(index) {
        return index + 1;
      },
      // 应答码着色
      getRespCodeColor: function(value) {
        if (value === '00') {
          return 'green';
        }
        if (value === '96') {
          return 'red';
        }
        return 'blue';
      },
    });
  </script>
</dom-module>

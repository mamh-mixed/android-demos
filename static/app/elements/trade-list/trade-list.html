<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="trade-list">
  <style>
    :host {
      display: block;
    }

    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .condition {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .condition > paper-input,
    .condition > x-select {
      min-width: 170px;
      margin-right: 20px;
    }

    .condition > .buttons {
      min-width: 170px;
    }

    .condition > .buttons > paper-button {
      margin: 10px 0px 0px;
    }

    paper-button.colorful {
      background: var(--dark-primary-color);
      color: var(--text-primary-color);
    }

    .loading-more-wrapper {
      text-align: center;
    }

    table {
      width: 100%;
      border-spacing: 0;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    table td {
      text-align: center;
    }

    tr > th,
    tr > td {
      padding: 8px;
    }

    table > thead {}

    thead > tr {}

    thead > tr > th {
      line-height: 1.42857143;
      border-bottom: 1px solid #ddd;
    }

    table > tbody {
      min-height: 700px;
    }

    tbody>tr:hover {
      background-color: #f5f5f5;
    }

    table tr th:nth-last-of-type(2),
    table tr td:nth-last-of-type(2) {
      text-align: right;
    }
  </style>
  <template>
    <iron-ajax id="queryAjax" method="POST" url="/master/trade/query" handle-as="json" debounce-duration="1000" on-response="handleQueryResponse"></iron-ajax>
    <div class="condition">
      <paper-input label="* 交易时间从" on-tap="showStartTimeDialog" value="{{cond.startTime::input}}}"></paper-input>
      <paper-dialog id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
        <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <paper-input label="* 交易时间到" on-tap="showEndTimeDialog" value="{{cond.endTime::input}}}"></paper-input>
      <paper-dialog id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
        <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <x-select items="[[busicds]]" selected-item="{{busicd}}" label="交易类型"></x-select>
      <paper-input label="订单号" value="{{cond.orderNum::input}}"></paper-input>
      <paper-input label="关联订单号" value="{{cond.origOrderNum::input}}"></paper-input>
      <paper-input label="商户代码" value="{{cond.merId::input}}"></paper-input>
      <div class="buttons">
        <paper-button class="colorful" raised on-tap="handleQueryTapped">查询</paper-button>
        <paper-button class="colorful" raised>
          <a style="display:block; width:100%; height:100%; text-decoration:none" href="{{reportUri}}">下载报表</a>
        </paper-button>
      </div>
    </div>

    <div class="list">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>订单号</th>
            <th>交易状态</th>
            <th>渠道</th>
            <th>机构代码</th>
            <th>交易类型</th>
            <th>交易时间</th>
            <th>交易金额</th>
            <th>应答码</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{trades}}">
            <tr>
              <td>
                <span>{{addOneFilter(index)}}</span>
              </td>
              <td>
                <span>{{item.orderNum}}</span>
              </td>
              <td>
                <span>{{transStatusFilter(item.transStatus)}}</span>
              </td>
              <td>
                <span>{{chanFilter(item.chanCode)}}</span>
              </td>
              <td>{{item.inscd}}</span>
              </td>
              <td>
                <span>{{busicdFilter(item.busicd)}}</span>
              </td>
              <td>
                <span>{{item.transTime}}</span>
              </td>
              <td>
                <span>{{item.transAmt}}</span>
              </td>
              <td>
                <span>{{item.respcd}}</span>
              </td>
            </tr>
          </template>
        </tbody>

      </table>
      <div class="loading-more-wrapper">
        <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="generateAjaxRequest"></x-pagination>
      </div>
    </div>
  </template>
  <script>
    (function() {
      var TRANS_TYPE_MAP = {
        'PURC': '下单支付',
        'PAUT': '预下单',
        'VOID': '撤销',
        'REFD': '退款',
        'VERI': '卡券核销',
        'purc': '下单支付',
        'paut': '预下单',
        'void': '撤销',
        'refd': '退款',
        'veri': '卡券核销',
        'QYFK': '企业付款',
        'JSZF': '公众号支付'
      };

      Polymer({
        is: 'trade-list',

        properties: {
          dataRoute: {
            type: String,
            value: 'trade.list',
            notify: true
          },
          trades: {
            type: Array,
            value: []
          },
          busicd: {
            type: Object
          },
          busicds: {
            type: Array,
            value: (function() {
              var busicds = [];
              for (var k in TRANS_TYPE_MAP) {
                busicds.push({
                  key: k,
                  value: TRANS_TYPE_MAP[k]
                });
              }
              return busicds;
            })()
          }
        },
        ready: function() {
          this.cond = {
            startTime: new Date().format('yyyy-MM-dd'),
            endTime: new Date().format('yyyy-MM-dd'),
            total: 0,
            page: 1,
            size: 20
          };
          this.busicd = {};
          this.trades = [];
        },
        observers: [
          '_watchBusicdChange(busicd.key)',
          '_watchCondChange(cond.*)'
        ],
        _watchBusicdChange: function(key) {
          this.cond.busicd = key;
        },
        _watchCondChange: function() {
          var t = new Date().format('yyyyMMdd-hhmmss');
          this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=报表_' + t + '.xlsx';
        },
        // 日期、时间控件
        dismissStartTimeDialog: function() {
          var startTime = this.$.startTimePicker.date;
          this.set('cond.startTime', this.$.startTimePicker.dateFormat(startTime, 'l'));
        },
        showStartTimeDialog: function() {
          this.$.startTimeDailog.toggle();
        },
        dismissEndTimeDialog: function() {
          var endTime = this.$.endTimePicker.date;
          this.set('cond.endTime', this.$.endTimePicker.dateFormat(endTime, 'l'));
        },
        showEndTimeDialog: function() {
          this.$.endTimeDailog.toggle();
        },
        // 发送查询交易的ajax请求
        handleQueryTapped: function() {
          this.set('cond.page', 1);
          this.generateAjaxRequest();
        },
        generateAjaxRequest: function() {
          this.trades = [];
          this.$.queryAjax.body = JSON.stringify(this.cond);
          this.$.queryAjax.generateRequest();
        },
        // ajax请求响应处理
        handleQueryResponse: function(e) {
          var response = e.detail.response;
          if (response.respCode !== '000000') {
            Util.toast(response.respMsg, 3000);
          }

          if (response.rec) {
            this.trades = response.rec.slice(0);
          }
          this.set('cond.total', response.total);
          this.set('cond.page', response.page);
        },
        chanFilter: function(chanCode) {
          var map = {
            'ALP': '支付宝',
            'WXP': '微信'
          };
          return map[chanCode];
        },
        busicdFilter: function(busicd) {
          return TRANS_TYPE_MAP[busicd] || busicd;
        },
        transStatusFilter: function(status) {
          var map = {
            '10': '处理中',
            '20': '失败',
            '30': '成功',
            '40': '已关闭'
          };
          return map[status];
        },
        addOneFilter: function(index) {
          return index + 1;
        }
      });
    })();
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../x-select/x-select.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../trade-view/trade-view.html">
<link rel="import" href="../trade-message/trade-message.html">
<dom-module id="trade-list">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <!-- <paper-button raised on-tap="showLoginDialogTap">showLoginDialog</paper-button> -->
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <paper-input name="startTime" label="* 交易时间从" on-tap="showStartTimeDialog" value="{{cond.startTime::input}}}"></paper-input>
        <paper-dialog id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
          <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <paper-input name="endTime" label="* 交易时间到" on-tap="showEndTimeDialog" value="{{cond.endTime::input}}}"></paper-input>
        <paper-dialog id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
          <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <x-select items="[[agents]]" name="agent" selected-item="{{agent}}" label="代理" disabled="{{agentDisabled}}" id="agentCode"></x-select>
        <paper-input id="groupCode" label="商户代码" name="groupCode" value="{{cond.groupCode::input}}"></paper-input>
        <paper-input id="merId" label="门户代码" name="merId" value="{{cond.merId::input}}"></paper-input>
        <paper-input label="订单号" name="orderNum" value="{{cond.orderNum::input}}"></paper-input>
        <paper-input label="关联订单号" name="origOrderNum" value="{{cond.origOrderNum::input}}"></paper-input>
        <paper-input label="应答码" name="respcd" value="{{cond.respcd::input}}"></paper-input>
        <x-select items="[[busicds]]" name="busicd" selected-item="{{busicd}}" label="交易类型"></x-select>
        <x-select items="[[transStatusMap]]" name="transStatus" selected-item="{{transStatus}}" label="交易状态"></x-select>

        <paper-button class="colorful" raised on-tap="queryAction">查询</paper-button>
        <div class="paper-button-1">
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href="{{reportUri}}">下载报表</a>
        </div>
      </div>
      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th">序号</div>
            <div class="th">应答码</div>
            <div class="th left">门店代码</div>
            <div class="th left">门店名称</div>
            <div class="th left">订单号</div>
            <div class="th left">交易类型</div>
            <div class="th right">金额(元)</div>
            <div class="th left">渠道</div>
            <div class="th left">交易状态</div>
            <div class="th left">退款</div>
            <div class="th">交易时间</div>
            <!-- <div class="th" id="test" align="center">更新时间</div> -->
            <div class="th">报文</div>
          </div>
        </div>
        <div class='tbody'>
          <template is="dom-repeat" items="{{trades}}">
            <div class="tr">
              <div class="td center">{{addOneFilter(index)}}</div>
              <div class="td" align="center" class$="{{getRespCodeColor(item.respcd)}}">
                <div style="display: inline-block;position: relative;">
                  <span class="abbr">{{item.respcd}}</span>
                  <paper-tooltip position="right">{{item.errorDetail}}</paper-tooltip>
                </div>
              </div>
              <div class="td">{{item.merId}}</div>
              <div class="td">{{item.merName}}</div>
              <div class="td left">
                <a on-tap="showTradeViewHandler">{{item.orderNum}}</a>
              </div>
              <div class="td left">{{busicdFilter(item.busicd)}}</div>
              <div class="td right">{{_currencyFilter(item.transAmt)}}</div>
              <div class="td">{{chanFilter(item.chanCode)}}</div>
              <div class="td">
                <template is="dom-if" if="{{isCloseTrans(item.transStatus)}}">
                  <div style="display: inline-block;position: relative;">
                    <span class="abbr" data-title$="{{_computeTransCloseReason(item.refundStatus)}}">{{transStatusFilter(item.transStatus)}}</span>
                    <paper-tooltip position="right">{{_computeTransCloseReason(item.refundStatus)}}</paper-tooltip>
                  </div>
                </template>
                <template is="dom-if" if="{{!isCloseTrans(item.transStatus)}}">
                  <span>{{transStatusFilter(item.transStatus)}}</span>
                </template>
              </div>
              <div class="td">{{refundStatusFilter(item.refundStatus)}}</div>
              <div class="td center">{{item.transTime}}</div>
              <!-- <div class="td" align="center">{{item.updateTime}}</div> -->
              <div class="td center">
                <iron-icon icon="receipt" on-tap="showTradeMessageEvent" hidden$="{{!isDatagramAccessible}}"></iron-icon>
              </div>
            </div>
          </template>
        </div>
        <div class="wedge">
          <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
        </div>
      </div>
    </form>
    <trade-view id="tradeView" item="{{transItem}}" user="{{user}}"></trade-view>
    <trade-message id="tradeMessage" item="{{transItem}}" user="{{user}}"></trade-message>
    <x-ajax id="queryAgentAjax" auto params='{"page":"1", "size":"1000"}' method="GET" url="/master/agent/find" handle-as="json" debounce-duration="1000" on-response="handleQueryAgentsResponse"></x-ajax>
    <iron-localstorage name="USERTYPE" value="{{userType}}" on-iron-localstorage-load="handleUserType" on-iron-localstorage-load-empty="handleNoUserType"></iron-localstorage>
  </template>
  <script>
    var TRANS_TYPE_MAP = {
      'PURC': '下单支付',
      'PAUT': '预下单',
      'VOID': '撤销',
      'REFD': '退款',
      'VERI': '卡券核销',
      'CANC': '取消',
      //   'purc': '下单支付',
      //   'paut': '预下单',
      //   'void': '撤销',
      //   'refd': '退款',
      //   'veri': '卡券核销',
      //   'canc': '取消',
      'QYZF': '企业付款',
      'JSZF': '公众号支付'
    };

    Polymer({
      is: 'trade-list',

      properties: {
        isDatagramAccessible: {
          type: Boolean,
          value: false
        },
        dataRoute: {
          type: String,
          value: 'trade.list',
          notify: true
        },
        trades: {
          type: Array,
          value: []
        },
        busicd: {
          type: Object
        },
        busicds: {
          type: Array,
          value: (function() {
            var busicds = [],
              map = {};
            for (var k in TRANS_TYPE_MAP) {
              if (!map[k.toUpperCase()]) {
                map[k.toUpperCase()] = TRANS_TYPE_MAP[k];
              }
            }
            Object.keys(map).forEach(function(v) {
              busicds.push({
                key: v,
                value: (v + ' ' + map[v])
              });
            });
            return busicds;
          })()
        },
        transStatus: {
          type: Object
        },
        transStatusMap: {
          type: Array,
          value: [{
            key: '10',
            value: '处理中'
          }, {
            key: '20',
            value: '失败'
          }, {
            key: '30',
            value: '成功'
          }, {
            key: '40',
            value: '已关闭'
          }, ]
        },
        user: Object,
      },
      ready: function() {
        this.cond = {
          startTime: new Date().format('yyyy-MM-dd'),
          endTime: new Date().format('yyyy-MM-dd'),
          total: 0,
          page: 1,
          size: 20
        };
        this.busicd = {};
        this.trades = [];
        this.transStatus = {};
        this.refundStatusMap = {
          0: '无退款',
          1: '已退款',
          2: '部分退款',
          3: '商户发起关闭',
          4: '交易超时系统关闭'
        };

      },
      observers: [
        '_watchAgentChange(agent.key)',
        '_watchBusicdChange(busicd.key)',
        '_watchCondChange(cond.*)',
        '_watchTransStatusChange(transStatus.key)',
        '_watchUserChanged(user.*)',
      ],
      _watchAgentChange: function(key) {
        this.cond.agentCode = key;
      },
      _watchBusicdChange: function(key) {
        this.cond.busicd = key;
      },
      _watchCondChange: function(newValue) {
        if (newValue.path !== 'cond.page') {
          this.set('cond.page', 1);
        }

        var filename = "Trans_" + this.cond.startTime + "_" + this.cond.endTime + ".xlsx";
        filename = filename.replace(/-/g, '');
        this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=' + filename;
      },
      // 交易状态选择框改变
      _watchTransStatusChange: function(key) {
        this.cond.transStatus = key;
      },
      _watchUserChanged: function(value) {
        if (value) {
          var user = value.base;
          if (user.userType === 'agent') {
            this.set('cond.agentCode', user.agentCode);
            this.$.agentCode.setAttribute('disabled', true);
          } else if (user.userType === 'group') {
            this.set('cond.groupCode', user.groupCode);
            this.$.agentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
          } else if (user.userType === 'merchant') {
            this.set('cond.merId', user.merId);
            this.$.agentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
            this.$.merId.setAttribute('disabled', true);
          } else {
            this.$.agentCode.removeAttribute('disabled');
            this.$.groupCode.removeAttribute('disabled');
            this.$.merId.removeAttribute('disabled');
          }
        }
      },
      handleUserType: function() {
        if (this.userType === 'admin') {
          this.isDatagramAccessible = true;
          return;
        }
        this.isDatagramAccessible = false;
      },
      handleNoUserType: function() {
        this.isDatagramAccessible = false;
      },
      // 日期、时间控件
      dismissStartTimeDialog: function() {
        var startTime = this.$.startTimePicker.date;
        this.set('cond.startTime', this.$.startTimePicker.dateFormat(startTime, 'l'));
      },
      showStartTimeDialog: function() {
        this.$.startTimeDailog.toggle();
      },
      dismissEndTimeDialog: function() {
        var endTime = this.$.endTimePicker.date;
        this.set('cond.endTime', this.$.endTimePicker.dateFormat(endTime, 'l'));
      },
      showEndTimeDialog: function() {
        this.$.endTimeDailog.toggle();
      },
      queryAction: function() {
        this.$.agentCode.removeAttribute('disabled');
        this.$.groupCode.removeAttribute('disabled');
        this.$.merId.removeAttribute('disabled');
        this.$.formSearch.submit();
      },
      // 发送查询交易的ajax请求
      submitForm: function() {
        this.trades = [];
        if (this.user) {
          if (this.user.userType === 'agent') {
            this.$.agentCode.value = this.user.agentCode;
            this.$.agentCode.setAttribute('disabled', true);
          } else if (this.user.userType === 'group') {
            this.$.groupCode.value = this.user.groupCode;
            this.$.agentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
          } else if (this.user.userType === 'merchant') {
            this.$.merId.value = this.user.merId;
            this.$.agentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
            this.$.merId.setAttribute('disabled', true);
          } else {
            this.$.agentCode.removeAttribute('disabled');
            this.$.groupCode.removeAttribute('disabled');
            this.$.merId.removeAttribute('disabled');
          }
        }
      },
      // 代理列表响应
      handleQueryAgentsResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('加载代理列表失败', 3000);
          return;
        }

        var pagination = response.data;
        if (pagination.count <= 0) {
          Util.toast('没有代理数据', 2000);
          return;
        }

        var agents = response.data.data.slice(0);
        this.set('agents', agents.map(function(item) {
          return {
            key: item.agentCode,
            value: item.agentName
          };
        }));
      },
      // ajax请求响应处理
      handleSearchResponse: function(e) {
        var response = e.detail;
        if (!response.respCode || response.respCode !== '000000') {
          Util.toast(response.respMsg || '系统错误', 3000);
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }
        if (!response.rec || response.rec.length === 0) {
          Util.toast('没有找到符合条件的数据', 3000);
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }

        this.trades = response.rec.slice(0);
        this.set('cond.total', response.total);
        this.set('cond.page', response.page);
      },
      chanFilter: function(chanCode) {
        var map = {
          'ALP': '支付宝',
          'WXP': '微信'
        };
        return map[chanCode];
      },
      busicdFilter: function(busicd) {
        return TRANS_TYPE_MAP[busicd] || busicd;
      },
      _currencyFilter: function(money) {
        return (money / 100).toFixed(2);
      },
      transStatusFilter: function(status) {
        var map = {
          '10': '处理中',
          '20': '失败',
          '30': '成功',
          '40': '已关闭'
        };
        return map[status];
      },
      addOneFilter: function(index) {
        return index + 1;
      },
      // 应答码着色
      getRespCodeColor: function(value) {
        if (value === '00') {
          return 'green';
        }
        if (value === '96') {
          return 'red';
        }
        return 'blue';
      },
      showTradeViewHandler: function(e) {
        this.transItem = e.model.item;
        this.$.tradeView.open();
      },
      refundStatusFilter: function(status) {
        var map = {
          1: '已退款',
          2: '部分退款'
        };
        return map[status];
      },
      isCloseTrans: function(status) {
        return status === '40';
      },
      _computeTransCloseReason: function(status) {
        return this.refundStatusMap[status];
      },
      isShowTooltip: function(value) {
        if (value === '00') {
          return true;
        } else {
          return false;
        }
      },
      showTradeMessageEvent: function(e) {
        this.transItem = e.model.item;
        this.$.tradeMessage.open();
      },
      showLoginDialogTap: function() {
        Util.showLoginDialog();
      }
    });
  </script>
</dom-module>

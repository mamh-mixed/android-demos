<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<dom-module id="trade-list">
  <template>
    <form is="iron-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <paper-input name="startTime" label="* 交易时间从" on-tap="showStartTimeDialog" value="{{cond.startTime::input}}}"></paper-input>
        <paper-dialog id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
          <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <paper-input name="endTime" label="* 交易时间到" on-tap="showEndTimeDialog" value="{{cond.endTime::input}}}"></paper-input>
        <paper-dialog id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
          <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>OK</paper-button>
          </div>
        </paper-dialog>

        <paper-input label="代理代码" name="agentCode" value="{{cond.agentCode::input}}"></paper-input>
        <paper-input label="集团代码" name="groupCode" value="{{cond.groupCode::input}}"></paper-input>
        <paper-input label="商户代码" name="merId" value="{{cond.merId::input}}"></paper-input>
        <paper-input label="订单号" name="orderNum" value="{{cond.orderNum::input}}"></paper-input>
        <paper-input label="关联订单号" name="origOrderNum" value="{{cond.origOrderNum::input}}"></paper-input>
        <paper-input label="应答码" name="respcd" value="{{cond.respcd::input}}"></paper-input>
        <x-select items="[[busicds]]" name="busicd" selected-item="{{busicd}}" label="交易类型"></x-select>
        <x-select items="[[transStatusMap]]" name="transStatus" selected-item="{{transStatus}}" label="交易状态"></x-select>

        <paper-button class="colorful" raised on-tap="queryAction">查询</paper-button>
        <paper-button class="colorful" raised>
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href="{{reportUri}}">下载报表</a>
        </paper-button>
      </div>
      <table class="data-grid">
        <thead>
          <tr>
            <th>序号</th>
            <th>应答码</th>
            <th>订单号</th>
            <th>金额(元)</th>
            <th>交易时间</th>
            <th>状态</th>
            <th>商户号</th>
            <th>商户名称</th>
            <!-- <th>终端号</th> -->
            <th>交易类型</th>
            <th>渠道</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{trades}}">
            <tr>
              <td align="right">{{addOneFilter(index)}}</td>
              <td align="center" class$="{{getRespCodeColor(item.respcd)}}">{{item.respcd}}</td>
              <td>{{item.orderNum}}</td>
              <td align="right">{{_currencyFilter(item.transAmt)}}</td>
              <td align="center">{{item.transTime}}</td>
              <td>{{transStatusFilter(item.transStatus)}}</td>
              <td>{{item.merId}}</td>
              <td>{{item.merName}}</td>
              <!-- <td>{{item.terminalid}}</td> -->
              <td>{{busicdFilter(item.busicd)}}</td>
              <td>{{chanFilter(item.chanCode)}}</td>
            </tr>
          </template>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="255" align="right">
                    <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
                </td>
            </tr>
        </tfoot>
      </table>
    </form>
  </template>
  <script>
    var TRANS_TYPE_MAP = {
      'PURC': '下单支付',
      'PAUT': '预下单',
      'VOID': '撤销',
      'REFD': '退款',
      'VERI': '卡券核销',
      'CANC': '取消',
      'purc': '下单支付',
      'paut': '预下单',
      'void': '撤销',
      'refd': '退款',
      'veri': '卡券核销',
      'canc': '取消',
      'QYFK': '企业付款',
      'JSZF': '公众号支付'
    };

    Polymer({
      is: 'trade-list',

      properties: {
        dataRoute: {
          type: String,
          value: 'trade.list',
          notify: true
        },
        trades: {
          type: Array,
          value: []
        },
        busicd: {
          type: Object
        },
        busicds: {
          type: Array,
          value: (function() {
            var busicds = [],
              map = {};
            for (var k in TRANS_TYPE_MAP) {
              if (!map[k.toUpperCase()]) {
                map[k.toUpperCase()] = TRANS_TYPE_MAP[k];
              }
            }
            Object.keys(map).forEach(function(v) {
              busicds.push({
                key: v,
                value: map[v]
              });
            });
            return busicds;
          })()
        },
        transStatus: {
          type: Object
        },
        transStatusMap: {
          type: Array,
          value: [{
            key: '10',
            value: '处理中'
          }, {
            key: '20',
            value: '失败'
          }, {
            key: '30',
            value: '成功'
          }, {
            key: '40',
            value: '已关闭'
          }, ]
        }
      },
      ready: function() {
        this.cond = {
          startTime: new Date().format('yyyy-MM-dd'),
          endTime: new Date().format('yyyy-MM-dd'),
          total: 0,
          page: 1,
          size: 20
        };
        this.busicd = {};
        this.trades = [];
        this.transStatus = {};
      },
      observers: [
        '_watchBusicdChange(busicd.key)',
        '_watchCondChange(cond.*)',
        '_watchTransStatusChange(transStatus.key)'
      ],
      _watchBusicdChange: function(key) {
        this.cond.busicd = key;
      },
      _watchCondChange: function(newValue) {
        if (newValue.path !== 'cond.page') {
          this.set('cond.page', 1);
        }
        var t = new Date().format('yyyyMMdd-hhmmss');
        this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=报表_' + t + '.xlsx';
      },
      // 交易状态选择框改变
      _watchTransStatusChange: function(key) {
        this.cond.transStatus = key;
      },
      // 日期、时间控件
      dismissStartTimeDialog: function() {
        var startTime = this.$.startTimePicker.date;
        this.set('cond.startTime', this.$.startTimePicker.dateFormat(startTime, 'l'));
      },
      showStartTimeDialog: function() {
        this.$.startTimeDailog.toggle();
      },
      dismissEndTimeDialog: function() {
        var endTime = this.$.endTimePicker.date;
        this.set('cond.endTime', this.$.endTimePicker.dateFormat(endTime, 'l'));
      },
      showEndTimeDialog: function() {
        this.$.endTimeDailog.toggle();
      },
      queryAction: function() {
        this.$.formSearch.submit();
      },
      // 发送查询交易的ajax请求
      submitForm: function() {
        this.trades = [];
        // this.set('cond.total', 0);
        // console.log(e.detail);
      },
      // ajax请求响应处理
      handleSearchResponse: function(e) {
        var response = e.detail;
        if (!response.respCode || response.respCode !== '000000') {
          Util.toast(response.respMsg || '系统错误', 3000);
          return;
        }
        if (!response.rec || response.rec.length === 0) {
          Util.toast('没有找到符合条件的数据', 3000);
          return;
        }

        this.trades = response.rec.slice(0);
        this.set('cond.total', response.total);
        this.set('cond.page', response.page);
      },
      chanFilter: function(chanCode) {
        var map = {
          'ALP': '支付宝',
          'WXP': '微信'
        };
        return map[chanCode];
      },
      busicdFilter: function(busicd) {
        return TRANS_TYPE_MAP[busicd] || busicd;
      },
      _currencyFilter: function(money) {
        return (money / 100).toFixed(2);
      },
      transStatusFilter: function(status) {
        var map = {
          '10': '处理中',
          '20': '失败',
          '30': '成功',
          '40': '已关闭'
        };
        return map[status];
      },
      addOneFilter: function(index) {
        return index + 1;
      },
      // 应答码着色
      getRespCodeColor: function(value) {
        if (value === '00') {
          return 'green';
        }
        if (value === '96') {
          return 'red';
        }
        return 'blue';
      },
    });

  </script>
</dom-module>

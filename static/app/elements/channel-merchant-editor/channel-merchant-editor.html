<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">

<link rel="import" href="../x-select/x-select.html">

<dom-module id="channel-merchant-editor">
  <style>
    :host {
      display: block;
      --paper-dialog-scrollable: {
        min-width: 600px;
        min-height: 500px;
        max-height: 500px;
      }
    }

    paper-dialog {
      background-color: #ffffff;
    }

    x-select {
      width: 100%;
    }

    paper-input {
      width: 100%;
    }

    paper-textarea,
    paper-input,
    .validate-container {
      position: relative;
    }

    paper-textarea[required]::after,
    paper-input[required]::after,
    .validate-container[required]::after {
      content: "*";
      color: #F00;
      display: block;
      position: absolute;
      left: -10px;
      top: 50%;
    }

    .row {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }

    .row paper-input,
    .row label {
      @apply(--layout-flex-6);
      margin-right: 35px;
      margin-left: -35px;
    }
  </style>
  <template>
    <x-ajax id="saveAjax" method="POST" url="/master/channelMerchant/save" handle-as="json" debounce-duration="1000" on-response="handleSaveChannelMerchantResponse"></x-ajax>
    <x-ajax id="findChanMerAjax" method="GET" url="/master/channelMerchant/find" handle-as="json" debounce-duration="1000" on-response="handleFindChanMerResponse"></x-ajax>
    <paper-dialog id="dialogAdd">
      <h2 id="header"></h2>
      <paper-dialog-scrollable>
        <x-select id="chanCode" items="[[channels]]" selected-item="{{channel}}" label="渠道代码" class="validate-container" required style="width:100%;" disabled="[[chanCodeDisabled]]"></x-select>
        <!-- <paper-input label="机构代码" value="{{chanMer.agentCode::input}}"></paper-input>
          <paper-input label="终端代码" value="{{chanMer.terminalId::input}}"></paper-input> -->
        <div id="alp">
          <paper-input id="achanMerId" label="Partner ID" value="{{alp.chanMerId::input}}" required error-message="必填项"></paper-input>
          <paper-input id="achanMerName" label="商户名称" value="{{alp.chanMerName::input}}" error-message="必填项"></paper-input>
          <paper-input id="asignKey" label="MD5 KEY" value="{{alp.signCert::input}}" required error-message="必填项"></paper-input>
          <x-select id="aagentCode" items="[[aagentCodes]]" selected-item="{{aagentCode}}" class="validate-container" label="代理" required error-message="必填项"></x-select>
        </div>
        <div id="wxp">
          <paper-input id="wchanMerId" label="微信商户号" value="{{weixin.chanMerId::input}}" required error-message="必填项"></paper-input>
          <paper-input id="wchanMerName" label="商户名称" value="{{weixin.chanMerName::input}}"></paper-input>
          <paper-radio-button id="wisAgentMode" checked$="{{weixin.isAgentMode}}" on-change="handleIsAgentChangeEvent" style="margin-top:20px;"> 是否代理商模式</paper-radio-button>
          <x-select id="wbigChanMerId" items="[[wbigchanMerIds]]" selected-item="{{wbigchanMerId}}" class="validate-container" label="大商户号" required error-message="必填项" disabled="[[wbigchanMerIdDisabled]]"></x-select>
          <paper-input id="wxpAppId" label="微信支付App Id" value="{{weixin.wxpAppId::input}}" error-message="必填项"></paper-input>
          <paper-input id="wsignCert" label="签名密钥" value="{{weixin.signCert::input}}" error-message="必填项"></paper-input>
          <div class="row">
            <paper-input id="httpCert" label="HTTP 证书" type="file" on-change="handleWeixinHttpCertFile" style="margin-left:0px;"></paper-input>
            <label id="httpCertL" style="margin-top:20px;">请选择.pem文件的HTTP证书</label>
          </div>
          <paper-textarea id="httpCertTArea" label="HTTP 证书" value="{{weixin.httpCert::input}}" error-message="必填项"></paper-textarea>
          <div class="row">
            <paper-input id="httpKey" label="HTTP 密钥" type="file" on-change="handleWeixinHttpKeyFile" style="margin-left:0px;"></paper-input>
            <label id="httpKeyL" style="margin-top:20px;">请选择.pem文件的HTTP密钥</label>
          </div>
          <paper-textarea id="httpKeyTArea" label="HTTP 密钥" value="{{weixin.httpKey::input}}" error-message="必填项"></paper-textarea>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>取消</paper-button>
        <paper-button on-tap="handleSaveTapped">保存</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'channel-merchant-editor',
        properties: {
          pageType: String,
          chanMer: {
            type: Object
          },
          channels: {
            type: Array,
            value: [{
              key: 'ALP',
              value: 'ALP 支付宝'
            }, {
              key: 'WXP',
              value: 'WXP 微信'
            }]
          },
          bigMerchant: {
            type: Object
          },
          // 微信大商户集合，目前是2个
          wbigchanMerIds: {
            type: Array,
            value: [{
              key: '1236593202',
              value: '讯联 1236593202'
            }]
          },
          wbigchanMerId: {
            type: Object,
            observer: '_wbigchanMerIdChanged'
          },
          // 支付宝代理
          aagentCodes: {
            type: Array,
            value: [{
              key: '12010128a1',
              value: '讯联 12010128a1'
            }, {
              key: '11719712a1',
              value: '天奕通 11719712a1'
            }]
          },
          aagentCode: {
            type: Object,
            observer: '_aagentCodeChanged'
          },
        },
        observers: [
          '_channelChange(channel)',
          '_wisAgentModeChanged(weixin.isAgentMode)'
        ],
        _wisAgentModeChanged: function(value) {
          if (value) {
            this.$.wbigChanMerId.setAttribute('required', true);
            this.wbigchanMerIdDisabled = false;
            this.$.wxpAppId.removeAttribute('required');
            this.$.wsignCert.removeAttribute('required');
            this.$.httpCertTArea.removeAttribute('required');
            this.$.httpKeyTArea.removeAttribute('required');
            this.$.wxpAppId.validate();
            this.$.wsignCert.validate();
          } else {
            this.$.wbigChanMerId.removeAttribute('required');
            this.wbigchanMerIdDisabled = true;
            this.$.wxpAppId.setAttribute('required', true);
            this.$.wsignCert.setAttribute('required', true);
            this.$.httpCertTArea.setAttribute('required', true);
            this.$.httpKeyTArea.setAttribute('required', true);
          }
        },
        _channelChange: function(channel) {
          if (channel) {
            if (channel.key === 'ALP') {
              this.$.alp.hidden = false;
              this.$.wxp.hidden = true;
            } else if (channel.key === 'WXP') {
              this.$.alp.hidden = true;
              this.$.wxp.hidden = false;
            }
          }
        },
        // 选择大商户号
        _wbigchanMerIdChanged: function(value) {
          if (this.bigMerchantMap && value && value.key) {
            this.set('bigMerchant', this.bigMerchantMap[value.key]);
            if (!this.bigMerchant) {
              this.$.findChanMerAjax.params = {
                page: 1,
                chanMerId: value.key
              };
              this.$.findChanMerAjax.generateRequest();
            }
          }

        },
        // 支付宝选择代理
        _aagentCodeChanged: function(value) {
          if (value) {
            this.set('alp.agentCode', value.key);
          }
        },
        open: function() {
          this.$.dialogAdd.open();
          if (this.pageType === 'create') {
            this.$.header.textContent = '创建渠道商户';
            this.channel = {
              key: 'ALP',
              value: 'ALP 支付宝'
            };
            this.alp = {};
            this.weixin = {
              chanCode: 'WXP',
              isAgentMode: true,
            };
            this.chanCodeDisabled = false;
            this.$.achanMerId.disabled = false;
            this.$.wchanMerId.disabled = false;
            // 默认选择我们的代理
            this.wbigchanMerId = {
              key: '1236593202',
              value: '讯联 1236593202'
            };
            // 存放微信大商户信息，现在有2个
            this.bigMerchantMap = {};
            // 微信大商户
            this.$.findChanMerAjax.params = {
              page: 1,
              chanMerId: this.wbigchanMerId.key
            };
            this.$.findChanMerAjax.generateRequest();
            // 默认支付宝代理号为12010128a1
            this.aagentCode = {
              key: '12010128a1',
              value: '讯联 12010128a1',
            };
          } else {
            this.$.header.textContent = '编辑渠道商户';
            var map = {
              'ALP': 'ALP 支付宝',
              'WXP': 'WXP 微信'
            };
            this.channel = {
              key: this.chanMer.chanCode,
              value: map[this.chanMer.chanCode]
            };
            // this.$.chanCode.childNodes[1].children[1].disab
            this.chanCodeDisabled = true;
            this.alp = this.chanMer;
            this.weixin = this.chanMer;
            this.$.achanMerId.disabled = true;
            this.$.wchanMerId.disabled = true;
            var aagentCodeMap = {
              '12010128a1': '讯联 12010128a1',
              '11719712a1': '天奕通 11719712a1'
            };
            if (this.alp.agentCode) {
              this.aagentCode = {
                key: this.alp.agentCode,
                value: aagentCodeMap[this.alp.agentCode],
              };
            }
            var wbigchanMerIdMap = {
              '1236593202': '讯联 1236593202'
            };
            // 存放微信大商户信息，现在有2个
            this.bigMerchantMap = {};
            if (this.weixin.isAgentMode) {
              this.set('bigMerchant', this.weixin.agentMer);
              this.bigMerchantMap[this.weixin.agentMer.chanMerId] = this.weixin.agentMer;
              this.wbigchanMerId = {
                key: this.weixin.agentMer.chanMerId,
                value: wbigchanMerIdMap[this.weixin.agentMer.chanMerId],
              };
            }
            this.oldAlpSignCert = this.alp.signCert;
            this.oldWxpSignCert = this.weixin.signCert;
          }
        },
        // 查询渠道商户的响应事件，这里是查找大商户
        handleFindChanMerResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            return;
          }

          var pagination = response.data;
          if (!pagination.data || pagination.data.length === 0) {
            return;
          }
          this.set('bigMerchant', pagination.data[0]);
        },
        // 支付宝必填项是否为空
        isALPConfigEmpty: function() {
          if (this.$.achanMerId.validate() && this.$.asignKey.validate() && this.aagentCode) {
            return false;
          }
          return true;
        },
        // 微信必填项是否为空
        isWXPConfigEmpty: function() {
          if (this.weixin.isAgentMode) {
            if (this.$.wchanMerId.validate() && this.wbigchanMerId && this.wbigchanMerId.key) {
              return false;
            }
          } else {
            if (this.$.wchanMerId.validate() && this.$.wxpAppId.validate() && this.$.wsignCert.validate() && this.$.httpCertTArea.validate() && this.$.httpKeyTArea.validate()) {
              return false;
            }
          }
          return true;
        },
        // 点击保存事件
        handleSaveTapped: function() {
          if (this.channel) {
            if (this.channel.key === 'ALP' && !this.isALPConfigEmpty()) {
              if (this.alp.signCert && this.alp.signCert.length < 8) {
                Util.toast('MD5 KEY长度不能小于8位', 3000);
                return;
              }
              if (this.alp.signCert !== this.oldAlpSignCert && this.alp.signCert.indexOf('*') !== -1) {
                Util.toast('MD5 KEY不能包含 *,已恢复为原MD5 KEY', 3000);
                this.set('alp.signCert', this.oldAlpSignCert)
                return;
              }
              this.set('alp.chanCode', 'ALP');
              this.chanMer = this.alp;
            } else if (this.channel.key === 'WXP' && !this.isWXPConfigEmpty()) {
              if (this.weixin.signCert && this.weixin.signCert.length < 8) {
                Util.toast('签名密钥长度不能小于8位', 3000);
                return;
              }
              if (this.weixin.signCert !== this.oldWxpSignCert && this.weixin.signCert.indexOf('*') !== -1) {
                Util.toast('签名密钥不能包含 *,已恢复为原签名密钥', 3000);
                this.set('weixin.signCert', this.oldWxpSignCert)
                return;
              }
              this.set('weixin.chanCode', 'WXP');
              // 如果勾选了代理商模式，就直接填充上大商户的信息
              if (this.weixin.isAgentMode) {
                if (!this.bigMerchant) {
                  Util.toast(this.wbigchanMerId.key + '大商户信息为空', 3000);
                  return;
                }
                this.set('weixin.agentMer', this.bigMerchant);
              } else {
                this.set('weixin.agentMer', {});
              }
              this.chanMer = this.weixin;
            } else {
              Util.toast('必填项不能为空', 3000);
              return;
            }

          } else {
            Util.toast('请选择渠道', 3000);
            return;
          }
          this.$.saveAjax.body = JSON.stringify(this.chanMer);
          this.$.saveAjax.generateRequest();
        },
        // 保存事件响应结果
        handleSaveChannelMerchantResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          this.$.dialogAdd.close();
          Util.toast(response.message, 1000);
          this.fire('saved');
          this.set('chanMer', {});
        },
        // html5 读取证书文件内容
        handleWeixinHttpCertFile: function(e) {
          var _this = this;
          var files = e.srcElement.files;
          if (files.length) {
            var file = files[0];
            if ('application/x-x509-ca-cert' === file.type) {
              var reader = new FileReader();
              reader.onload = function() {
                if (/BEGIN CERTIFICATE/.test(this.result) === false) {
                  Util.toast('文件内容错误，请上传证书文件，该类文件以 ---BEGIN CERTIFICATE--- 开头', 3000);
                  return;
                }
                _this.set('weixin.httpCert', this.result);
              };
              reader.readAsText(file);
            } else {
              Util.toast('文件格式错误，只能上传 PEM 格式的文件', 3000);
            }
          }
        },
        handleWeixinHttpKeyFile: function(e) {
          var _this = this;
          var files = e.srcElement.files;
          if (files.length) {
            var file = files[0];
            if ('application/x-x509-ca-cert' === file.type) {
              var reader = new FileReader();
              reader.onload = function() {
                if (/BEGIN RSA PRIVATE KEY/.test(this.result) === false) {
                  Util.toast('文件内容错误，请上传密钥文件，该类文件以 -----BEGIN RSA PRIVATE KEY----- 开头', 3000);
                  return;
                }
                _this.set('weixin.httpKey', this.result);
              };
              reader.readAsText(file);
            } else {
              Util.toast('文件格式错误，只能上传 PEM 格式的文件', 3000);
            }
          }
        },
        // 是否代理商模式的改变事件
        handleIsAgentChangeEvent: function() {
          this.set('weixin.isAgentMode', this.$.wisAgentMode.checked);
        },
      });
    })();
  </script>
</dom-module>

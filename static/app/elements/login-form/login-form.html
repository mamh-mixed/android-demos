<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="login-form">
  <style>
    :host {
      display: block;
      text-align: left;
      --paper-input-container-input: {
        font-size: 16px;
      }
      ;
      /* 必须有分号，否则压缩后，无法正常渲染 */
      --paper-input-container-label: {
        font-size: 14px;
      }
      ;
      /* 必须有分号，否则压缩后，无法正常渲染 */
    }

    .logo {
      text-align: center;
    }

    .circle {
      margin: 10px auto;
      border-radius: 48px;
    }

    paper-button {
      width: 80%;
      margin-top: 30px;
      background: #ff4081;
      color: #ffffff;
    }

    .login-inner {
      width: 70%;
      margin: 0 auto;
      @apply(--layout-vertical);
      @apply(--layout-center);
      @apply(--layout-center-justified);
      height: 100%;
    }

    .login-inner > #loginForm {
      width: 100%;
    }

    #loginForm > h1 {
      font-size: 30px;
    }

    #loginForm > paper-button {
      margin: 30px 12.5%;
    }

    .row {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    .row > iron-icon {
      @apply(--layout-self-end);
      padding: 8px 0;
      margin-right: 10px;
    }

    .row > paper-input {
      @apply(--layout-self-end);
      @apply(--layout-flex);
    }

  </style>
  <template>

    <div class="logo">
      <img src="../../images/touch/ms-touch-icon-144x144-precomposed.png" alt="" class="circle">
      <div class="app-name">云收银管理平台</div>
    </div>
    <div class="login-inner">
      <form id="loginForm">
        <div class="row">
          <iron-icon icon="perm-identity"></iron-icon>
          <paper-input id="userName" label="用户名" value="{{user.userName::input}}" required error-message="必填项"></paper-input>
        </div>
        <div class="row">
          <iron-icon icon="lock-outline"></iron-icon>
          <paper-input id="pwd" label="密码" value="{{user.password::input}}" type="password" required error-message="必填项"></paper-input>
        </div>
        <paper-button raised on-tap="loginTapHandle">登录</paper-button>
        <iron-a11y-keys id="keys" keys="enter" target="[[target]]" on-keys-pressed="handleEnterKeyPresse"></iron-a11y-keys>
      </form>
    </div>
    <iron-ajax id="findSessionAjax" method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleFindSessionResponse"></iron-ajax>
    <iron-ajax id="loginAjax" method="POST" url="/master/login" handle-as="json" debounce-duration="1000" on-response="handleLoginResponse"></iron-ajax>
  </template>
  <script src="../../scripts/util.js"></script>
  <script>
    (function() {
      Polymer({
        is: 'login-form',

        properties: {
          // isRedirect 如果为TRUE，登入成功后会跳转到首页
          redirect: {
            type: Boolean,
            value: false
          },
          target: {
            type: Object,
            value: function() {
              return this.$.loginForm;
            }
          }
        },
        ready: function() {
          this.user = {};
        },
        loginTapHandle: function() {
          if (this.isloginConfigEmpty()) {
            Util.toast('用户名或密码不能为空', 3000);
            return;
          }
          var loginAjax = this.$.loginAjax;
          loginAjax.body = JSON.stringify(this.user);
          loginAjax.generateRequest();
        },
        isloginConfigEmpty: function() {
          if (this.$.userName.validate() && this.$.pwd.validate()) {
            return false;
          } else {
            return true;
          }
        },
        handleLoginResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          this.user = {
            userName: '',
            password: ''
          };

          // 事件冒泡到顶层
          this.fire('login-success', response.data);
          // this.set('sessionId', response.data.sessionId);
          // this.set('userType', response.data.userType);
          if (this.redirect) {
            // TODO 路由跳转的也可以使用事件冒泡
            document.querySelector('#appRouter').go('/trade/list');
          } else {
            Util.hideLoginDialog();
          }
        },
        // 表单内点击回车键事件
        handleEnterKeyPresse: function(e) {
          this.loginTapHandle();
        },
        // 核对是否登入
        checkIsLogin: function() {
          this.$.findSessionAjax.params = {
            'sessionId': this.sessionId,
          };
          this.$.findSessionAjax.generateRequest();
        },
        handleFindSessionResponse: function(e) {
          var response = e.detail.response;
          // 如果没有登录
          if (response.status !== 0) {
            // 当前页面就是登录页
            if (this.redirect) {
              return
            }
            // 当前页面不是登录页，则跳转到登录页
            document.querySelector('#appRouter').go('/');
            return;
          }

          // 登录了，但当前页是登录页，不必再登录了，跳走
          if (this.redirect) {
            document.querySelector('#appRouter').go('/trade/list');
            return
          }

        }
      });
    })();

  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="report-list">
  <style>
    :host {
      display: block;
    }

    * {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .condition {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .condition > paper-input,
    .condition > x-select {
      min-width: 170px;
      margin-right: 20px;
    }

    .condition > .buttons {
      min-width: 170px;
    }

    .condition > .buttons > paper-button {
      margin: 10px 0px 0px;
    }

    paper-button.colorful {
      background: var(--dark-primary-color);
      color: var(--text-primary-color);
    }

    .loading-more-wrapper {
      text-align: center;
    }

    table {
      width: 100%;
      border-spacing: 0;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    table td {
      text-align: center;
    }

    tr > th,
    tr > td {
      padding: 8px;
      /*border: 1px solid #ddd;*/
    }

    table > thead {}

    thead > tr {}

    thead > tr > th {
      line-height: 1.42857143;
    }

    thead > tr:first-child > th:nth-of-type(1),
    thead > tr:first-child > th:nth-last-of-type(2),
    thead > tr:first-child > th:nth-last-of-type(1) {
      border-bottom: 1px solid #ddd;
    }

    thead > tr > th {
      border-bottom: 1px solid #ddd;
    }

    thead > tr:first-child th {
      /*border-top: 1px solid #ddd;*/
    }

    thead > tr:last-child th {
      text-align: center;
    }

    thead > tr:first-child > th:nth-of-type(3),
    thead > tr > th:nth-of-type(4),
    thead > tr:last-child > th:nth-of-type(2) {
      border-right: 1px solid #ddd;
    }

    table > tbody {
      min-height: 700px;
    }

    tbody > tr:hover {
      background-color: #f5f5f5;
    }

    tbody > tr:nth-last-of-type(2):hover {
      background-color: #fff;
    }

    tbody tr td,
    tbody tr th {
      text-align: right;
      border-top: 1px solid #ddd;
    }

    tbody tr th:nth-of-type(1),
    tbody tr td:nth-of-type(1),
    tbody tr th:nth-of-type(2),
    tbody tr td:nth-of-type(2),
    tbody tr th:nth-last-of-type(2),
    tbody tr td:nth-last-of-type(2),
    tbody tr th:nth-last-of-type(1),
    tbody tr td:nth-last-of-type(1) {
      text-align: center;
    }

    table > tbody tr:last-child th {
      border-top: 1px solid #ddd;
    }
  </style>
  <template>
    <div class="condition">
      <paper-input label="开始日期" on-tap="showStartTimeDialog" value="{{cond.startTime::input}}}"></paper-input>
      <paper-dialog id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
        <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <paper-input label="结束日期" on-tap="showEndTimeDialog" value="{{cond.endTime::input}}}"></paper-input>
      <paper-dialog id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
        <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <x-select items="[[agents]]" selected-item="{{agent}}" label="代理"></x-select>
      <paper-input label="商户号" value="{{cond.merId::input}}"></paper-input>
      <paper-input label="商户名称" value="{{cond.merName::input}}"></paper-input>
      <div class="buttons">
        <paper-button class="colorful" raised on-tap="handleQueryTapped">查询</paper-button>
      </div>
    </div>

    <div class="list">
      <table>
        <thead>
          <tr>
            <th rowspan="2">
              商户号
            </th>
            <th rowspan="2">
              商户名称
            </th>
            <th colspan="2">
              汇总
            </th>
            <th colspan="2">
              支付宝
            </th>
            <th colspan="2">
              微信
            </th>
            <th rowspan="2">
              代理名称
            </th>
            <th rowspan="2">
              下载
            </th>
          </tr>
          <tr>
            <th>总笔数</th>
            <th>总金额(元)</th>
            <th>笔数</th>
            <th>金额(元)</th>
            <th>笔数</th>
            <th>金额(元)</th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="{{records}}">
            <tr>
              <td>
                <span>{{item.merId}}</span>
              </td>
              <td>
                <span>{{item.merName}}</span>
              </td>
              <td>
                <span>{{item.totalTransNum}}</span>
              </td>
              <td>
                <span>{{_computeAmount(item.totalTransAmt)}}</span>
              </td>
              <td>
                <span>{{item.alp.transNum}}</span>
              </td>
              <td>
                <span>{{_computeAmount(item.alp.transAmt)}}</span>
              </td>
              <td>
                <span>{{item.wxp.transNum}}</span>
              </td>
              <td>
                <span>{{_computeAmount(item.wxp.transAmt)}}</span>
              </td>
              <td>
                <span>{{item.agentName}}</span>
              </td>
              <td>
                <a target="_blank" href="{{_computeDownLoadUrl(item)}}" title="点我下载明细">下载明细</a>
              </td>
            </tr>
          </template>
          <tr>
            <td colspan="10">
              <div class="" style="width:100%;">
                <paper-progress id="progress" style="width:100%;" step=2></paper-progress>
                <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="generateAjaxRequest"></x-pagination>
              </div>
            </td>
          </tr>
          <tr>
            <th>
              <span>汇总:</span>
            </th>
            <th></th>
            <th>
              <span>{{summary.totalTransNum}}</span>
            </th>
            <th>
              <span>{{_computeAmount(summary.totalTransAmt)}}</span>
            </th>
            <th>
              <span>{{summary.alp.transNum}}</span>
            </th>
            <th>
              <span>{{_computeAmount(summary.alp.transAmt)}}</span>
            </th>
            <th>
              <span>{{summary.wxp.transNum}}</span>
            </th>
            <th>
              <span>{{_computeAmount(summary.wxp.transAmt)}}</span>
            </th>
            <th></th>
            <th>
              <a href$="{{summaryReportUri}}" title="点我下载当前所有商户交易汇总" target="_blank">下载汇总</a>
            </th>
          </tr>
        </tbody>
      </table>
    </div>
    <iron-ajax id="queryAjax" method="GET" url="/master/trade/stat" handle-as="json" debounce-duration="1000" on-response="handelQueryResponse"></iron-ajax>
    <!--
        测试环境的链接为 211.147.72.70:10003
        生产环境的链接为 211.144.213.118
    -->
    <!-- <iron-ajax id="oldQueryAjax" method="GET" url="http://211.147.72.70:10003/trade/reports" handle-as="json" debounce-duration="1000" on-response="handelQueryResponse"></iron-ajax> -->
    <iron-ajax id="queryAgentAjax" method="GET" url="/master/agent/find" handle-as="json" debounce-duration="1000" on-response="handleQueryAgentsResponse"></iron-ajax>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'report-list',

        properties: {
          cond: {
            type: Object,
            value: {}
          }
        },
        ready: function() {
          this.cond = {
            startTime: this.getYesterdayISODate(),
            endTime: this.getYesterdayISODate(),
            page: 1,
            size: 10,
            total: 0
          };
          // 加载代理列表
          this.handleQueryAgentsEvent();
        },
        // 查询交易报表事件
        handleQueryTapped: function() {
          this.set('cond.page', 1);
          this.generateAjaxRequest();
        },
        generateAjaxRequest: function() {
          this.progressGo();
          this.records = [];
          var ajax = this.$.queryAjax;
          ajax.params = this.cond;
          ajax.generateRequest();
        },
        // 查询交易报表的响应事件
        handelQueryResponse: function(e) {
          var response = e.detail.response;
          this.progressStop();
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          var pagination = response.data;
          this.set('summary', pagination.data);

          if (pagination.count <= 0) {
            Util.toast('没有数据', 1000);
            return;
          }
          this.records = pagination.data.data.slice(0);

          this.set('cond.total', pagination.total);
          this.set('cond.page', pagination.page);
          if (this.records.length === 0) {
            Util.toast('没有数据', 2000);
          }
        },
        // 查询代理列表
        handleQueryAgentsEvent: function() {
          this.$.queryAgentAjax.params = {
            page: 1,
            size: 1000
          };
          this.$.queryAgentAjax.generateRequest();
        },
        // 代理列表响应
        handleQueryAgentsResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast('加载代理列表失败', 3000);
            return;
          }

          var pagination = response.data;
          if (pagination.count <= 0) {
            Util.toast('没有代理数据', 2000);
            return;
          }

          var agents = response.data.data.slice(0);
          this.set('agents', []);
          for (var i = 0, l = agents.length; i < l; i++) {
            this.push('agents', {
              key: agents[i].agentCode,
              value: agents[i].agentName
            });
          }
        },
        observers: [
          '_watchAgentChange(agent.key)',
          '_watchCondChange(cond.*)'
        ],
        _watchCondChange: function() {
            var t = new Date().format('yyyyMMdd-hhmmss');
            this.summaryReportUri = '/master/trade/stat/report?' + Util.query(this.cond) + '&filename=汇总报表_' + t + '.xlsx';
        },
        _watchAgentChange: function(key) {
          if (key) {
            this.set('cond.agentCode', key);
          } else {
            delete this.cond.agentCode;
          }
        },
        getYesterdayISODate: function() {
          var now = new Date();
          var yesterday = new Date(now.valueOf() - 24 * 60 * 60 * 1000);
          return yesterday.format('yyyy-MM-dd');
        },
        // 日期、时间控件
        dismissStartTimeDialog: function() {
          var startTime = this.$.startTimePicker.date;
          this.set('cond.startTime', this.$.startTimePicker.dateFormat(startTime, 'l'));
        },
        showStartTimeDialog: function() {
          this.$.startTimeDailog.toggle();
        },
        dismissEndTimeDialog: function() {
          var endTime = this.$.endTimePicker.date;
          this.set('cond.endTime', this.$.endTimePicker.dateFormat(endTime, 'l'));
        },
        showEndTimeDialog: function() {
          this.$.endTimeDailog.toggle();
        },
        // 修饰金额的方法
        _computeAmount: function(amount) {
          return amount.toFixed(2);
        },
        // 整理下载报表的url
        _computeDownLoadUrl: function(item) {
          var t = new Date().format('yyyyMMdd-hhmmss'),
            obj = {};
          for (var i = 0, arr = Object.keys(this.cond), l = arr.length; i < l; i++) {
            var v = arr[i];
            obj[v] = this.cond[v];
          }
          obj.mchntid = item.merId;
          obj.filename = '报表_' + t + '_' + item.merName + '.xlsx';
          return '/master/trade/report?' + Util.query(obj);
        },
        progressGo: function() {
          var progress = this.$.progress,
            repeat = 0,
            animating = false;

          function startProgress() {
            repeat = 0;
            progress.value = progress.min;
            if (!animating) {
              progress.setAttribute('stop', false);
              nextProgress();
            }
          }

          function nextProgress() {
            var isStop = progress.getAttribute('stop');
            animating = true;
            if (progress.value < progress.max) {
              progress.value += (progress.step || 1);
            } else {
              if (isStop === 'true') {
                animating = false;
                return;
              }
              progress.value = progress.min;
            }

            requestAnimationFrame(nextProgress);
          }
          startProgress();
        },
        progressStop: function() {
          var progress = this.$.progress;
          progress.setAttribute('stop', true);
        }
      });
    })();
  </script>
</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../elements/x-pagination/x-pagination.html">
<link rel="import" href="../styles/app-theme.html">

<dom-module id="scaffold-layout">
  <style>
    :host {
      display: block;
      --dark-primary-color: #05B0CF;
      --default-primary-color: #00BCD4;
      --light-primary-color: #ffffff;
      --text-primary-color: #ffffff;
      /*text/icons*/
      --accent-color: #FF4081;
      --primary-background-color: #ffffff;
      --primary-text-color: #212121;
      --secondary-text-color: #727272;
      --disabled-text-color: #bdbdbd;
      --divider-color: #B6B6B6;
      /* Components */
      /* paper-drawer-panel */
      --drawer-menu-color: #ffffff;
      --drawer-border-color: 1px solid #ccc;
      --drawer-toolbar-border-color: 1px solid rgba(0, 0, 0, 0.22);
      /* paper-menu */
      --paper-menu-background-color: #fff;
      --menu-link-color: #111111;
      --paper-input-container-input: {
        font-size: 14px;
      }
      --paper-input-container-label: {
        font-size: 14px;
      }
      --paper-menu-selected-item: {
        background-color: rgb(226, 240, 249);
      }
    }

    #drawerToolbar * {
      font-size: 20px;
      color: var(--text-primary-color);
      background-color: var(--default-primary-color);
    }

    #drawerToolbar .logo {
      margin: auto auto 10px;
    }

    paper-scroll-header-panel {
      height: 100%;
    }

    paper-material {
      border-radius: 2px;
      height: 100%;
      padding: 16px 0 16px 0;
      width: calc(98.66% - 16px);
      margin: 16px auto;
      background: white;
    }

    paper-menu iron-icon {
      margin-right: 33px;
      opacity: 0.54;
    }

    .paper-menu > .iron-selected {
      color: var(--default-primary-color);
    }

    paper-menu a {
      text-decoration: none;
      color: var(--menu-link-color);
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
      -ms-flex-direction: row;
      -webkit-flex-direction: row;
      flex-direction: row;
      -ms-flex-align: center;
      -webkit-align-items: center;
      align-items: center;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 14px;
      font-weight: 400;
      line-height: 24px;
      min-height: 39px;
      padding: 0 16px;
    }

    iron-collapse > paper-menu a > iron-icon {
      margin-left: 15px;
    }

    paper-submenu iron-icon,
    paper-submenu span {
      pointer-events: none;
    }

    .sublist {
      padding-left: 20px;
      padding-right: 20px;
    }

    paper-toolbar.tall .app-name {
      font-size: 40px;
      font-weight: 300;
      -webkit-transform-origin: left center;
      transform-origin: left center;
    }

    #mainToolbar .middle-container {
      height: 100%;
      margin-left: 48px;
    }

    #mainToolbar:not(.tall) .middle {
      font-size: 18px;
      padding-bottom: 0;
    }

    #mainToolbar .bottom {
      margin-left: 48px;
      -webkit-transform-origin: left center;
      transform-origin: left center;
    }

    #mainContainer > .content {
      padding: 20px;
    }

    @media (max-width: 600px) {
      paper-material {
        --menu-container-display: none;
        width: calc(97.33% - 32px);
        padding-left: 16px;
        padding-right: 16px;
      }
      .paper-font-display1 {
        font-size: 12px;
      }
      paper-toolbar.tall .app-name {
        font-size: 24px;
        font-weight: 400;
      }
      #drawer .paper-toolbar {
        margin-left: 16px;
      }
      #overlay {
        min-width: 360px;
      }
      .bg {
        background: white;
      }
    }

    @media (min-width: 601px) {
      paper-material {
        width: calc(98% - 46px);
        margin-bottom: 32px;
        padding-left: 30px;
        padding-right: 30px;
      }
      iron-pages {
        padding: 15px 20px;
      }
    }
  </style>
  <template>
    <paper-drawer-panel id="paperDrawerPanel" on-paper-header-transform="paperHeaderTransform">
      <!-- Drawer Scroll Header Panel -->
      <paper-scroll-header-panel drawer fixed>

        <!-- Drawer Toolbar -->
        <paper-toolbar id="drawerToolbar">
          <img src="../images/logo2.svg" alt="云收银" class="logo">
          <div class="app-name">快捷支付管理平台</div>
        </paper-toolbar>

        <!-- 菜单列表 -->
        <paper-menu>
          <template is="dom-repeat" items="{{menus}}" as="menu">
            <paper-submenu opened="{{ startWith(route.path, menu.route) }}">
              <paper-item class="menu-trigger">
                <iron-icon icon$="{{menu.icon}}"></iron-icon>
                <span>{{menu.nameCN}}</span>
              </paper-item>
              <paper-menu class="menu-content sublist" attr-for-selected="data-route" selected="{{route.name}}">
                <template is="dom-repeat" items="{{menu.children}}" as="subMenu">
                  <a data-route$="{{subMenu.route}}" href$="{{subMenu.url}}">
                    <iron-icon icon$="{{subMenu.icon}}"></iron-icon>
                    <span>{{subMenu.nameCN}}</span>
                  </a>
                </template>
              </paper-menu>
            </paper-submenu>
          </template>
        </paper-menu>

      </paper-scroll-header-panel>

      <!-- Main Area -->
      <paper-scroll-header-panel main condenses keep-condensed-header>

        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar" class="tall">
          <paper-icon-button id="paperToggle" icon="menu" paper-drawer-toggle></paper-icon-button>
          <span class="flex"></span>
          <div>欢迎您，
            <span>{{user.nickName}}</span>
          </div>
          <paper-button id="logoutBtn" on-tap="logoutHandle">退出</paper-button>
          <!-- Toolbar icons -->
          <paper-icon-button icon="refresh"></paper-icon-button>
          <paper-icon-button icon="search"></paper-icon-button>

          <!-- Application name -->
          <div class="middle middle-container center horizontal layout" id="middleContainer">
            <div class="app-name" id="appName">{{route.title}}</div>
          </div>

          <!-- Application sub title -->
          <div class="bottom bottom-container center horizontal layout" id="bottomContainer">
            <div class="bottom-title paper-font-subhead">{{route.subtitle}}</div>
          </div>

        </paper-toolbar>

        <!-- Main Content -->
        <content select=".content"></content>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <iron-ajax id="findSessionAjax" method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleFindSessionResponse"></iron-ajax>
    <iron-ajax id="deleteSessionAjax" method="GET" url="/master/session/delete" handle-as="json" debounce-duration="1000" on-response="handleDeleteSessionResponse"></iron-ajax>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'scaffold-layout',

        properties: {
          route: {
            type: Object,
          },
          user: {
            type: Object,
            notify: true
          }
        },
        ready: function() {
          //  进去页面之前先判断用户是否已登录
          var sessionId = window.sessionStorage.getItem('SESSIONID');
          if (!sessionId || sessionId === '') {
            window.location.href = 'login.html';
            return;
          }
          this.$.findSessionAjax.params = {
            'sessionId': sessionId,
          };
          this.$.findSessionAjax.generateRequest();
          // 初始化菜单
          this.adminMenus = [{
            "nameCN": "扫码支付商户配置",
            "nameEN": "",
            "icon": "build",
            "url": "",
            "route": "config",
            "children": [{
              "nameCN": "代理",
              "nameEN": "",
              "icon": "assignment-ind",
              "url": "#/config/agents",
              "route": "config.agents"
            }, {
              "nameCN": "二级代理",
              "nameEN": "",
              "icon": "account-circle",
              "url": "#/config/subAgents",
              "route": "config.subAgents"
            }, {
              "nameCN": "集团商户",
              "nameEN": "",
              "icon": "home",
              "url": "#/config/groups",
              "route": "config.groups"
            }, {
              "nameCN": "商户录入",
              "nameEN": "",
              "icon": "create",
              "url": "#/config/configMer",
              "route": "config.configMer"
            }, {
              "nameCN": "批量导入",
              "nameEN": "",
              "icon": "cloud-upload",
              "url": "#/config/upload",
              "route": "config.upload"
            }, {
              "nameCN": "机构商户",
              "nameEN": "",
              "icon": "store",
              "url": "#/config/merchants",
              "route": "config.merchants"
            }, {
              "nameCN": "渠道商户",
              "nameEN": "",
              "icon": "account-balance",
              "url": "#/config/chanMers",
              "route": "config.chanMers"
            }, {
              "nameCN": "路由策略",
              "nameEN": "",
              "icon": "settings-input-component",
              "url": "#/config/routes",
              "route": "config.routes"
            }, {
              "nameCN": "用户",
              "nameEN": "",
              "icon": "account-box",
              "url": "#/config/users",
              "route": "config.users"
            }]
          }, {
            "nameCN": "快捷支付商户配置",
            "nameEN": "",
            "icon": "swap-horiz",
            "url": "",
            "route": "quickPay",
            "children": [{
              "nameCN": "机构商户",
              "nameEN": "",
              "icon": "store",
              "url": "#/quickPay/merchants",
              "route": "quickPay.merchants"
            }, {
              "nameCN": "渠道商户",
              "nameEN": "",
              "icon": "account-balance",
              "url": "#/quickPay/chanMers",
              "route": "quickPay.chanMers"
            }, {
              "nameCN": "路由策略",
              "nameEN": "",
              "icon": "settings-input-component",
              "url": "#/quickPay/routes",
              "route": "quickPay.routes"
            }]
          }, {
            "nameCN": "交易查询",
            "nameEN": "",
            "icon": "swap-horiz",
            "url": "",
            "route": "trade",
            "children": [{
              "nameCN": "扫码交易",
              "nameEN": "",
              "icon": "payment",
              "url": "#/trade/list",
              "route": "trade.list"
            }, {
              "nameCN": "绑定交易",
              "nameEN": "",
              "icon": "payment",
              "url": "#/trade/bindingpay/list",
              "route": "trade.bindingpay.list"
            }, {
              "nameCN": "报表下载",
              "nameEN": "",
              "icon": "file-download",
              "url": "#/trade/reports",
              "route": "trade.reports"
            }, {
              "nameCN": "旧系统报表下载",
              "nameEN": "",
              "icon": "cloud-download",
              "url": "#/trade/old/reports",
              "route": "trade.old.reports"
            }]
          }, {
            "nameCN": "内部测试",
            "nameEN": "",
            "icon": "bug-report",
            "url": "",
            "route": "test",
            "children": [{
              "nameCN": "扫码支付",
              "nameEN": "",
              "icon": "pageview",
              "url": "#/test/scanpay",
              "route": "test.scanpay"
            }, {
              "nameCN": "绑定支付",
              "nameEN": "",
              "icon": "icons:speaker-notes",
              "url": "#/test/bindingpay",
              "route": "test.bindingpay"
            }, {
              "nameCN": "七牛 Ajax 上传文件",
              "nameEN": "",
              "icon": "cloud-upload",
              "url": "#/test/qiniu",
              "route": "test.qiniu"
            }, {
              "nameCN": "HTML5读取文件内容",
              "nameEN": "",
              "icon": "get-app",
              "url": "#/test/filereader",
              "route": "test.filereader"
            }]
          }];
          this.agentMenus = [{
            "nameCN": "交易查询",
            "nameEN": "",
            "icon": "swap-horiz",
            "url": "",
            "route": "trade",
            "children": [{
              "nameCN": "扫码交易",
              "nameEN": "",
              "icon": "payment",
              "url": "#/trade/list",
              "route": "trade.list"
            },{
              "nameCN": "报表下载",
              "nameEN": "",
              "icon": "file-download",
              "url": "#/trade/reports",
              "route": "trade.reports"
            }]
          }];

        },
        paperHeaderTransform: function(e) {
          var appName = this.$.appName;
          var middleContainer = this.$.middleContainer;
          var bottomContainer = this.$.bottomContainer;
          var detail = e.detail;
          var heightDiff = detail.height - detail.condensedHeight;
          var yRatio = Math.min(1, detail.y / heightDiff);
          var maxMiddleScale = 0.50; // appName max size when condensed. The smaller the number the smaller the condensed size.
          var scaleMiddle = Math.max(maxMiddleScale, (heightDiff - detail.y) / (heightDiff / (1 - maxMiddleScale)) + maxMiddleScale);
          var scaleBottom = 1 - yRatio;

          // Move/translate middleContainer
          Polymer.Base.transform('translate3d(0,' + yRatio * 100 + '%,0)', middleContainer);

          // Scale bottomContainer and bottom sub title to nothing and back
          Polymer.Base.transform('scale(' + scaleBottom + ') translateZ(0)', bottomContainer);

          // Scale middleContainer appName
          Polymer.Base.transform('scale(' + scaleMiddle + ') translateZ(0)', appName);
        },
        startWith: function(name, prefix) {
          console.log(name, prefix);
          if (!name || !prefix) {
            return false;
          }
          return name.substr(1, prefix.length) === prefix;
        },
        handleFindSessionResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            window.location.href = 'login.html';
            return;
          }
          this.user = response.data;
          var userType = this.user.userType;
          window.sessionStorage.setItem('USERTYPE', userType);
          if (userType === 'admin') {
            this.menus = this.adminMenus;
          } else if (userType === 'agent' || userType === 'group' || userType === 'merchant') {
            this.menus = this.agentMenus;
          }
        },
        handleDeleteSessionResponse: function() {

        },
        // 退出
        logoutHandle: function() {
          var sessionId = window.sessionStorage.getItem('SESSIONID');
          // 删除后台sesseion信息
          this.$.deleteSessionAjax.params = {
            'sessionId': sessionId,
          };
          this.$.deleteSessionAjax.generateRequest();

          // 清楚sessionStorage中的信息
          window.sessionStorage.removeItem('SESSIONID');
          window.sessionStorage.removeItem('USERTYPE');
          this.user = {};
          this.$.logoutBtn.hidden = true;

          // 跳转至登录页面
          window.location.href = 'login.html';
        },
      });
    })();
  </script>
</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-icons/editor-icons.html">
<link rel="import" href="../bower_components/core-overlay/core-overlay.html">
<link rel="import" href="../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="post-card.html">

<polymer-element name="merchant-chosen" attributes="">
    <template>
        <style>
            :host {
                display: block;
                width: 100%;
            }

        </style>
        <core-ajax id="ajax" method="POST" url="/quickMaster/merchant/all" auto handleAs="json"
            body='{"merStatus":"Test"}'
            on-core-response="{{onResponse}}">
        </core-ajax>
        <paper-action-dialog id="overlay" heading="选择商户" class="scrolling" layered backdrop transition="core-transition-center">
            <style media="screen">
                paper-fab {
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background-color: #03a9f4;
                }
            </style>
            <paper-fab mini icon="clear" title="close" on-tap="{{close}}"></paper-fab>
            <div layout vertical center>
                <template repeat="{{merchant in merchants}}">
                    <post-card identity="{{merchant.merId}}" on-chosen-tap="{{handleChosen}}">
                        <div class="key-content">
                            <dl>
                                <dt>
                                    <core-icon icon="perm-identity" alt="商户代码"></core-icon> {{merchant.merId}}
                                </dt>
                                <dd>{{merchant.remark}}</dd>
                                <dt>
                                    <core-icon icon="verified-user" alt="签名密钥"></core-icon>签名密钥
                                </dt>
                                <dd>{{merchant.signKey}}</dd>
                                <dt>
                                    <core-icon icon="lock" alt="加密密钥"></core-icon>加密密钥
                                </dt>
                                <dd>{{merchant.encryptKey}}</dd>
                            </dl>
                        </div>
                    </post-card>
                </template>
            </div>
        </paper-action-dialog>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer('merchant-chosen', {
                created: function() {
                    this.merchants = [];
                },
                ready: function() {
                    // 检查本地是否缓存商户的信息
                    var merchant = window.localStorage.getItem('QUICKPAY-MERCHANT');
                    if (!!merchant) {
                        return;
                    }

                    this.open();
                },
                toggle: function() {
                    this.$.overlay.toggle();
                },

                open: function() {
                    this.$.overlay.open();
                },

                close: function() {
                    this.$.overlay.close();
                },
                onResponse: function() {
                    var response = this.$.ajax.response;
                    if (response.status === 0) {
                        this.merchants = response.data.slice(0)
                    }
                },
                handleChosen: function(event, detail, sender) {
                    var merchant = sender.templateInstance.model.merchant;
                    // 存储到本地存储中
                    window.localStorage.setItem('QUICKPAY-MERCHANT', JSON.stringify(merchant));
                    document.querySelector('#merchantName').innerText = merchant.merId;
                    this.close();
                }
            });
        })();
    </script>
</polymer-element>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="post-card.html">
<link rel="import" href="chan-mer-card.html">

<polymer-element name="router-policy-editor">
    <template>
        <style>
            #listContainer {
                min-height: 300px;
                margin: 0;
            }

            #listContainer > div[flex] {
                margin-right: 10px;
            }

            core-header-panel {
                width: 100%;
                height: 600px;
            }

            .core-header {
                height: 60px;
                line-height: 60px;
                font-size: 18px;
                padding: 0 10px;
                background-color: #03a9f4;
                color: #FFF;
                transition: height 0.2s;
                position: relative;
            }

            .content {
                padding: 0 10px;
            }

            .table {
                width: 100%;
            }

            .table span {
                display: inline-block;
            }

            .table .thead {
                font-weight: bold;
                color: #6c6c6c;
            }

            .table > .thead span,
            .table > .tbody span {
                width: 23%;
                padding-right: 5px;
                word-wrap: break-word;
            }

            .table > .thead span:first-child,
            .table > .tbody span:first-child {
                padding-left: 8px;
                width: 6%;
                text-align: right;
            }

            .table > .thead span:nth-child(3),
            .table > .tbody span:nth-child(3) {
                width: 10%;
            }

            .table > .thead span:last-child,
            .table > .tbody span:last-child {
                /*padding-right: 24px;*/
            }

            .table .thead,
            .table .row {
                border-bottom: 1px solid #e3e3e3;
                padding: 10px 0;
            }

            .table .row:last-child {
                border-bottom: none;
            }

            .table .row:hover {
                background-color: #eeeeee;
            }

            .colored {
                background: #ffeb3b;
                color: #fff;
                position: absolute;
                right: 24px;
                top: 10px;
            }

            .green {
                background: #259b24;
                color: #fff;
                position: absolute;
                right: 24px;
                top: 10px;
            }

            paper-toast {
                top: 10px;
                bottom: auto;
                right: 10px;
                left: auto;
            }
        </style>
        <div id="container" vertical layout>
            <div id="listContainer" horizontal layout>
                <div flex five hidden?="{{!isRouterEdit}}">
                    <core-ajax id="routerSaveAjax" method="POST" url="/quickMaster/router/save" handleAs="json" body='{}' on-core-response="{{onRouterSaveAjaxResponse}}">
                    </core-ajax>
                    <core-header-panel>
                        <div class="core-header">
                            路由编辑
                            <paper-fab mini id="saveRouter" icon="save" class="green" raised title="arrow-forward" on-tap="{{handleRouterSave}}"></paper-fab>
                        </div>
                        <div class="content">
                            <paper-input-decorator floatingLabel label="商户编号" class="custom" autoValidate="true" error="必填，最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="merId" is="core-input" type="text" name="merId" maxlength="50" required="true" value="{{body.merId}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="merId"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="渠道代码" class="custom" autoValidate="true" error="必填，最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="chanCode" is="core-input" type="text" name="chanCode" maxlength="50" required="true" value="{{body.chanCode}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="chanCode"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="渠道商户号" class="custom" autoValidate="true" error="必填，最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="chanMerId" is="core-input" type="text" name="chanMerId" maxlength="50" required="true" value="{{body.chanMerId}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="chanMerId"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="卡品牌" class="custom" autoValidate="true" error="必填，最长 3 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="cardBrand" is="core-input" type="text" name="cardBrand" maxlength="3" required="true" value="{{body.cardBrand}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="cardBrand"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="卡类型" class="custom" autoValidate="false" error="最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="cardType" is="core-input" type="text" name="cardType" maxlength="50" required="false" value="{{body.cardType}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="cardType"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="交易类型" class="custom" autoValidate="false" error="最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="transType" is="core-input" type="text" name="transType" maxlength="50" required="false" value="{{body.transType}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="transType"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="卡Bin组" class="custom" autoValidate="false" error="最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="binGroup" is="core-input" type="text" name="binGroup" maxlength="50" required="false" value="{{body.binGroup}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="binGroup"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="输入方式" class="custom" autoValidate="false" error="最长 50 个字符">
                                <core-tooltip label="" position="top">
                                    <input id="inputWay" is="core-input" type="text" name="inputWay" maxlength="50" required="false" value="{{body.inputWay}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="inputWay"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="起始金额" class="custom" autoValidate="false" error="">
                                <core-tooltip label="" position="top">
                                    <input id="minAmount" is="core-input" type="text" name="minAmount" maxlength="50" required="false" value="{{body.minAmount}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="minAmount"></paper-char-counter>
                            </paper-input-decorator>

                            <paper-input-decorator floatingLabel label="最大金额" class="custom" autoValidate="false" error="">
                                <core-tooltip label="与起始金额配套使用，该金额范围" position="top">
                                    <input id="maxAmount" is="core-input" type="number" name="maxAmount" maxlength="50" required="false" value="{{body.maxAmount}}">
                                </core-tooltip>
                                <paper-char-counter class="counter" target="maxAmount"></paper-char-counter>
                            </paper-input-decorator>
                        </div>
                    </core-header-panel>
                </div>
                <div flex five hidden?="{{isRouterEdit}}">
                    <core-ajax id="routerAjax" method="POST" url="/quickMaster/router/find" auto handleAs="json" params='{"merId": ""}' on-core-response="{{onAllRouterAjaxResponse}}">
                    </core-ajax>
                    <core-header-panel>
                        <div class="core-header">
                            路由列表
                            <paper-fab hidden?="{{isRouterEdit}}" mini id="addRouterFab" icon="create" class="colored" raised title="新增路由" on-tap="{{handleRouterEdit}}"></paper-fab>
                        </div>
                        <div class="content">
                            <div class="table">
                                <div class="thead">
                                    <span>#</span>
                                    <span>商户号</span>
                                    <span>卡品牌</span>
                                    <span>渠道代码</span>
                                    <span>渠道商户号</span>
                                </div>
                                <div class="tbody">
                                    <template repeat="{{route,index in routers}}">
                                        <div class="row">
                                            <span>{{index+1}}</span>
                                            <span>{{route.merId}}</span>
                                            <span>{{route.cardBrand}}</span>
                                            <span>{{route.chanCode}}</span>
                                            <span>{{route.chanMerId}}</span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </core-header-panel>
                </div>

                <div flex three>
                    <core-ajax id="merAjax" method="POST" url="/quickMaster/merchant/all" auto handleAs="json" body='{}' on-core-response="{{onAllMerchantAjaxResponse}}">
                    </core-ajax>
                    <core-header-panel>
                        <div class="core-header">商户列表</div>
                        <div class="content">
                            <template repeat="{{merchant in merchants}}">
                                <post-card identity="{{merchant.merId}}" on-chosen-tap="{{handleMerchantChosen}}">
                                    <div class="key-content">
                                        <dl>
                                            <dt>
                                                <core-icon icon="perm-identity" alt="商户代码"></core-icon> {{merchant.merId}}
                                            </dt>
                                            <dd>{{merchant.remark}}</dd>
                                            <dt>
                                                <core-icon icon="verified-user" alt="签名密钥"></core-icon>签名密钥
                                            </dt>
                                            <dd>{{merchant.signKey}}</dd>
                                            <dt>
                                                <core-icon icon="lock" alt="加密密钥"></core-icon>加密密钥
                                            </dt>
                                            <dd>{{merchant.encryptKey}}</dd>
                                        </dl>
                                    </div>
                                </post-card>
                            </template>
                        </div>
                    </core-header-panel>
                </div>
                <div flex two>
                    <core-ajax id="chanMerAjax" method="POST" url="/quickMaster/channelMerchant/all" auto handleAs="json" body='{}' on-core-response="{{onAllChannelMerchantAjaxResponse}}">
                    </core-ajax>
                    <core-header-panel>
                        <div class="core-header">渠道商户列表</div>
                        <div class="content">
                            <template repeat="{{merchant in chanMers}}">
                                <chan-mer-card on-chosen-tap="{{handleChannelMerchantChosen}}">
                                    渠道代码：{{merchant.chanCode}}
                                    <br> 商户号：{{merchant.chanMerId}}
                                    <br> 商户名称：{{merchant.chanMerName}}
                                    <br> 机构号：{{merchant.insCode || '-'}}
                                    <br> 终端号：{{merchant.terminalId || '-'}}
                                    <br>
                                </chan-mer-card>
                            </template>
                        </div>
                    </core-header-panel>
                </div>
            </div>
        </div>
        <paper-toast id="ret" role="alert" text="{{ajaxResponse}}">
        </paper-toast>
    </template>

    <script>
        (function() {
            'use strict';
            Polymer('router-policy-editor', {
                body: {},
                ready: function() {
                    this.merchants = [];
                    this.chanMers = [];
                    this.isRouterEdit = false;
                    this.resetRouter();
                },
                resetRouter: function() {
                    this.body = {
                        merId: '',
                        chanCode: '',
                        chanMerId: '',
                        cardBrand: '',
                        cardType: '',
                        transType: '',
                        binGroup: '',
                        inputWay: '',
                        minAmount: '',
                        maxAmount: ''
                    };
                },
                // 请求所有的商户的ajax响应事件
                onAllMerchantAjaxResponse: function() {
                    var response = this.$.merAjax.response;
                    if (response && response.status === 0) {
                        this.merchants = response.data.slice(0)
                    }
                },
                // 请求所有的渠道商户的ajax响应事件
                onAllChannelMerchantAjaxResponse: function() {
                    var response = this.$.chanMerAjax.response;
                    if (response && response.status === 0) {
                        this.chanMers = response.data.slice(0)
                    }
                },
                // 请求所有路由的ajax响应事件
                onAllRouterAjaxResponse: function() {
                    var response = this.$.routerAjax.response;
                    if (response && response.status === 0) {
                        this.routers = response.data.slice(0)
                    }
                },
                // 请求保存路由的ajax响应事件
                onRouterSaveAjaxResponse: function() {
                    var response = this.$.routerSaveAjax.response;
                    if (response) {
                        // 提示信息
                        this.$.ret.text = response.message;
                        this.$.ret.show();

                        if (response.status === 0) {
                            this.$.routerAjax.go();
                            this.isRouterEdit = false;
                        }
                    }

                },
                // 编辑路由触发器
                handleRouterEdit: function(event, detail, sender) {
                    // 重置路由对象
                    this.resetRouter();
                    // 显示编辑区
                    this.isRouterEdit = true;
                },
                // 保存路由
                handleRouterSave: function(event, detail, sender) {
                    // 发送到后台的ajax请求，保存路由
                    this.$.routerSaveAjax.body = JSON.stringify(this.body);
                    this.$.routerSaveAjax.go();
                },
                // 商户选择处理事件
                handleMerchantChosen: function(event, detail, sender) {
                    var merchant = sender.templateInstance.model.merchant;
                    this.body.merId = merchant.merId;
                },
                // 渠道商户选择处理事件
                handleChannelMerchantChosen: function(event, detail, sender) {
                    var merchant = sender.templateInstance.model.merchant;
                    this.body.chanCode = merchant.chanCode;
                    this.body.chanMerId = merchant.chanMerId;
                }
            });
        })();
    </script>
</polymer-element>

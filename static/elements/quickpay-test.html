<link rel="import" href="../bower_components/polymer/polymer.html">


<link rel="import" href="../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/core-field/core-field.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<script src="../bower_components/cryptojslib/rollups/sha1.js"></script>
<script src="../bower_components/cryptojslib/rollups/aes.js"></script>

<polymer-element name="quickpay-test" attributes="url elems">
    <template>
        <style>
            .custom /deep/::-webkit-input-placeholder {
                color: #f4b400;
            }

            .custom /deep/::-moz-placeholder {
                color: #f4b400;
            }

            .custom /deep/:-ms-input-placeholder {
                color: #f4b400;
            }

            .custom /deep/ .label-text,
            .custom /deep/ .error {
                color: #f06292;
            }

            .custom /deep/ .unfocused-underline {
                background-color: #0f9d58;
            }

            .custom[focused] /deep/ .floated-label .label-text {
                color: #0f9d58;
            }

            .custom /deep/ .focused-underline {
                background-color: #0f9d58;
            }

            .custom.invalid /deep/ .floated-label .label-text,
            .custom /deep/ .error {
                color: #f06292;
            }

            .custom.invalid /deep/ .focused-underline {
                background-color: #f06292;
            }

            .custom {
                color: #1a237e;
            }

            .colored {
                background: #03a9f4;
                color: #fff;
            }

            core-field {
                margin-top: 30px;
            }

            paper-toast {
                top: 10px;
                bottom: auto;
                right: 10px;
                left: auto;
            }
        </style>
        <core-ajax id="postAjax" method="POST" contentType='application/json' handleAs="json" on-core-response="{{onResponse2}}"></core-ajax>

        <template repeat="{{e in elems}}">
            <paper-input-decorator floatingLabel label="{{e.label}}" class="custom" autoValidate="{{e.autoValidate}}" error="{{e.error}}">
                <core-tooltip label="{{e.tooltip}}" position="top">
                    <input id="{{e.id}}" is="core-input" name="{{e.name}}" maxlength="{{e.maxlength}}" required="{{e.required}}" value="{{e.value}}">
                </core-tooltip>
                <paper-char-counter class="counter" target="{{e.id}}"></paper-char-counter>
            </paper-input-decorator>
        </template>

        <paper-fab mini id="submitForm" icon="arrow-forward" class="colored" raised title="arrow-forward"></paper-fab>

        <paper-input-decorator floatingLabel label="响应" class="custom">
            <paper-autogrow-textarea>
                <textarea cols="144" rows="3" value="{{rcvd}}"></textarea>
            </paper-autogrow-textarea>
            <paper-char-counter class="counter" target="inputRet"></paper-char-counter>
        </paper-input-decorator>

        <paper-toast id="ret" role="alert" text="{{rcvd}}">
        </paper-toast>

    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                elems: [],
                encrypt: function(plaintext) {
                    // var plaintext = '000102030405060708090a0b0c0d0e0f000102030405060708090a0b0c0d0e0f'
                    //
                    // var key = CryptoJS.enc.Base64.parse('');
                    var key = CryptoJS.enc.Base64.parse(this.getMerchant().encryptKey);
                    // var iv  = CryptoJS.enc.Hex.parse('000102030405060708090a0b0c0d0e0f');
                    var iv = CryptoJS.lib.WordArray.random(16);
                    var encrypted = CryptoJS.AES.encrypt(plaintext, key, {
                        iv: iv
                    });
                    //
                    // // var encrypted = CryptoJS.AES.encrypt("Message", "Secret Passphrase");
                    //
                    // console.log(encrypted.key+"");        // 000102030405060708090a0b0c0d0e0f000102030405060708090a0b0c0d0e0f
                    // console.log(encrypted.iv+"");         // 000102030405060708090a0b0c0d0e0f
                    // console.log(encrypted.salt+"");       // undefined
                    // console.log(encrypted.ciphertext+""); // 8bbfb86054acf430e44245c4bf74b2549e85387d6887a257bcaf1fb29f7969b20dd40628c7cf734f35b4fdbadd24ee2843e198a202e0850b79038b4562909a7cf40c9ee3ec08e9047b3a7859a6502220

                    var b64encrypted = encrypted.iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64)
                        // console.log(b64encrypted)

                    return b64encrypted;
                },
                getMerchant: function() {
                    // 当前商户
                    var merchantStorage = window.localStorage.getItem('QUICKPAY-MERCHANT');
                    if (!merchantStorage) {
                        document.querySelector('#merchantChangeOverlay').open();
                    }
                    var merchant = JSON.parse(merchantStorage);
                    return merchant;
                },
                ready: function() {
                    var merStr = window.localStorage.getItem('QUICKPAY-MERCHANT');
                    if (!!merStr) {
                        var merchant = JSON.parse(merStr);
                        document.querySelector('#merchantName').innerText = merchant.merId;
                    }

                    var postAjax = this.$.postAjax;
                    var toast = this.$.ret;
                    var button = this.$.submitForm;

                    var _this = this;
                    button.addEventListener('click', function() {

                        // postAjax.url = _this.url + "?merId=012345678901234";
                        postAjax.url = _this.url + "?merId=" + _this.getMerchant().merId;

                        var body = {};
                        for (var i = 0; i < _this.elems.length; i++) {
                            var value = _this.elems[i].value;
                            if (_this.elems[i].encrypt && _this.elems[i].encrypt === true) {
                                value = _this.encrypt(value)
                            }

                            if (_this.elems[i].numeric && _this.elems[i].numeric === true) {
                                value = +value;
                            }

                            if (_this.elems[i].object && _this.elems[i].object === true) {
                                try {
                                    value = JSON.parse(value);
                                } catch (e) {
                                    alert("JSON 格式有误: " + e);
                                }
                            }

                            body[_this.elems[i].name] = value;
                        }
                        postAjax.body = JSON.stringify(body);

                        var hash = CryptoJS.SHA1(postAjax.body + _this.getMerchant().signKey);
                        postAjax.headers = '{"X-Sign": "' + hash + '"}';

                        postAjax.go();
                    });

                    postAjax.addEventListener("core-response", function(e, detail, sender) {
                        toast.show();
                        _this.rcvd = JSON.stringify(e.detail.response);
                    });
                }
            });
        })();
    </script>
</polymer-element>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../x-select/x-select.html">

<dom-module id="bindingpay-trade-list">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <input type="hidden" name="startTime" value="{{cond.startTime::input}}" />
        <paper-input label="* 交易时间从" on-tap="showStartTimeDialog" value="{{time.startTimeString::input}}"></paper-input>
        <paper-dialog with-backdrop id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
          <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px" max-date="{{time.endTime}}"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>取消</paper-button>
            <paper-button dialog-confirm>确定</paper-button>
          </div>
        </paper-dialog>

        <input type="hidden" name="endTime" value="{{cond.endTime::input}}" />
        <paper-input label="* 交易时间到" on-tap="showEndTimeDialog" value="{{time.endTimeString::input}}"></paper-input>
        <paper-dialog with-backdrop id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
          <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px" min-date="{{time.startTime}}"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>取消</paper-button>
            <paper-button dialog-confirm>确定</paper-button>
          </div>
        </paper-dialog>

        <paper-input label="商户代码" name="merId"></paper-input>
        <paper-input label="订单号" name="orderNum"></paper-input>
        <!-- <paper-input label="绑定 ID" name="bindingId"></paper-input> -->
        <paper-input label="关联订单号" name="origOrderNum"></paper-input>
        <paper-input label="应答码" name="respcd"></paper-input>
        <x-select items="[[busicds]]" name="transType" selected-item="{{busicd}}" label="交易类型"></x-select>
        <x-select items="[[transStatusMap]]" name="transStatus" selected-item="{{transStatus}}" label="交易状态"></x-select>
        <paper-input id="payType" name="pay" value="bp" hidden></paper-input>
        <paper-button class="colorful" raised on-tap="queryAction">查询</paper-button>
        <!-- <paper-button class="colorful" raised>
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href="{{reportUri}}">下载报表</a>
        </paper-button> -->
      </div>
      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th" align="center">序号</div>
            <div class="th" align="center">应答码</div>
            <div class="th" align="center">商户代码</div>
            <div class="th left">商户订单</div>
            <!-- <div class="th" align="left">绑定 ID</div>
            <div class="th" align="left">用户账号</div>
            <div class="th" align="left">用户名</div> -->
            <div class="th" align="center">交易类型</div>
            <div class="th right">金额(元)</div>
            <div class="th" align="center">渠道</div>
            <div class="th" align="center">交易状态</div>
            <div class="th" align="center">退款</div>
            <div class="th" align="center">交易时间</div>
            <!-- <div class="th" align="center">更新时间</div> -->
          </div>
        </div>
        <div class="tbody">
          <template is="dom-repeat" items="{{trades}}">
            <div class="tr">
              <div class="td" align="center">{{addOneFilter(index)}}</div>
              <div class="td" align="center">
                <div class$="{{getRespCodeColor(item.respcd)}}" style="position: relative;">
                  <span id="{{ _computeRespCodeTooltipId(index) }}" class="abbr">{{item.respcd}}</span>
                  <paper-tooltip for="{{ _computeRespCodeTooltipId(index) }}" position="right">{{item.errorDetail}}</paper-tooltip>
                </div>
              </div>
              <div class="td" align="center">{{item.merId}}</div>
              <div class="td" align="left">{{item.orderNum}}</div>
              <!-- <div class="td" align="left">{{item.bindingId}}</div>
              <div class="td" align="left">{{item.acctNum}}</div>
              <div class="td" align="left">{{item.acctName}}</div> -->
              <div class="td" align="center">{{busicdFilter(item.transType)}}</div>
              <div class="td" align="right">{{_currencyFilter(item.transAmt)}}</div>
              <div class="td" align="center">{{chanFilter(item.chanCode)}}</div>
              <div class="td" align="center">{{transStatusFilter(item.transStatus)}}</div>
              <div class="td" align="center">{{refundStatusFilter(item.refundStatus)}}</div>
              <div class="td" align="center">{{item.transTime}}</div>
              <!-- <div class="td" align="center">{{item.updateTime}}</div> -->
            </div>
          </template>
        </div>
        <div class="tfoot">
          <div class="tr pagination">
            <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
          </div>
        </div>
      </div>
    </form>

  </template>
  <script>
    var TRANSTYPE_MAP = {
      1: '支付交易',
      2: '退款交易',
      7: '结算交易',
    };

    Polymer({
      is: 'bindingpay-trade-list',

      properties: {
        cond: {
          type: Object,
          value: function() {
            return {
              total: 0,
              page: 1,
              size: 20
            };
          }
        },
        time: {
          type: Object,
          value: function() {
            var startTime = moment();
            startTime.hour(0);
            startTime.minute(0);
            startTime.second(0);

            var endTime = moment();
            endTime.hour(23);
            endTime.minute(59);
            endTime.second(59);
            return {
              startTime: startTime.toDate(),
              startTimeString: moment(startTime).format('YYYY-MM-DD'),
              endTime: endTime.toDate(),
              endTimeString: moment(endTime).format('YYYY-MM-DD')
            }
          }
        },
        trades: {
          type: Array,
          value: []
        },
        busicd: {
          type: Object
        },
        busicds: {
          type: Array,
          value: (function() {
            var busicds = [],
              map = {};
            for (var k in TRANSTYPE_MAP) {
              if (!map[k.toUpperCase()]) {
                map[k.toUpperCase()] = TRANSTYPE_MAP[k];
              }
            }
            Object.keys(map).forEach(function(v) {
              busicds.push({
                key: v,
                value: map[v]
              });
            });
            return busicds;
          })()
        },
        transStatus: {
          type: Object
        },
        transStatusMap: {
          type: Array,
          value: [{
            key: '10',
            value: '处理中'
          }, {
            key: '20',
            value: '失败'
          }, {
            key: '30',
            value: '成功'
          }, {
            key: '40',
            value: '已关闭'
          }, {
            key: '50',
            value: '待支付'
          }]
        }
      },
      ready: function() {
        this.busicd = {};
        this.trades = [];
        this.transStatus = {};
        this.refundStatusMap = {
          1: '已退款',
          2: '部分退款',
          0: ''
        };
        this.tStatusMap = {
          '10': '处理中',
          '20': '失败',
          '30': '成功',
          '40': '已关闭'
        };
        this.chanMap = {
          'CIL': '讯联',
          'CFCA': '中金',
          'Mock': 'Mock'
        };
      },
      observers: [
        '_watchCondChange(cond.*)',
        '_watchTimeChanged(time.startTime, time.endTime)'
      ],
      _watchTimeChanged: function(startTime, endTime) {
        this.set('time.startTimeString', moment(startTime).format('YYYY-MM-DD'));
        this.set('time.endTimeString', moment(endTime).format('YYYY-MM-DD'));
        this.set('cond.startTime', Util.toCSTDateTime(moment(this.time.startTime).format('YYYY-MM-DD 00:00:00')));
        this.set('cond.endTime', Util.toCSTDateTime(moment(this.time.endTime).format('YYYY-MM-DD 23:59:59')));
      },
      _watchCondChange: function(newValue) {
        if (newValue.path !== 'cond.page') {
          this.set('cond.page', 1);
        }
        var t = new Date().format('yyyyMMdd-hhmmss');
        this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=报表_' + t + '.xlsx';
      },
      // 日期、时间控件
      dismissStartTimeDialog: function() {
        var startTime = this.$.startTimePicker.date;
        this.set('time.startTime', startTime);
      },
      showStartTimeDialog: function() {
        this.$.startTimeDailog.toggle();
      },
      dismissEndTimeDialog: function() {
        var endTime = this.$.endTimePicker.date;
        this.set('time.endTime', endTime);
      },
      showEndTimeDialog: function() {
        this.$.endTimeDailog.toggle();
      },
      queryAction: function() {
        this.$.formSearch.submit();
      },
      // 发送查询交易的ajax请求
      submitForm: function() {
        this.trades = [];
      },
      // ajax请求响应处理
      handleSearchResponse: function(e) {
        var response = e.detail;
        if (response.status !== 0) {
          Util.toast(response.message || '系统错误', 3000);
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }

        var pagination = response.data;
        if (!pagination.data || pagination.data.length === 0) {
          Util.toast('没有找到符合条件的数据', 3000);
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }

        this.trades = pagination.data.slice(0);
        this.set('cond.total', pagination.total);
        this.set('cond.page', pagination.page);
      },
      chanFilter: function(chanCode) {

        return this.chanMap[chanCode];
      },
      busicdFilter: function(busicd) {
        return TRANSTYPE_MAP[busicd] || busicd;
      },
      _currencyFilter: function(money) {
        return (money / 100).toFixed(2);
      },
      transStatusFilter: function(status) {

        return this.tStatusMap[status];
      },
      refundStatusFilter: function(status) {
        return this.refundStatusMap[status];
      },
      addOneFilter: function(index) {
        return index + 1;
      },
      // 应答码着色
      getRespCodeColor: function(value) {
        if (value === '000000') {
          return 'green';
        }
        if (value === '0000001') {
          return 'red';
        }
        return 'blue';
      },
      _computeRespCodeTooltipId: function(i) {
        return 'respCode' + i;
      }
    });
  </script>
</dom-module>

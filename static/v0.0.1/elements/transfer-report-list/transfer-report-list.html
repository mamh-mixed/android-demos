<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../x-form/x-form.html">

<dom-module id="transfer-report-list">
  <!-- 划款报表 -->
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/transfer/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <paper-input name="date" label="清算日期" on-tap="showSettDateDialog" value="{{cond.date::input}}" data-msg-id="SCANPAY_TRADE_SETTLE_REPORT.SETTLE_DATE"></paper-input>
        <paper-dialog with-backdrop id="settDateDialog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissSettDateDialog">
          <paper-date-picker id="settDatePicker" locale="ja" responsive-width="655px" locale-msg-id="DATE_PICKER.LOCALE"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>
                <i18n-msg msgid="BUTTON.CANCEL">取消</i18n-msg>
            </paper-button>
            <paper-button dialog-confirm>
                 <i18n-msg msgid="BUTTON.CONFIRM">确定</i18n-msg>
            </paper-button>
          </div>
        </paper-dialog>

        <!-- <x-select items="[[settRoles]]" name="settRole" selected-item="{{settRole}}" label="清算角色" disabled="{{agentDisabled}}" id="agentCode"></x-select> -->
        <x-select id="reportType" items="[[reportTypes]]" name="reportType" selected-item="{{reportType}}" label="报表类型" data-msg-id="TRANSFER_REPORT.REPORT_TYPE" is-locale></x-select>
        <paper-input label="清算角色" name="role" value="{{cond.role::input}}" data-msg-id="TRADE_DETAIL.SETT_ROLE"></paper-input>

        <paper-button class="colorful" raised on-tap="queryAction">
            <i18n-msg msgid="BUTTON.QUERY">查询</i18n-msg>
        </paper-button>
      </div>
      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th">
                <i18n-msg msgid="SCANPAY_TRADE_LIST.INDEX">序号</i18n-msg>
            </div>
            <div class="th">
                <i18n-msg msgid="SCANPAY_TRADE_SETTLE_REPORT.SETTLE_DATE">清算日期</i18n-msg>
            </div>
            <div class="th">
                <i18n-msg msgid="TRANSFER_REPORT.REPORT_TYPE">报表类型</i18n-msg>
            </div>
            <div class="th left">
                <i18n-msg msgid="TRADE_DETAIL.SETT_ROLE">清算角色</i18n-msg>
            </div>
            <div class="th left">
                <i18n-msg msgid="TRANSFER_REPORT.REPORT_NAME">报表名称</i18n-msg>
            </div>
            <div class="th">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.DOWNLOAD">下载</i18n-msg>
            </div>
          </div>
        </div>
        <div class='tbody'>
          <template is="dom-repeat" items="{{reports}}">
            <div class="tr">
              <div class="td center">{{addOneFilter(index)}}</div>
              <div class="td center">{{item.settDate}}</div>
              <div class="td center">{{reportTypeFilter(item.reportType)}}</div>
              <div class="td">{{item.settRole}}</div>
              <div class="td">{{item.reportName}}</div>
              <div class="td center">
                <a on-tap="handleDownloadReportEvent">
                    <i18n-msg msgid="TRANSFER_REPORT.REPORT">报表</i18n-msg>
                </a>
                <label hidden$="{{isHiddenDetail(item.reportType)}}">|</label>
                <a href="/master/trade/transfer/report?date={{item.settDate}}&role={{item.settRole}}&utcOffset={{cond.utcOffset}}" hidden$="{{isHiddenDetail(item.reportType)}}">
                    <i18n-msg msgid="TRANSFER_REPORT.REPORT_DETAIL">明细</i18n-msg>
                </a>
              </div>
            </div>
          </template>
        </div>
        <div class="tfoot">
          <div class="tr pagination">
            <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
          </div>
        </div>
      </div>
    </form>
    <x-ajax id="privateDownloadUrlAjax" url="/master/qiniu/download" handle-as="json" on-response="handlePrivateDownloadUrlAjaxResponse"></x-ajax>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'transfer-report-list',
        properties: {
          reports: {
            type: Array,
            value: []
          },
          cond: {
            type: Object,
            value: function() {
              var now = new Date();
              var yesterdayTime = now.getTime() - 1000 * 60 * 60 * 24;
              return {
                date: new Date(yesterdayTime).format('yyyy-MM-dd'),
                utcOffset: moment().utcOffset(),
                role: '',
                total: 0,
                page: 1,
                size: 20
              };
            }
          },
          reportTypes: {
            type: Array,
            value: [{
              key: 1,
              value: 'REPORT_TYPE.TRANSFER_MONEY'
            }, {
              key: 2,
              value: 'REPORT_TYPE.RECONCILIATION'
            }, {
              key: 3,
              value: 'REPORT_TYPE.AGENT_WATER'
            }, {
              key: 4,
              value: 'REPORT_TYPE.CHAN_MERCHANT'
            }, {
              key: 5,
              value: 'REPORT_TYPE.RECONCILIATION_INJUSTICE_LESS_CHAN_MER'
            }, {
              key: 6,
              value: 'REPORT_TYPE.RECONCILIATION_INJUSTICE_MORE_CHAN_MER'
            }, {
              key: 7,
              value: 'REPORT_TYPE.PROFIT'
            }]
          },
          reportType: Object
        },
        observers: [
          '_reportTypeChange(reportType)'
        ],
        _reportTypeChange: function(value) {
          if (value) {
            this.set('cond.reportType', value.key);
          }
        },
        ready: function() {
          this.reportTypeMap = {
            1: 'REPORT_TYPE.TRANSFER_MONEY',
            2: 'REPORT_TYPE.RECONCILIATION',
            3: 'REPORT_TYPE.AGENT_WATER',
            4: 'REPORT_TYPE.CHAN_MERCHANT',
            5: 'REPORT_TYPE.RECONCILIATION_INJUSTICE_LESS_CHAN_MER',
            6: 'REPORT_TYPE.RECONCILIATION_INJUSTICE_MORE_CHAN_MER',
            7: 'REPORT_TYPE.PROFIT'
          };
        },
        attached: function() {
            this.fire('rerender-i18n', {
              from: 'transfer-report-list'
            });
        },
        handleDownloadReportEvent: function(e) {
          var item = e.model.item;
          this.$.privateDownloadUrlAjax.params = {
            key: item.reportName
          };
          this.$.privateDownloadUrlAjax.generateRequest();
        },
        handlePrivateDownloadUrlAjaxResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          var a = document.createElement('a');
          a.setAttribute('href', response.message);
          a.setAttribute('target', 'iframeForDownload');

          var evt = document.createEvent('MouseEvent');
          evt.initEvent('click', true, true);
          a.dispatchEvent(evt);
        },
        queryAction: function() {
          this.$.formSearch.submit();
        },
        // 发送查询交易的ajax请求
        submitForm: function() {
          this.trades = [];
        },
        // ajax请求响应处理
        handleSearchResponse: function(e) {
          var response = e.detail;
          if (response.status !== 0) {
            Util.toast('SCANPAY_TRADE_LIST.TOAST.SYSTEM_ERROR', 3000, true);
            return;
          }
          var pagination = e.detail.data;

          this.reports = pagination.data.slice(0);
          this.set('cond.total', pagination.total);
          this.set('cond.page', pagination.page);

          if (this.reports.length === 0) {
            Util.toast('SCANPAY_TRADE_LIST.TOAST.NOT_FOUND', 3000, true);
          }
        },
        addOneFilter: function(index) {
          return index + 1;
        },
        // 日期、时间控件
        dismissSettDateDialog: function() {
          var date = this.$.settDatePicker.date;
          this.set('cond.date', this.$.settDatePicker.dateFormat(date, 'YYYY-MM-DD'));
        },
        showSettDateDialog: function() {
          this.$.settDateDialog.toggle();
        },
        isHiddenDetail: function(reportType) {
          if (reportType === 0 || reportType === 1) {
            return false;
          }
          return true;
        },
        reportTypeFilter: function(reportType) {
          var i18nMsg = document.createElement('i18n-msg');
          return i18nMsg.getMsg(this.reportTypeMap[reportType]);
        }
      });
    })();
  </script>
</dom-module>

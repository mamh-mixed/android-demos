<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../x-form/x-form.html">

<dom-module id="settle-report-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/settle/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <paper-input name="date" label="清算日期" on-tap="showSettDateDialog" value="{{cond.date::input}}" data-msg-id="SCANPAY_TRADE_SETTLE_REPORT.SETTLE_DATE"></paper-input>
        <paper-dialog with-backdrop id="settDateDialog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissSettDateDialog">
          <paper-date-picker id="settDatePicker" locale="zh-cn" responsive-width="655px"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>
              <i18n-msg msgid="BUTTON.CANCEL">取消</i18n-msg>
            </paper-button>
            <paper-button dialog-confirm>
              <i18n-msg msgid="BUTTON.CONFIRM">确定</i18n-msg>
            </paper-button>
          </div>
        </paper-dialog>
        <paper-button class="colorful" raised on-tap="redoSettle" hidden$="{{ !_isAdmin(userType) }}">
          <i18n-msg msgid="SCANPAY_TRADE_SETTLE_REPORT.REDO_SETTLE">重跑</i18n-msg>
        </paper-button>
        <div class="paper-button-1">
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href$="{{summaryReportUrl}}">
            <i18n-msg msgid="SCANPAY_TRADE_SETTLE_REPORT.DOWNLOAD_SUMMARY_REPORT">下载汇总报表</i18n-msg>
          </a>
        </div>
        <div class="paper-button-1">
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href$="{{detailReportUrl}}">
            <i18n-msg msgid="SCANPAY_TRADE_SETTLE_REPORT.DOWNLOAD_DETAIL_REPORT">下载明细报表</i18n-msg>
          </a>
        </div>
      </div>
    </form>
    <iron-localstorage name="USERTYPE" value="{{userType}}"></iron-localstorage>
    <x-ajax id="redoSettleAjax" method="POST" url="/master/trade/settle/refresh" handle-as="json" on-response="handleRedoSettleAjaxResponse"></x-ajax>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'settle-report-list',

        properties: {
          reports: {
            type: Array,
            value: []
          },
          cond: {
            type: Object,
            value: function() {
              var now = new Date();
              var yesterdayTime = now.getTime() - 1000 * 60 * 60 * 24;
              return {
                date: new Date(yesterdayTime).format('yyyy-MM-dd'),
                utcOffset: moment().utcOffset()
              };
            }
          }
        },
        ready: function() {},
        attached: function() {
          this.fire('rerender-i18n', {
            from: 'settle-report-list'
          });
        },
        observers: [
          '_watchConditionChange(cond.*)'
        ],
        _watchConditionChange: function() {
          var detailReportUrl = '/master/trade/settle/journal?' + Util.query(this.cond),
            summaryReportUrl = '/master/trade/settle/report?' + Util.query(this.cond);

          this.set('detailReportUrl', detailReportUrl);
          this.set('summaryReportUrl', summaryReportUrl);
        },
        // 重跑清算
        redoSettle: function() {

        },
        handleRedoSettleAjaxResponse: function(e) {

        },
        // 日期、时间控件
        dismissSettDateDialog: function() {
          var date = this.$.settDatePicker.date;
          this.set('cond.date', this.$.settDatePicker.dateFormat(date, 'YYYY-MM-DD'));
        },
        showSettDateDialog: function() {
          this.$.settDateDialog.toggle();
        },
        _isAdmin: function (type) {
          return false;
          // return type && type === 'admin';
        }
      });
    })();
  </script>
</dom-module>

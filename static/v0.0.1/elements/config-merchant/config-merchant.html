<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../x-select/x-select.html">

<dom-module id="config-merchant">
  <style>
    :host {
      display: block;
      --paper-tab-ink: #eee;
      --paper-tabs-selection-bar-color: #eee;
      /*--default-primary-color: #00BCD4;*/
      --text-primary-color: #ffffff;
      --paper-checkbox-label-spacing: 4px;
    }

    paper-tabs {
      background-color: var(--default-primary-color);
      color: var(--text-primary-color);
      box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.2);
    }

    paper-tabs[noink][no-bar] paper-tab.iron-selected {
      color: #ffff8d;
    }

    paper-tabs[align-bottom] {
      box-shadow: 0px -2px 6px rgba(0, 0, 0, 0.15);
    }

    iron-pages section {}

    .row {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
    }

    .row > .col {
      @apply(--layout-flex-6);
      margin: 0 20px;
    }

    .row.button {
      margin: 20px 0;
    }

    .row paper-input,
    .row pre,
    .row label,
    .row paper-textarea,
    .row paper-checkbox,
    .row paper-radio-button,
    .row .check-box-group,
    .row channel-merchant-typeahead,
    .row section,
    .row x-select {
      @apply(--layout-flex-6);
      margin-right: 20px;
    }

    .row paper-input:last-child,
    .row pre:last-child,
    .row label:last-child,
    .row paper-textarea:last-child,
    .row paper-checkbox:last-child,
    .row paper-radio-button:last-child,
    .row channel-merchant-typeahead:last-child,
    .row .check-box-group:last-child,
    .row section:last-child,
    .row x-select:last-child {
      margin-right: 0;
    }

    paper-checkbox,
    paper-radio-button {
      padding-top: 20px;
      margin-right: 20px;
    }

    .check-box-group > label {
      color: #727272;
      font-family: 'Menlo', '微软雅黑', 'monospace', '黑体', 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 12px;
      font-weight: 400;
      line-height: 24px;
    }

    .check-box-area paper-checkbox {
      padding-top: 0;
    }

    paper-button.colorful {
      background: var(--dark-primary-color);
      color: var(--text-primary-color);
    }

    paper-textarea,
    paper-input,
    .validate-container {
      position: relative;
    }

    paper-textarea[required]::after,
    paper-input[required]::after,
    .validate-container[required]::after {
      content: "*";
      color: #F00;
      display: block;
      position: absolute;
      left: -10px;
      top: 50%;
    }

    .monospace {
      --paper-input-container-input: {
        font-family: monospace;
        font-size: 8px;
      }
    }

    paper-button.cycan {
      background-color: #EA191E !important;
      color: #fff;
    }
  </style>
  <template>
    <paper-tabs selected="{{idx}}">
      <paper-tab>
        <i18n-msg msgid="MERCHANT_INPUT.TAB_MERCHANT_INFO">门店信息</i18n-msg>
      </paper-tab>
      <paper-tab>
        <i18n-msg msgid="MERCHANT_INPUT.TAB_ALIPAY">支付宝</i18n-msg>
      </paper-tab>
      <paper-tab>
        <i18n-msg msgid="MERCHANT_INPUT.TAB_WXP">微信</i18n-msg>
      </paper-tab>
      <!-- <paper-tab>
        <i18n-msg msgid="MERCHANT_INPUT.TAB_QQ_WALLET">QQ 钱包</i18n-msg>
      </paper-tab>
      <paper-tab>
        <i18n-msg msgid="MERCHANT_INPUT.TAB_ULIVE">优方</i18n-msg>
      </paper-tab> -->
    </paper-tabs>

    <iron-pages selected="{{idx}}">
      <section alias="merchant">
        <div class="row">
          <x-select items="[[agents]]" name="agent" selected-item="{{agent}}" label="代理" data-msg-id="SCANPAY_TRADE_LIST.AGENT"></x-select>
          <paper-input label="代理代码" value="{{merchant.agentCode::input}}" data-msg-id="TRADE_DETAIL.AGENT_NO" readonly></paper-input>
        </div>
        <div class="row">
          <x-select items="[[subAgents]]" name="subAgent" selected-item="{{subAgent}}" label="公司" data-msg-id="GROUP.SUB_AGENT"></x-select>
          <paper-input label="公司代码" value="{{merchant.subAgentCode::input}}" data-msg-id="SCANPAY_TRADE_LIST.SUBAGENT_NO" readonly></paper-input>
        </div>
        <div class="row">
          <x-select items="[[groups]]" name="group" selected-item="{{group}}" label="商户" data-msg-id="GROUP.GROUP"></x-select>
          <paper-input label="商户代码" value="{{merchant.groupCode::input}}" data-msg-id="SCANPAY_TRADE_LIST.GROUP_NO" readonly></paper-input>
        </div>
        <div class="row">
          <paper-input id="merId" label="门店代码" value="{{merchant.merId::input}}" disabled$="{{update}}" required error-message="必填项" data-msg-id="SCANPAY_TRADE_LIST.MERCHANT_NO" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input id="merName" label="门店名称" value="{{merchant.detail.merName::input}}" required error-message="必填项" data-msg-id="SCANPAY_TRADE_LIST.MERCHANT_NAME" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>
        <div class="row">
          <paper-radio-button id="isNeedSignCheck" checked$="{{merchant.isNeedSign}}" on-change="handleIsNeedSignChangeEvent" style="width:800px;">
            <i18n-msg msgid="MERCHANT.IS_NEED_SIGN_CHECK">是否开启验签</i18n-msg>
          </paper-radio-button>
          <div class="col">
            <div class="layout horizontal center">
              <paper-input class="flex left" id="signKey" label="门店签名密钥" value="{{merchant.signKey::input}}" error-message="必填项" data-msg-id="MERCHANT.SIGNKEY" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
              <paper-button class="cycan" raised on-tap="handleRefreshSignKeyTapped">
                <i18n-msg msgid="BUTTON.REFRESH">刷新</i18n-msg>
              </paper-button>
            </div>
          </div>
        </div>

        <div class="row">
          <paper-input label="开户账户" value="{{merchant.detail.acctNum::input}}" data-msg-id="MERCHANT.ACCTNUM"></paper-input>
          <paper-input label="开户姓名" value="{{merchant.detail.acctName::input}}" data-msg-id="MERCHANT.ACCTNAME"></paper-input>
        </div>
        <div class="row">
          <paper-input label="开户行号" value="{{merchant.detail.bankId::input}}" data-msg-id="MERCHANT.BANKID"></paper-input>
          <paper-input label="支行名称" value="{{merchant.detail.openBankName::input}}" data-msg-id="MERCHANT.OPENBANKNAME"></paper-input>
        </div>
        <div class="row">
          <paper-input label="开户行名称" value="{{merchant.detail.bankName::input}}" data-msg-id="MERCHANT.BANKNAME"></paper-input>
          <paper-input label="门店交易币种" value="{{merchant.transCurr::input}}" data-msg-id="MERCHANT.TRANSCURR"></paper-input>
        </div>
        <div class="row">
          <paper-input label="省份" value="{{merchant.detail.province::input}}" data-msg-id="MERCHANT.PROVINCE"></paper-input>
          <paper-input label="城市" value="{{merchant.detail.city::input}}" data-msg-id="MERCHANT.CITY"></paper-input>
        </div>

        <div class="row">
          <paper-input id="commodityName" label="商品名称" value="{{merchant.detail.commodityName::input}}" required error-message="必填项" data-msg-id="MERCHANT.COMMODITYNAME" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input label="商品标签" value="{{merchant.detail.goodsTag::input}}" data-msg-id="MERCHANT.GOODSTAG"></paper-input>
        </div>
        <div class="row">
          <paper-input label="门店类型" value="{{merchant.detail.shopType::input}}" data-msg-id="MERCHANT.SHOPTYPE"></paper-input>
          <paper-input label="门店ID" value="{{merchant.detail.shopID::input}}" data-msg-id="MERCHANT.SHOPID"></paper-input>
        </div>
        <div class="row">
          <paper-input label="品牌编号" value="{{merchant.detail.brandNum::input}}" data-msg-id="MERCHANT.BRANDNUM"></paper-input>
          <paper-radio-button id="isNeedPostAmountAfterSuccess" checked$="{{merchant.detail.isPostAmount}}" on-change="handleIsNeedPostAmountChangeEvent" style="width:800px;">
            <i18n-msg msgid="MERCHANT.ISPOSTAMOUNT">支付成功后是否传送金额到自定义连接</i18n-msg>
          </paper-radio-button>
        </div>
        <div class="row">
          <paper-input label="标题一" value="{{merchant.detail.titleOne::input}}" data-msg-id="MERCHANT.TITLEONE"></paper-input>
          <paper-input label="标题二" value="{{merchant.detail.titleTwo::input}}" data-msg-id="MERCHANT.TITLETWO"></paper-input>
        </div>
        <div class="row">
          <paper-input label="支付成功后的按钮文本" value="{{merchant.detail.succBtnTxt::input}}" data-msg-id="MERCHANT.SUCC_BTN_TXT"></paper-input>
          <paper-input label="支付成功后的按钮连接" value="{{merchant.detail.succBtnLink::input}}" data-msg-id="MERCHANT.SUCC_BTN_LINK"></paper-input>
        </div>
        <div class="row">
          <paper-input label="JS支付版本" value="{{merchant.jsPayVersion::input}}" data-msg-id="MERCHANT.JS_PAY_VERSION"></paper-input>
        </div>
        <div class="row">
          <x-select label="门店状态" id="merStatus" items="[[merStatusMap]]" selected-item="{{merStatus}}" class="validate-container" error-message="必填项" required data-msg-id="MERCHANT.MER_STATUS" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM" is-locale></x-select>
          <paper-input label="备注信息" value="{{merchant.remark::input}}" data-msg-id="MERCHANT.REMARK"></paper-input>
        </div>
        <div>
          <label for="permissionGroup">
            <i18n-msg msgid="MERCHANT.PERMISSION_GROUP">接口权限</i18n-msg>：</label>
          <template id="permissionRepeatDom" is="dom-repeat" items="{{permissionArray}}">
            <paper-checkbox checked$="{{item.isChecked}}" on-change="handlePermissionChangeEvent">
              <span>
                <i18n-msg msgid$="{{getPermission(item.key)}}">{{item.value}}</i18n-msg>
              </span>
            </paper-checkbox>
          </template>
        </div>

        <div class="row button">
          <paper-button class="colorful" raised on-tap="handleSaveMerchantTapped">
            <i18n-msg msgid="{{BUTTON.SAVE_MERCHANT}}">保存门店信息</i18n-msg>
          </paper-button>
        </div>
      </section>

      <section alias="alipay">
        <div class="row">
          <paper-input id="achanMerId" label="Partner ID" value="{{alipay.chanMerId::input}}" required error-message="必填项" on-blur="_partnerIdChange" data-msg-id="CHAN_MERCHANT.CHAN_MER_ID" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input label="支付宝商户名称" value="{{alipay.chanMerName::input}}" data-msg-id="CHAN_MERCHANT.CHAN_MER_NAME"></paper-input>
        </div>
        <div class="row">
          <paper-input id="aacqFee" label="讯联跟渠道费率" value="{{alipayRoute.acqFee::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.ACQFEE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input id="amerFee" label="门店跟讯联费率" value="{{alipayRoute.merFee::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.MERFEE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>
        <div class="row">
          <x-select id="asettFlag" items="[[settFlags]]" selected-item="{{asettFlag}}" class="validate-container" label="清算标识" required error-message="必填项" data-msg-id="CHAN_MERCHANT.SETTFLAG" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></x-select>
          <paper-input id="asettRole" label="清算角色" value="{{alipayRoute.settRole::input}}" required error-message="必填项" data-msg-id="ROUTE_POLICY.SETTROLE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>
        <div class="row">
          <paper-input id="asignCert" label="MD5 KEY" value="{{alipay.signCert::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.SIGN_CERT" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <x-select id="aagentCode" items="[[aagentCodes]]" selected-item="{{aagentCode}}" class="validate-container" label="代理" required error-message="必填项" data-msg-id="SCANPAY_TRADE_LIST.AGENT" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></x-select>
        </div>
        <div class="row button">
          <paper-button class="colorful" raised on-tap="handleSaveALPTapped">
            <i18n-msg msgid="BUTTON.SAVE_ALP">保存支付宝信息</i18n-msg>
          </paper-button>
        </div>
      </section>

      <section alias="tenpay">
        <div class="row">
          <paper-input id="wchanMerId" label="微信商户号" value="{{weixin.chanMerId::input}}" required error-message="必填项" on-blur="_wchanMerIdChange" data-msg-id="CHAN_MERCHANT.CHAN_MER_ID" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input label="微信商户名称" value="{{weixin.chanMerName::input}}" data-msg-id="CHAN_MERCHANT.CHAN_MER_NAME"></paper-input>
        </div>
        <div class="row">
          <paper-radio-button id="isAgentMode" checked$="{{weixin.isAgentMode}}" on-change="handleIsAgentChangeEvent">
            <i18n-msg msgid="CHAN_MERCHANT.IS_AGENT_MODE">是否代理商模式</i18n-msg>
          </paper-radio-button>
          <x-select id="bigChanMerId" items="[[wbigchanMerIds]]" selected-item="{{wbigchanMerId}}" class="validate-container" label="大商户号" required error-message="必填项" disabled="[[wbigchanMerIdDisabled]]" data-msg-id="CHAN_MERCHANT.BIG_MERCHANT" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></x-select>
        </div>
        <div class="row">
          <paper-input id="wacqFee" label="讯联跟渠道费率" value="{{weixinRoute.acqFee::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.ACQFEE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input id="wmerFee" label="门店跟讯联费率" value="{{weixinRoute.merFee::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.MERFEE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>
        <div class="row">
          <x-select id="wsettFlag" items="[[settFlags]]" selected-item="{{wsettFlag}}" class="validate-container" label="清算标识" required error-message="必填项" data-msg-id="CHAN_MERCHANT.SETTFLAG" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></x-select>
          <paper-input id="wsettRole" label="清算角色" value="{{weixinRoute.settRole::input}}" required error-message="必填项" data-msg-id="ROUTE_POLICY.SETTROLE" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>
        <div class="row">
          <paper-input id="wxpAppId" label="微信 AppId" value="{{weixin.wxpAppId::input}}" error-message="必填项" data-msg-id="CHAN_MERCHANT.WXP_APP_ID" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input id="wsignCert" label="签名密钥" value="{{weixin.signCert::input}}" error-message="必填项" data-msg-id="CHAN_MERCHANT.SIGN_CERT_WXP" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
        </div>

        <div class="row">
          <section>
            <label id="httpCertL">
              <i18n-msg msgid="CHAN_MERCHANT.HTTP_CERT_LABEL">请选择.pem文件的HTTP证书</i18n-msg>
            </label>
            <paper-input id="httpCert" type="file" on-change="handleWeixinHttpCertFile"></paper-input>
            <paper-textarea class="monospace" id="httpCertTArea" label="HTTP 证书" value="{{weixin.httpCert::input}}" error-message="必填项" data-msg-id="CHAN_MERCHANT.HTTP_CERT" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-textarea>
          </section>
          <section>
            <label id="httpKeyL">
              <i18n-msg msgid="CHAN_MERCHANT.HTTP_KEY_LABEL">请选择.pem文件的HTTP密钥</i18n-msg>
            </label>
            <paper-input id="httpKey" type="file" on-change="handleWeixinHttpKeyFile"></paper-input>
            <paper-textarea class="monospace" id="httpKeyTArea" label="HTTP 密钥" value="{{weixin.httpKey::input}}" error-message="必填项" data-msg-id="CHAN_MERCHANT.HTTP_KEY" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-textarea>
          </section>
        </div>

        <div class="row button">
          <paper-button class="colorful" raised on-tap="handleSaveWXPTapped">
            <i18n-msg msgid="BUTTON.SAVE_WXP">保存微信信息</i18n-msg>
          </paper-button>
        </div>
      </section>

      <!-- <section alias="comingsoon">
        <div class="row">
          <paper-input label="即将上线。。。" value="" data-msg-id="CHAN_MERCHANT.COMMING_SOON"></paper-input>
        </div>
      </section>

      <section alias="ulive">
        <div class="row">
          <paper-input id="uliveChanMerId" label="渠道商户号" value="{{ulive.chanMerId::input}}" required error-message="必填项" data-msg-id="CHAN_MERCHANT.CHAN_MER_ID" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
          <paper-input id="uliveChanMerName" label="渠道商户名称" value="{{ulive.chanMerName::input}}" data-msg-id="CHAN_MERCHANT.CHAN_MER_NAME"></paper-input>
        </div>
        <div class="row">
          <paper-input id="uliveTerminalId" label="终端号" value="{{ulive.terminalId::input}}" data-msg-id="CHAN_MERCHANT.TERMINAL_ID"></paper-input>
          <paper-input label="Input label" hidden></paper-input>
        </div>
        <div class="row button">
          <paper-button class="colorful" raised on-tap="handleSaveUliveapped">
            <i18n-msg msgid="BUTTON.SAVE_ULIVE">保存优方信息</i18n-msg>
          </paper-button>
        </div>
      </section> -->
    </iron-pages>
    <x-ajax id="saveMerchantAjax" method="POST" url="/master/merchant/save" handle-as="json" debounce-duration="1000" on-response="handleSaveMerchantResponse"></x-ajax>
    <x-ajax id="updateMerchantAjax" method="POST" url="/master/merchant/update" handle-as="json" debounce-duration="1000" on-response="handleUpdateMerchantResponse"></x-ajax>
    <x-ajax id="saveChannelMerchantAjax" method="POST" url="/master/channelMerchant/save" handle-as="json" debounce-duration="1000" on-response="handleSaveChannelMerchantResponse"></x-ajax>
    <x-ajax id="saveRouterAjax" method="POST" url="/master/router/save" handle-as="json" debounce-duration="1000" on-response="handleSaveRouterResponse"></x-ajax>

    <x-ajax id="queryMerchantAjax" method="GET" url="/master/merchant/one" handle-as="json" debounce-duration="1000" on-response="handleQueryMerchantResponse"></x-ajax>
    <x-ajax id="alpChanMerAjax" method="GET" url="/master/channelMerchant/findByMerIdAndCardBrand" handle-as="json" debounce-duration="1000" on-response="handleAlpChanMerResponse"></x-ajax>
    <x-ajax id="wxpChanMerAjax" method="GET" url="/master/channelMerchant/findByMerIdAndCardBrand" handle-as="json" debounce-duration="1000" on-response="handleWxpChanMerResponse"></x-ajax>
    <x-ajax id="uliveChanMerAjax" method="GET" url="/master/channelMerchant/findByMerIdAndCardBrand" handle-as="json" debounce-duration="1000" on-response="handleUliveChanMerResponse"></x-ajax>
    <x-ajax id="findChanMerAjax" method="GET" url="/master/channelMerchant/find" handle-as="json" debounce-duration="1000" on-response="handleFindChanMerResponse"></x-ajax>
    <x-ajax id="findChanMerAlpAjax" method="GET" url="/master/channelMerchant/find" handle-as="json" debounce-duration="1000" on-response="handleFindChanMerAlpResponse"></x-ajax>
    <x-ajax id="findChanMerWeixinAjax" method="GET" url="/master/channelMerchant/find" handle-as="json" debounce-duration="1000" on-response="handleFindChanMerWeixinResponse"></x-ajax>
    <x-ajax id="findRouterAlpAjax" method="GET" url="/master/router/one" handle-as="json" debounce-duration="1000" on-response="handleFindRouterAlpResponse"></x-ajax>
    <x-ajax id="findRouterWeixinAjax" method="GET" url="/master/router/one" handle-as="json" debounce-duration="1000" on-response="handleFindRouterWeixinResponse"></x-ajax>
    <x-ajax id="queryAgentAjax" auto params='{"page":"1", "size":"1000"}' method="GET" url="/master/agent/find" handle-as="json" debounce-duration="1000" on-response="handleQueryAgentsResponse"></x-ajax>
    <x-ajax id="querySubAgentAjax" method="GET" url="/master/subAgent/find" handle-as="json" debounce-duration="1000" on-response="handleQuerySubAgentsResponse"></x-ajax>
    <x-ajax id="queryGroupAjax" method="GET" url="/master/group/find" handle-as="json" debounce-duration="1000" on-response="handleQueryGroupsResponse"></x-ajax>
  </template>
  <script>
    var chars = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j',
      'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'
    ];

    function generateMixed(n) {
      var res = '';
      for (var i = 0; i < n; i++) {
        var id = Math.ceil(Math.random() * 61);
        res += chars[id];
      }
      return res;
    }
    Polymer({
      is: 'config-merchant',
      attached: function() {
        this.fire('rerender-i18n', {
          from: 'config-merchant'
        });
      },
      properties: {
        merId: {
          type: String,
          reflectToAttribute: true
        },
        update: {
          type: Boolean,
          value: false,
          notify: true
        },
        bigMerchant: {
          type: Object
        },
        params: {
          type: Object
        },
        merStatusMap: {
          type: Array,
          value: [{
            key: 'Normal',
            value: 'MERCHANT.NORMAL'
          }, {
            key: 'Test',
            value: 'MERCHANT.TEST'
          }, {
            key: 'Deleted',
            value: 'MERCHANT.DELETED'
          }]
        },
        // 微信大商户集合，目前是2个
        wbigchanMerIds: {
          type: Array,
          value: [{
            key: '1301344001',
            value: '華銀 1301344001'
          }]
        },
        wbigchanMerId: {
          type: Object,
          observer: '_wbigchanMerIdChanged'
        },
        // 支付宝代理
        aagentCodes: {
          type: Array,
          value: [{
            key: '12010128a1',
            value: '讯联 12010128a1'
          }, {
            key: '11719712a1',
            value: '天奕通 11719712a1'
          }]
        },
        aagentCode: {
          type: Object,
          observer: '_aagentCodeChanged'
        },
        settFlags: {
          type: Object,
          value: [{
            key: 'CHANNEL',
            value: 'CHANNEL'
          }, {
            key: 'CIL',
            value: 'CIL'
          }, {
            key: 'AGENT',
            value: 'AGENT'
          }, {
            key: 'COMPANY',
            value: 'COMPANY'
          }, {
            key: 'GROUP',
            value: 'GROUP'
          }]
        },
        asettRole: Object,
        wsettRole: Object,
        agent: Object,
        subAgent: Object,
        group: Object
      },
      observers: [
        '_watchMerStatusChange(merStatus.key)',
        '_isAgentModeChanged(weixin.isAgentMode)',
        '_asettFlagChange(asettFlag)',
        '_wsettFlagChange(wsettFlag)',
        '_isNeedSignChange(merchant.isNeedSign)',
        '_agentChange(agent)',
        '_subAgentChange(subAgent)',
        '_groupChange(group)',
      ],
      _agentChange: function(value) {
        if (value && value.key) {
          this.set("merchant.agentCode", value.key);
          this.set("merchant.agentName", value.value);
          this.magentCode = value.key;
          this.$.querySubAgentAjax.params = {
            page: '1',
            size: '1000',
            agentCode: value.key,
          };
          this.$.querySubAgentAjax.generateRequest();
          this.$.queryGroupAjax.params = {
            page: '1',
            size: '1000',
            agentCode: this.magentCode,
          };
          this.$.queryGroupAjax.generateRequest();
        } else {
          this.magentCode = '';
          this.set("merchant.agentCode", '');
          this.set("merchant.agentName", '');
          this.set('subAgents', []);
          this.set('subAgent', {});
          this.set('groups', []);
          this.set('group', {});
        }
      },
      _subAgentChange: function(value) {
        if (value && value.key) {
          this.set("merchant.subAgentCode", value.key);
          this.set("merchant.subAgentName", value.value);
          this.$.queryGroupAjax.params = {
            page: '1',
            size: '1000',
            agentCode: this.magentCode,
            subAgentCode: value.key,
          };
          this.$.queryGroupAjax.generateRequest();
        } else {
          if (this.magentCode != '') {
            this.$.queryGroupAjax.params = {
              page: '1',
              size: '1000',
              agentCode: this.magentCode,
            };
            this.$.queryGroupAjax.generateRequest();
          } else {
            this.set('groups', []);
            this.set('group', {});
          }
          this.set("merchant.subAgentCode", '');
          this.set("merchant.subAgentName", '');

        }

      },
      _groupChange: function(value) {
        if (value && value.key) {
          this.set("merchant.groupCode", value.key);
          this.set("merchant.groupName", value.value);
        } else {
          this.set("merchant.groupCode", '');
          this.set("merchant.groupName", '');
        }
      },
      _isAgentModeChanged: function(value) {
        if (value) {
          this.$.bigChanMerId.setAttribute('required', true);
          this.wbigchanMerIdDisabled = false;
          this.$.wxpAppId.removeAttribute('required');
          this.$.wsignCert.removeAttribute('required');
          this.$.httpCertTArea.removeAttribute('required');
          this.$.httpKeyTArea.removeAttribute('required');
          this.$.wxpAppId.validate();
          this.$.wsignCert.validate();
          this.$.httpCertTArea.validate();
          this.$.httpKeyTArea.validate();
        } else {
          this.$.bigChanMerId.removeAttribute('required');
          this.wbigchanMerIdDisabled = true;
          this.$.wxpAppId.setAttribute('required', true);
          this.$.wsignCert.setAttribute('required', true);
          this.$.httpCertTArea.setAttribute('required', true);
          this.$.httpKeyTArea.setAttribute('required', true);
        }
      },
      _partnerIdChange: function(e) {
        if (!e.target.value) {
          return;
        }
        this.$.findChanMerAlpAjax.params = {
          page: 1,
          chanMerId: e.target.value,
          chanCode: 'ALP'
        };
        this.$.findChanMerAlpAjax.generateRequest();
        this.alpUpdate = false;
      },
      _wchanMerIdChange: function(e) {
        if (!e.target.value) {
          return;
        }
        this.$.findChanMerWeixinAjax.params = {
          page: 1,
          chanMerId: e.target.value,
          chanCode: 'WXP'
        };
        this.$.findChanMerWeixinAjax.generateRequest();
        this.wxpUpdate = false;
      },
      // 选择大商户号
      _wbigchanMerIdChanged: function(value) {
        if (this.bigMerchantMap && value && value.key) {
          this.set('bigMerchant', this.bigMerchantMap[value.key]);
          if (!this.bigMerchant) {
            this.$.findChanMerAjax.params = {
              page: 1,
              chanMerId: value.key
            };
            this.$.findChanMerAjax.generateRequest();
          }
        }

      },
      // 支付宝选择代理
      _aagentCodeChanged: function(value) {
        if (value) {
          this.set('alipay.agentCode', value.key);
        }
      },
      // 支付宝清算标识改变
      _asettFlagChange: function(value) {
        if (value) {
          if (value.key === 'CHANNEL') {
            this.set('alipayRoute.settRole', 'ALP');
          } else if (value.key === 'CIL') {
            this.set('alipayRoute.settRole', 'CIL');
          } else if (value.key === 'AGENT') {
            this.set('alipayRoute.settRole', this.merchant.agentCode);
          } else if (value.key === 'COMPANY') {
            this.set('alipayRoute.settRole', this.merchant.subAgenCode);
          } else if (value.key === 'GROUP') {
            this.set('alipayRoute.settRole', this.merchant.groupCode);
          }
        } else {
          this.set('alipayRoute.settRole', '');
        }
      },
      // 微信清算标识改变
      _wsettFlagChange: function(value) {
        if (value) {
          if (value.key === 'CHANNEL') {
            this.set('weixinRoute.settRole', 'WXP');
          } else if (value.key === 'CIL') {
            this.set('weixinRoute.settRole', 'CIL');
          } else if (value.key === 'AGENT') {
            this.set('weixinRoute.settRole', this.merchant.agentCode);
          } else if (value.key === 'COMPANY') {
            this.set('weixinRoute.settRole', this.merchant.subAgenCode);
          } else if (value.key === 'GROUP') {
            this.set('weixinRoute.settRole', this.merchant.groupCode);
          }
        } else {
          this.set('weixinRoute.settRole', '');
        }
      },
      // 是否需要验签改变事件
      _isNeedSignChange: function(value) {
        if (value) {
          this.$.signKey.setAttribute('required', true);
        } else {
          this.$.signKey.removeAttribute('required');
          this.$.signKey.validate();
        }
      },
      attributeChanged: function() {
        this.alpUpdate = false;
        this.wxpUpdate = false;
        if (!this.merId) {
          return;
        }
        this.update = true;
        // this.set('merchant', {});
        // this.set('alipay', {});
        // this.set('weixin', {});

        // 根据merId查找商户信息
        var params = {
          merId: this.merId
        };
        this.$.queryMerchantAjax.params = params;
        this.$.queryMerchantAjax.generateRequest();

        // 根据merId查找支付宝渠道信息
        var alpParams = {
          merId: this.merId,
          cardBrand: 'ALP'
        };
        this.$.alpChanMerAjax.params = alpParams;
        this.$.alpChanMerAjax.generateRequest();

        // 根据merId查找微信渠道信息
        var wxpParams = {
          merId: this.merId,
          cardBrand: 'WXP'
        };
        this.$.wxpChanMerAjax.params = wxpParams;
        this.$.wxpChanMerAjax.generateRequest();

        // 根据merId查找支付宝路由信息
        this.$.findRouterAlpAjax.params = {
          merId: this.merId,
          cardBrand: 'ALP'
        };
        this.$.findRouterAlpAjax.generateRequest();

        // 根据merId查找渠道路由信息
        this.$.findRouterWeixinAjax.params = {
          merId: this.merId,
          cardBrand: 'WXP'
        };
        this.$.findRouterWeixinAjax.generateRequest();

        // 根据merId查找优方渠道信息
        this.$.uliveChanMerAjax.params = {
          merId: this.merId,
          cardBrand: 'ULIVE'
        };
        this.$.uliveChanMerAjax.generateRequest();

      },
      // 编辑的时候查询一个商户的响应事件
      handleQueryMerchantResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('MERCHANT_INPUT.SELECT_MERCHANT_ERROR', 3000, true);
          return;
        }

        var item = response.data;
        this.set('merchant', item);
        if (this.merchant) {
          this.oldSignKey = this.merchant.signKey;
        }
        this.agent = {
          key: this.merchant.agentCode,
          value: this.merchant.agentName,
        };
        this.subAgent = {
          key: this.merchant.subAgentCode,
          value: this.merchant.subAgentName,
        };
        this.group = {
          key: this.merchant.groupCode,
          value: this.merchant.groupName,
        };
        if (item.permission) {
          var permissions = item.permission;
          // 遍历当前商户的权限列表，把它们映射到this.permissionArray上，然后在页面上展示
          for (var i = 0, il = permissions.length; i < il; i++) {
            var p = permissions[i];
            for (var j = 0, jl = this.permissionArray.length; j < jl; j++) {
              var pa = this.permissionArray[j];
              if (pa.key === p) {
                this.set('permissionArray.' + j + '.isChecked', true);
                break;
              }
            }
          }
        } else {
          // 如果商户权限未定义的话，设置未空数组，防止保存的时候权限信息没有传到后台
          this.set('merchant.permission', []);
        }

        // 显示商户的状态
        var tempMerStatusMap = {
          'Normal': 'MERCHANT.NORMAL',
          'Test': 'MERCHANT.TEST',
          'Deleted': 'MERCHANT.DELETED'
        };
        var i18nMsg = document.createElement('i18n-msg');
        this.merStatus = {
          key: item.merStatus,
          value: i18nMsg.getMsg(tempMerStatusMap[item.merStatus])
        };

      },
      // 编辑的时候查询支付宝路由渠道商户请求的响应事件
      handleAlpChanMerResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0 || !response.data) {
          Util.toast('MERCHANT_INPUT.SELECT_ALP_ERROR', 3000, true);
          return;
        }

        this.set('alipay', response.data);
        if (this.alipay) {
          this.alpUpdate = true;
          this.oldAlpSignCert = this.alipay.signCert;
        }
        if (this.alipay.agentCode) {
          this.aagentCode = {
            key: this.alipay.agentCode,
            value: this.aagentCodeMap[this.alipay.agentCode],
          };
        }
      },
      // 编辑的时候查询微信路由渠道商户请求的响应事件
      handleWxpChanMerResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0 || !response.data) {
          Util.toast('MERCHANT_INPUT.SELECT_WXP_ERROR', 3000, true);
          this.set('weixin.httpCert', '');
          this.set('weixin.httpKey', '');
          return;
        }

        if (!response.data.httpCert) {
          response.data.httpCert = '';
        }
        if (!response.data.httpKey) {
          response.data.httpKey = '';
        }
        this.set('weixin', response.data);
        this.set('weixin.chanCode', 'WXP');
        this.bigMerchantMap = {};
        if (!this.weixin.agentMer) {
          this.set('weixin.agentMer', {});
        } else {
          this.bigMerchantMap[this.weixin.agentMer.chanMerId] = this.weixin.agentMer;
          this.wbigchanMerId = {
            key: this.weixin.agentMer.chanMerId,
            value: this.wbigchanMerIdMap[this.weixin.agentMer.chanMerId],
          };
        }

        if (this.weixin) {
          this.wxpUpdate = true;
          this.oldWxpSignCert = this.weixin.signCert;
          this.oldWxpHttpCert = this.weixin.httpCert;
          this.oldWxpHttpKey = this.weixin.httpKey;
        }
      },
      // 编辑的时候查询优方渠道商户请求的响应事件
      handleUliveChanMerResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0 || !response.data) {
          Util.toast('MERCHANT_INPUT.SELECT_ULIVE_ERROR', 3000, true);
          return;
        }

        this.set('ulive', response.data);
        this.set('ulive.chanCode', 'ULIVE');
      },
      // 编辑的时候查找支付宝路由信息的响应事件
      handleFindRouterAlpResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('MERCHANT_INPUT.SELECT_ALP_ROUTE_ERROR', 3000, true);
          return;
        }
        this.set('alipayRoute', response.data);
        if (response.data) {
          this.asettFlag = {
            key: response.data.settFlag,
            value: response.data.settFlag
          }
        }
      },
      // 编辑的时候查找微信路由信息的响应事件
      handleFindRouterWeixinResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('MERCHANT_INPUT.SELECT_WXP_ROUTE_ERROR', 3000, true);
          return;
        }
        this.set('weixinRoute', response.data);
        if (response.data) {
          this.wsettFlag = {
            key: response.data.settFlag,
            value: response.data.settFlag
          }
        }
      },
      ready: function() {
        this.idx = 0;
        this.update = false;
        this.merchant = {
          agentCode: '',
          agentName: '',
          groupCode: '',
          groupName: '',
          merId: '',
          detail: {
            merName: '',
            brandNum: '',
            shopId: '',
            shopType: ''
          },
          merStatus: 'Normal',
          transCurr: 'USD',
          signKey: '',
          isNeedSign: false,
          limitAmt: 50000,
          encryptKey: '',
          permission: []
        };
        this.alipay = {
          chanCode: 'ALP',
          chanMerId: '',
          chanMerName: '',
          signCert: ''
        };
        this.weixin = {
          chanCode: 'WXP',
          isAgentMode: true,
          agentMer: {
            chanMerId: '1301344001'
          },
          chanMerId: '',
          chanMerName: '',
          wxpAppId: '',
          signCert: '',
          httpCert: '',
          httpKey: ''
        };
        this.ulive = {
          chanCode: 'ULIVE',
          chanMerId: '',
          terminalId: ''
        };
        this.wbigchanMerIdMap = {
          '1301344001': '華銀 1301344001',
        };
        this.aagentCodeMap = {
          '12010128a1': '讯联 12010128a1',
          '11719712a1': '天奕通 11719712a1'
        };

        // 默认选择我们的代理
        this.wbigchanMerId = {
          key: '1301344001',
          value: '華銀 1301344001'
        };
        // 存放大商户信息，现在有2个
        this.bigMerchantMap = {};
        // 查询微信大商户
        this.$.findChanMerAjax.params = {
          page: 1,
          chanMerId: this.wbigchanMerId.key
        };
        this.$.findChanMerAjax.generateRequest();
        // 默认支付宝代理号为12010128a1
        this.aagentCode = {
          key: '12010128a1',
          value: '讯联 12010128a1',
        };
        // 支付宝路由
        this.alipayRoute = {
          cardBrand: 'ALP',
        };
        // 微信路由
        this.weixinRoute = {
          cardBrand: 'WXP',
        };
        this.update = false;
        this.permissionArray = [{
          key: 'PURC',
          value: 'TRANS_TYPE.PURC',
          isChecked: false
        }, {
          key: 'PAUT',
          value: 'TRANS_TYPE.PAUT',
          isChecked: false
        }, {
          key: 'INQY',
          value: 'TRANS_TYPE.INQY',
          isChecked: false
        }, {
          key: 'CANC',
          value: 'TRANS_TYPE.CANC',
          isChecked: false
        }, {
          key: 'VOID',
          value: 'TRANS_TYPE.VOID',
          isChecked: false
        }, {
          key: 'REFD',
          value: 'TRANS_TYPE.REFD',
          isChecked: false
        }, {
          key: 'QYZF',
          value: 'TRANS_TYPE.QYZF',
          isChecked: false
        }, {
          key: 'JSZF',
          value: 'TRANS_TYPE.JSZF',
          isChecked: false
        }
        // , {
        //   key: 'VERI',
        //   value: 'TRANS_TYPE.VERI',
        //   isChecked: false
        // }, {
        //   key: 'CRVE',
        //   value: 'TRANS_TYPE.CRVE',
        //   isChecked: false
        // }, {
        //   key: 'QUVE',
        //   value: 'TRANS_TYPE.QUVE',
        //   isChecked: false
        // }, {
        //   key: 'CAVE',
        //   value: 'TRANS_TYPE.CAVE',
        //   isChecked: false
        // }
    ];
        var i18nMsg = document.createElement('i18n-msg');
        this.merStatus = {
          key: 'Normal',
          value: i18nMsg.getMsg('MERCHANT.NORMAL')
        };
      },
      // 查询渠道商户的响应事件，这里是查找大商户
      handleFindChanMerResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          return;
        }

        var pagination = response.data;
        if (!pagination.data || pagination.data.length === 0) {
          return;
        }
        this.set('bigMerchant', pagination.data[0]);
        this.bigMerchantMap[this.wbigchanMerId.key] = pagination.data[0];
      },
      // 支付宝partnerId变化后，会查询出该支付宝渠道信息。
      handleFindChanMerAlpResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          return;
        }

        var pagination = response.data;
        if (!pagination.data || pagination.data.length === 0) {
          return;
        }
        this.set('alipay', pagination.data[0]);
        if (this.alipay.agentCode) {
          this.aagentCode = {
            key: this.alipay.agentCode,
            value: this.aagentCodeMap[this.alipay.agentCode],
          };
        }
        this.set('alipayRoute.acqFee', '');
        this.set('alipayRoute.merFee', '');
        this.set('alipayRoute.settFlag', '');

        if (this.alipay) {
          this.alpUpdate = true;
          this.oldAlpSignCert = this.alipay.signCert;
        }
      },
      // 微信id变化后，会查询出该微信渠道信息。
      handleFindChanMerWeixinResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          return;
        }

        var pagination = response.data;
        if (!pagination.data || pagination.data.length === 0) {
          return;
        }
        this.set('weixin', pagination.data[0]);
        this.bigMerchantMap = {};
        if (!this.weixin.agentMer) {
          this.set('weixin.agentMer', {});
        } else {
          this.bigMerchantMap[this.weixin.agentMer.chanMerId] = this.weixin.agentMer;
          this.wbigchanMerId = {
            key: this.weixin.agentMer.chanMerId,
            value: this.wbigchanMerIdMap[this.weixin.agentMer.chanMerId],
          };
        }

        this.set('weixinRoute.acqFee', '');
        this.set('weixinRoute.merFee', '');
        this.set('weixinRoute.settFlag', '');

        if (this.weixin) {
          this.wxpUpdate = true;
          this.oldWxpSignCert = this.weixin.signCert;
          this.oldWxpHttpCert = this.weixin.httpCert;
          this.oldWxpHttpKey = this.weixin.httpKey;
        }
      },
      //判断商户录入必填项是否为空
      isMerchantConfigEmpty: function() {
        if (this.$.merId.validate() && this.$.merName.validate() && this.$.commodityName.validate() && this.$.merStatus.selectedItem) {
          if (this.$.isNeedSignCheck.checked) {
            if (!this.$.signKey.validate()) {
              return true;
            }
          }
          return false;
        } else {
          return true;
        }
      },
      // 保存商户的按钮事件
      handleSaveMerchantTapped: function() {
        if (this.isMerchantConfigEmpty()) {
          Util.toast('PASSWORDMODIFICATION.TOAST.NOT_EMPTY_FOR_REQUIRED_ITEMS', 3000, true);
          return;
        }
        if (this.merchant.signKey && this.merchant.signKey.length < 8) {
          Util.toast('MERCHANT.SIGN_KEY_LOWEST_LENGTH', 3000, true);
          return;
        }
        if (this.update) {
          if (this.merchant.signKey !== this.oldSignKey && this.merchant.signKey.indexOf('*') !== -1) {
            Util.toast('MERCHANT.SIGN_KEY_CANNOT_CONTAIN_STAR_AND_RESTORE', 3000, true);
            this.set('merchant.signKey', this.oldSignKey)
            return;
          }
          this.$.updateMerchantAjax.body = JSON.stringify(this.merchant);
          this.$.updateMerchantAjax.generateRequest();
        } else {
          if (this.merchant.signKey.indexOf('*') !== -1) {
            Util.toast('MERCHANT.SIGN_KEY_CANNOT_CONTAIN_STAR', 3000, true);
            return;
          }
          this.$.saveMerchantAjax.body = JSON.stringify(this.merchant);
          this.$.saveMerchantAjax.generateRequest();
        }
      },
      // 保存商户的ajax响应事件
      handleSaveMerchantResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('MERCHANT.' + response.message, 3000, true);
          return;
        }

        Util.toast('MERCHANT.' + response.message, 1000, true);
      },
      // 更新商户的ajax响应事件
      handleUpdateMerchantResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('MERCHANT.' + response.message, 3000, true);
          return;
        }

        Util.toast('MERCHANT.' + response.message, 1000, true);
      },
      // 判断优方渠道信息是否必填项都填写了，返回false表示都填写了
      isUliveConfigEmpty: function() {
        if (this.$.uliveChanMerId.validate()) {
          return false;
        }

        return true;
      },
      // 保存优方的渠道信息
      handleSaveUliveapped: function() {
        if (this.isUliveConfigEmpty()) {
          Util.toast('PASSWORDMODIFICATION.TOAST.NOT_EMPTY_FOR_REQUIRED_ITEMS', 3000, true);
          return;
        }

        this.set('ulive.chanCode', 'ULIVE');
        this.$.saveChannelMerchantAjax.body = JSON.stringify(this.ulive);
        this.$.saveChannelMerchantAjax.generateRequest();

        // 保存优方路由信息
        var obj = {
          merId: this.merchant.merId,
          cardBrand: 'ULIVE',
          chanCode: this.ulive.chanCode,
          chanMerId: this.ulive.chanMerId,
        };
        this.$.saveRouterAjax.body = JSON.stringify(obj);
        this.$.saveRouterAjax.generateRequest();
      },
      // 判断支付宝必填项是否为空, 返回false表示都填写了
      isALPConfigEmpty: function() {
        if (this.$.achanMerId.validate() && this.$.aacqFee.validate() && this.$.amerFee.validate() && this.asettFlag && this.$.asettRole.validate() && this.$.asignCert.validate() && this.aagentCode) {
          return false;
        }
        return true;
      },
      // 保存支付宝信息的按钮事件
      handleSaveALPTapped: function() {
        if (this.isALPConfigEmpty()) {
          Util.toast('PASSWORDMODIFICATION.TOAST.NOT_EMPTY_FOR_REQUIRED_ITEMS', 3000, true);
          return;
        }
        if (this.alipay.signCert && this.alipay.signCert.length < 8) {
          Util.toast('CHAN_MERCHANT.SIGN_CERT_ALP_LOWEST_LENGTH', 3000, true);
          return;
        }
        if (this.alpUpdate) {
          if (this.alipay.signCert !== this.oldAlpSignCert && this.alipay.signCert.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_CERT_CANNOT_CONTAIN_STAR_AND_RESTORE', 3000, true);
            this.set('alipay.signCert', this.oldAlpSignCert)
            return;
          }
        } else {
          if (this.alipay.signCert.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_CERT_CANNOT_CONTAIN_STAR', 3000, true);
            return;
          }
        }
        var acqFee = parseFloat(this.alipayRoute.acqFee),
          merFee = parseFloat(this.alipayRoute.merFee);
        if (isNaN(acqFee) || isNaN(merFee)) {
          Util.toast('CHAN_MERCHANT.FEE_IS_NUMBER', 3000, true);
          return;
        }
        // this.set('alipay.acqFee', acqFee);
        // this.set('alipay.merFee', merFee);
        this.set('alipay.chanCode', 'ALP');
        this.$.saveChannelMerchantAjax.body = JSON.stringify(this.alipay);
        this.$.saveChannelMerchantAjax.generateRequest();

        // 支付宝路由信息
        var obj = {
          merId: this.merchant.merId,
          cardBrand: 'ALP',
          chanCode: this.alipay.chanCode,
          chanMerId: this.alipay.chanMerId,
          acqFee: acqFee,
          merFee: merFee,
          settFlag: this.asettFlag.key,
          settRole: this.alipayRoute.settRole
        };
        this.$.saveRouterAjax.body = JSON.stringify(obj);
        this.$.saveRouterAjax.generateRequest();
      },
      // 微信必填项是否为空
      isWXPConfigEmpty: function() {
        if (this.weixin.isAgentMode) {
          if (this.$.wchanMerId.validate() && this.$.wacqFee.validate() && this.$.wmerFee.validate() && this.wsettFlag && this.$.wsettRole.validate() && this.wbigchanMerId && this.wbigchanMerId.key) {
            return false;
          }
        } else {
          if (this.$.wchanMerId.validate() && this.$.wacqFee.validate() && this.$.wmerFee.validate() && this.wsettFlag && this.$.wsettRole.validate() && this.$.wxpAppId.validate() &&
            this.$.wsignCert.validate() && this.$.httpCertTArea.validate() && this.$.httpKeyTArea.validate()) {
            return false;
          }
        }
        return true;
      },
      // 保存微信信息的按钮事件
      handleSaveWXPTapped: function() {
        if (this.isWXPConfigEmpty()) {
          Util.toast('PASSWORDMODIFICATION.TOAST.NOT_EMPTY_FOR_REQUIRED_ITEMS', 3000, true);
          return;
        }
        if (this.weixin.signCert && this.weixin.signCert.length < 8) {
          Util.toast('MERCHANT.SIGN_CERT_LOWEST_LENGTH', 3000, true);
          return;
        }
        if (this.weixin.httpCert && this.weixin.httpCert !== '' && this.weixin.httpCert.length < 8) {
          Util.toast('CHAN_MERCHANT.SIGN_CERT_WXP_LOWEST_LENGTH', 3000, true);
          return;
        }
        if (this.weixin.httpKey && this.weixin.httpKey !== '' && this.weixin.httpKey.length < 8) {
          Util.toast('CHAN_MERCHANT.SIGN_KEY_ALP_LOWEST_LENGTH', 3000, true);
          return;
        }
        if (this.wxpUpdate) {
          if (this.weixin.signCert !== this.oldWxpSignCert && this.weixin.signCert.indexOf('*') !== -1) {
            Util.toast('MERCHANT.SIGN_KEY_CANNOT_CONTAIN_STAR_AND_RESTORE', 3000, true);
            this.set('weixin.signCert', this.oldWxpSignCert)
            return;
          }
          if (this.weixin.httpCert !== this.oldWxpHttpCert && this.weixin.httpCert.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_CERT_WXP_CANNOT_CONTAIN_STAR_AND_RESTORE', 3000, true);
            this.set('weixin.httpCert', this.oldWxpHttpCert)
            return;
          }
          if (this.weixin.httpKey !== this.oldWxpHttpKey && this.weixin.httpKey.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_KEY_WXP_CANNOT_CONTAIN_STAR_AND_RESTORE', 3000, true);
            this.set('weixin.httpKey', this.oldWxpHttpKey)
            return;
          }
        } else {
          if (this.weixin.signCert.indexOf('*') !== -1) {
            Util.toast('MERCHANT.SIGN_KEY_CANNOT_CONTAIN_STAR', 3000, true);
            return;
          }
          if (this.weixin.httpCert.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_CERT_WXP_CANNOT_CONTAIN_STAR', 3000, true);
            return;
          }
          if (this.weixin.httpKey.indexOf('*') !== -1) {
            Util.toast('CHAN_MERCHANT.SIGN_KEY_WXP_CANNOT_CONTAIN_STAR', 3000, true);
            return;
          }
        }
        var acqFee = parseFloat(this.weixinRoute.acqFee),
          merFee = parseFloat(this.weixinRoute.merFee);
        if (isNaN(acqFee) || isNaN(merFee)) {
          Util.toast('CHAN_MERCHANT.FEE_IS_NUMBER', 3000, true);
          return;
        }
        // this.set('weixin.acqFee', acqFee);
        // this.set('weixin.merFee', merFee);
        this.set('weixin.chanCode', 'WXP');
        // 如果勾选了代理商模式，就直接填充上大商户的信息
        if (this.weixin.isAgentMode) {
          if (!this.bigMerchant) {
            Util.toast(this.wbigchanMerId.key + ' big merchant info is empty', 3000);
            return;
          }
          this.set('weixin.agentMer', this.bigMerchant);
        } else {
          this.set('weixin.agentMer', {});
        }
        this.$.saveChannelMerchantAjax.body = JSON.stringify(this.weixin);
        this.$.saveChannelMerchantAjax.generateRequest();

        // 微信路由信息
        var router = {
          merId: this.merchant.merId,
          cardBrand: 'WXP',
          chanCode: this.weixin.chanCode,
          chanMerId: this.weixin.chanMerId,
          acqFee: acqFee,
          merFee: merFee,
          settFlag: this.wsettFlag.key,
          settRole: this.weixinRoute.settRole
        };
        this.$.saveRouterAjax.body = JSON.stringify(router);
        this.$.saveRouterAjax.generateRequest();

      },
      // 保存路由的ajax响应事件
      handleSaveRouterResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('ROUTE_POLICY.' + response.message, 3000, true);
          return;
        }

        Util.toast('ROUTE_POLICY.' + response.message, 1000, true);
      },
      // 保存渠道商户ajax请求响应事件
      handleSaveChannelMerchantResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('CHAN_MERCHANT.' + response.message, 3000, true);
          return;
        }

        Util.toast('CHAN_MERCHANT.' + response.message, 1000, true);
      },
      // 是否代理商模式的改变事件
      handleIsAgentChangeEvent: function() {
        this.set('weixin.isAgentMode', this.$.isAgentMode.checked);
      },
      // 是否需要验签的改变事件
      handleIsNeedSignChangeEvent: function() {
        this.set('merchant.isNeedSign', this.$.isNeedSignCheck.checked);
      },
      // 支付成功后是否需要传输金额到自定义连接里面的改变事件
      handleIsNeedPostAmountChangeEvent: function() {
        this.set('merchant.detail.isPostAmount', this.$.isNeedPostAmountAfterSuccess.checked);
      },
      // 接口权限中的复选框组的改变事件
      handlePermissionChangeEvent: function(e) {
        var checkbox = e.target,
          item = e.model.item,
          index = this.merchant.permission.indexOf(item.key);

        if (checkbox.checked) {
          // 勾选了
          if (index >= 0) {
            return;
          }
          this.push('merchant.permission', item.key);
        } else {
          // 没勾选
          if (index < 0) {
            return;
          }
          this.splice('merchant.permission', index, 1);
        }
      },

      _watchMerStatusChange: function(key) {
        if (key) {
          this.set('merchant.merStatus', key);
        } else {
          this.set('merchant.merStatus', '');
        }
      },
      // html5 读取证书文件内容
      handleWeixinHttpCertFile: function(e) {
        var _this = this;
        var files = e.srcElement.files;
        if (files.length) {
          var file = files[0];
          // if ('application/x-x509-ca-cert' === file.type) {
            var reader = new FileReader();
            reader.onload = function() {
              if (/BEGIN CERTIFICATE/.test(this.result) === false) {
                Util.toast('CHAN_MERCHANT.HTTP_CERT_FORMAT_ERROR', 3000, true);
                return;
              }
              _this.set('weixin.httpCert', this.result);
            };
            reader.readAsText(file);
          // } else {
          //   Util.toast('CHAN_MERCHANT.HTTP_CERT_FORMAT_ERROR_PEM', 3000, true);
          // }
        }
      },
      handleWeixinHttpKeyFile: function(e) {
        var _this = this;
        var files = e.srcElement.files;
        if (files.length) {
          var file = files[0];
          // if ('application/x-x509-ca-cert' === file.type) {
            var reader = new FileReader();
            reader.onload = function() {
              if (/BEGIN (RSA )?PRIVATE KEY/.test(this.result) === false) {
                Util.toast('CHAN_MERCHANT.HTTP_KEY_FORMAT_ERROR', 3000, true);
                return;
              }
              _this.set('weixin.httpKey', this.result);
            };
            reader.readAsText(file);
          // } else {
          //   Util.toast('CHAN_MERCHANT.HTTP_KEY_FORMAT_ERROR_PEM', 3000, true);
          // }
        }
      },
      // 代理列表响应
      handleQueryAgentsResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('CHAN_MERCHANT.LOAD_AGENT_LIST_ERROR', 3000, true);
          return;
        }

        var pagination = response.data;
        if (pagination.count <= 0) {
          Util.toast('CHAN_MERCHANT.NO_AGENT_DATA', 2000, true);
          return;
        }

        var agents = response.data.data.slice(0);
        this.set('agents', agents.map(function(item) {
          return {
            key: item.agentCode,
            value: item.agentName
          };
        }));

      },
      // 公司列表响应
      handleQuerySubAgentsResponse: function(e) {
        this.set('subAgents', []);
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('CHAN_MERCHANT.LOAD_SUB_AGENT_LIST_ERROR', 3000, true);
          return;
        }

        var pagination = response.data;
        if (pagination.count <= 0) {
          this.set('subAgent', {});
          Util.toast('CHAN_MERCHANT.NO_SUB_AGENT_DATA', 2000, true);
          return;
        }

        var subAgents = response.data.data.slice(0);
        this.set('subAgents', subAgents.map(function(item) {
          return {
            key: item.subAgentCode,
            value: item.subAgentName
          };
        }));

        // subAgents改变时，是否改变subAgent的值。
        this.changeSubAgent = true;
        for (var i = 0; i < this.subAgents.length; i++) {
          if (!this.subAgent) {
            return;
          }
          if (this.subAgent.key == this.subAgents[i].key) {
            this.changeSubAgent = false;
            break;
          }
        }
        if (this.changeSubAgent) {
          this.set('subAgent', {});
        }
      },
      // 商户列表响应
      handleQueryGroupsResponse: function(e) {
        this.set('groups', []);
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast('CHAN_MERCHANT.LOAD_GROUP_LIST_ERROR', 3000, true);
          return;
        }

        var pagination = response.data;
        if (pagination.count <= 0) {
          this.set('group', {});
          Util.toast('CHAN_MERCHANT.NO_GROUP_DATA', 2000, true);
          return;
        }
        var groups = response.data.data.slice(0);
        this.set('groups', groups.map(function(item) {
          return {
            key: item.groupCode,
            value: item.groupName
          };
        }));
        // groups改变时，是否改变group的值。
        this.changeGroup = true;
        for (var i = 0; i < this.groups.length; i++) {
          if (!this.group) {
            return;
          }
          if (this.group.key == this.groups[i].key) {
            this.changeGroup = false;
            break;
          }
        }
        if (this.changeGroup) {
          this.set('group', {});
        }
      },
      // 刷新生成门店签名密钥
      handleRefreshSignKeyTapped: function() {
        this.set('merchant.signKey', generateMixed(32));
      },
      getPermission: function(value) {
        return 'TRANS_TYPE.' + value;
      }
    });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../merchant-view/merchant-view.html">
<link rel="import" href="../trade-message/trade-message.html">
<link rel="import" href="../coupon-view/coupon-view.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../x-select/x-select.html">
<dom-module id="coupon-wo-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <input type="hidden" name="startTime" value="{{cond.startTime::input}}" />
        <paper-input label="* 交易时间从" on-tap="showStartTimeDialog" value="{{time.startTimeString::input}}"></paper-input>
        <paper-dialog with-backdrop id="startTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissStartTimeDialog">
          <paper-date-picker id="startTimePicker" locale="zh-cn" responsive-width="655px" max-date="{{time.endTime}}"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>取消</paper-button>
            <paper-button dialog-confirm>确定</paper-button>
          </div>
        </paper-dialog>

        <input type="hidden" name="endTime" value="{{cond.endTime::input}}" />
        <paper-input label="* 交易时间到" on-tap="showEndTimeDialog" value="{{time.endTimeString::input}}"></paper-input>
        <paper-dialog with-backdrop id="endTimeDailog" class="paper-date-picker-dialog" on-iron-overlay-closed="dismissEndTimeDialog">
          <paper-date-picker id="endTimePicker" locale="zh-cn" responsive-width="655px" min-date="{{time.startTime}}"></paper-date-picker>
          <div class="buttons">
            <paper-button dialog-dismiss>取消</paper-button>
            <paper-button dialog-confirm>确定</paper-button>
          </div>
        </paper-dialog>

        <paper-input id="merId" label="门店代码" name="merId" value="{{cond.merId::input}}"></paper-input>
        <paper-input label="订单号" name="orderNum" value="{{cond.orderNum::input}}"></paper-input>
        <paper-input label="关联订单号" name="origOrderNum" value="{{cond.origOrderNum::input}}"></paper-input>
        <paper-input label="卡券号" name="couponsNo" value="{{cond.couponNum::input}}"></paper-input>
        <paper-input label="应答码" name="respcd" value="{{cond.respcd::input}}"></paper-input>
        <x-select items="[[woStatusMapArray]]" name="writeoffStatus" selected-item="{{woStatus}}" label="核销状态"></x-select>
        <x-select items="[[busicds]]" name="busicd" selected-item="{{busicd}}" label="交易类型"></x-select>
        <paper-input id="payType" name="pay" value="coupon" hidden></paper-input>
        <paper-button class="colorful" raised on-tap="queryAction">查询</paper-button>
      </div>
      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th">序号</div>
            <div class="th">应答码</div>
            <div class="th left">门店代码</div>
            <div class="th left">门店名称</div>
            <div class="th left">订单号</div>
            <div class="th left">交易类型</div>
            <div class="th left">卡券号</div>
            <div class="th left">卡券名称</div>
            <div class="th left">终端</div>
            <div class="th left">核销状态</div>
            <div class="th">交易时间</div>
            <div class="th">报文</div>
          </div>
        </div>
        <div class='tbody'>
          <template is="dom-repeat" items="{{trades}}">
            <div class="tr">
              <div class="td center">{{addOneFilter(index)}}</div>
              <div class="td" align="center">
                <div style="display: inline-block;position: relative; cursor: pointer;" class$="{{getRespCodeColor(item.respcd)}}">
                  <span class="abbr">{{item.respcd}}</span>
                  <paper-tooltip class="nowrap" position="right">{{item.errorDetail}}</paper-tooltip>
                </div>
              </div>
              <div class="td">
                <span hidden$="{{isAdmin}}">{{item.merId}}</span>
                <a on-tap="showMerchantViewHandler" hidden$="{{!isAdmin}}">{{item.merId}}</a>
              </div>
              <div class="td">{{item.merName}}</div>
              <div class="td left">
                <a on-tap="showTradeViewHandler">{{item.orderNum}}</a>
              </div>
              <div class="td left">{{busicdFilter(item.busicd)}}</div>
              <div class="td left">{{item.couponsNo}}</div>
              <div class="td left">{{item.prodname}}</div>
              <div class="td">{{item.terminalid}}</div>
              <div class="td">{{woStatusFilter(item.writeoffStatus)}}</div>
              <div class="td center">{{item.transTime}}</div>
              <div class="td center">
                <iron-icon icon="receipt" on-tap="showTradeMessageEvent"></iron-icon>
              </div>
            </div>
          </template>
        </div>
        <div class="tfoot">
          <div class="tr pagination">
            <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
          </div>
        </div>
      </div>
    </form>
    <coupon-view id="tradeView" item="{{transItem}}"></coupon-view>
    <trade-message id="tradeMessage" item="{{transItem}}" user="{{user}}"></trade-message>
    <merchant-view id="merchantView" mer-id="{{merId}}" on-editor="handleItemEditedEvent"></merchant-view>
    <x-ajax id="queryCurrentUserAjax" auto method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleQueryCurrentUserResponse"></x-ajax>
  </template>
  <script>
    (function() {
      'use strict';
      var TRANS_TYPE_MAP = {
        'VERI': '卡券核销',
        // 'CRVE': '刷卡核销',
        // 'QUVE': '验券查询',
        'CAVE': '卡券撤销',
      };
      var WO_STATUS_MAP = {
        'SUCCESS': '成功',
        'ERROR': '失败',
        // 'PROCESS': '处理中',
      };
      Polymer({
        is: 'coupon-wo-list',
        properties: {
          cond: {
            type: Object,
            value: function() {
              return {
                total: 0,
                page: 1,
                size: 20
              };
            }
          },
          time: {
            type: Object,
            value: function() {
              var startTime = moment();
              startTime.hour(0);
              startTime.minute(0);
              startTime.second(0);

              var endTime = moment();
              endTime.hour(23);
              endTime.minute(59);
              endTime.second(59);
              return {
                startTime: startTime.toDate(),
                startTimeString: moment(startTime).format('YYYY-MM-DD'),
                endTime: endTime.toDate(),
                endTimeString: moment(endTime).format('YYYY-MM-DD')
              }
            }
          },
          user: Object,
          woStatusMapArray: {
            type: Array,
            value: function() {
              var arr = [];

              arr = Object.keys(WO_STATUS_MAP).map(function(item) {
                return {
                  key: item,
                  value: WO_STATUS_MAP[item]
                };
              })
              return arr;
            }
          },
          busicd: {
            type: Object
          },
          busicds: {
            type: Array,
            value: (function() {
              var busicds = [],
                obj = {};
              for (var k in TRANS_TYPE_MAP) {
                if (!obj[k.toUpperCase()]) {
                  obj[k.toUpperCase()] = TRANS_TYPE_MAP[k];
                  busicds.push({
                    key: k.toUpperCase(),
                    value: (k.toUpperCase() + ' ' + TRANS_TYPE_MAP[k])
                  });
                }
              }
              return busicds;
            })()
          },
        },
        ready: function() {
          this.isAdmin = false;
        },
        attached: function() {},
        observers: [
          '_watchUserChanged(user.*)',
          '_watchTimeChanged(time.startTime, time.endTime)',
          '_watchBusicdChange(busicd.key)',
        ],
        _watchTimeChanged: function(startTime, endTime) {
          this.set('time.startTimeString', moment(startTime).format('YYYY-MM-DD'));
          this.set('time.endTimeString', moment(endTime).format('YYYY-MM-DD'));
          this.set('cond.startTime', Util.toCSTDateTime(moment(this.time.startTime).format('YYYY-MM-DD 00:00:00')));
          this.set('cond.endTime', Util.toCSTDateTime(moment(this.time.endTime).format('YYYY-MM-DD 23:59:59')));
        },
        _watchUserChanged: function(value) {
          // 权限判断
          if (value) {
            var user = value.base;
            if (user.userType === 'admin') {
              this.isAdmin = true;
            } else if (user.userType === 'genAdmin') {
              this.isAdmin = false;
            }
          }
        },
        _watchBusicdChange: function(key) {
          this.cond.busicd = key;
        },
        // 弹窗显示报文信息
        showTradeMessageEvent: function(e) {
          this.transItem = e.model.item;
          this.$.tradeMessage.open();
        },
        // 弹窗显示交易详情
        showTradeViewHandler: function(e) {
          this.transItem = e.model.item;
          this.$.tradeView.open();
        },
        // 弹框显示门店详情
        showMerchantViewHandler: function(e) {
          this.merId = event.model.item.merId;
          this.$.merchantView.open();
        },
        queryAction: function() {
          this.$.formSearch.submit();
        },
        // 发送查询交易的ajax请求
        submitForm: function() {
          this.trades = [];
        },
        // ajax请求响应处理
        handleSearchResponse: function(e) {
          var response = e.detail;
          if (response.status !== 0) {
            Util.toast(response.message || '系统错误', 3000);
            this.set('cond.total', 0);
            this.set('cond.page', 0);
            return;
          }

          var pagination = response.data;
          if (!pagination.data || pagination.data.length === 0) {
            Util.toast('没有找到符合条件的数据', 3000);
            this.set('cond.total', 0);
            this.set('cond.page', 0);
            return;
          }

          this.trades = pagination.data.slice(0);
          this.set('cond.total', pagination.total);
          this.set('cond.page', pagination.page);
        },
        // 交易类型
        busicdFilter: function(busicd) {
          return TRANS_TYPE_MAP[busicd] || busicd;
        },
        // 核销状态
        woStatusFilter: function(status) {
          return WO_STATUS_MAP[status] || status;
        },
        // 应答码着色
        getRespCodeColor: function(value) {
          if (!value) {
            return
          }
          if (value === '00') {
            return 'green';
          }
          if (value.match(/^\d*96$/) || value === '9999') {
            return 'red';
          }
          return 'primary';
        },
        // 日期、时间控件
        dismissStartTimeDialog: function() {
          var startTime = this.$.startTimePicker.date;
          this.set('time.startTime', startTime);
        },
        showStartTimeDialog: function() {
          this.$.startTimeDailog.toggle();
        },
        dismissEndTimeDialog: function() {
          var endTime = this.$.endTimePicker.date;
          this.set('time.endTime', endTime);
        },
        showEndTimeDialog: function() {
          this.$.endTimeDailog.toggle();
        },
        addOneFilter: function(index) {
          return index + 1;
        },
        // 当前用户查询的响应事件
        handleQueryCurrentUserResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }

          this.set('user', response.data);
        },
      });
    })();
  </script>
</dom-module>

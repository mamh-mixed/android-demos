<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../x-select/x-select.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../yun-complete/yun-complete.html">
<link rel="import" href="../yun-date-time-picker/yun-date-time-picker.html">
<link rel="import" href="../trade-view/trade-view.html">
<link rel="import" href="../trade-message/trade-message.html">
<link rel="import" href="../merchant-view/merchant-view.html">
<dom-module id="trade-list">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/query" on-iron-form-submit="submitForm" on-iron-form-response="handleSearchResponse">
      <div class="search-condition">
        <input type="hidden" name="startTime" value="{{cond.startTime::input}}" />
        <yun-date-time-picker label="* 交易时间从" locale="ja" date-time="{{startTime}}" moment="{{time.startTime}}" max-date="{{time.endTime}}" data-msg-id="SCANPAY_TRADE_LIST.DATE_FROM" locale-msg-id="DATE_PICKER.LOCALE"></yun-date-time-picker>
        <input type="hidden" name="endTime" value="{{cond.endTime::input}}" />
        <yun-date-time-picker label="* 交易时间到" locale="ja" date-time="{{endTime}}" moment="{{time.endTime}}" min-date="{{time.startTime}}" max-date="{{tomorrow}}" data-msg-id="SCANPAY_TRADE_LIST.DATE_TO" locale-msg-id="DATE_PICKER.LOCALE"></yun-date-time-picker>
        <yun-complete id="agentCode" name="agentCode" label="代理" url="/master/list" col-name="agent" code-field="agentCode" name-field="agentName" limit="6" selected-item="{{agent}}" disabled="{{agentDisabled}}" data-msg-id="SCANPAY_TRADE_LIST.AGENT"></yun-complete>
        <yun-complete id="subAgentCode" name="subAgentCode" label="公司" url="/master/list" col-name="subAgent" code-field="subAgentCode" name-field="subAgentName" limit="6" selected-item="{{subAgent}}" filter-condition="[[subAgentFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.SUBAGENT"></yun-complete>
        <yun-complete id="groupCode" name="groupCode" label="商户" url="/master/list" col-name="group" code-field="groupCode" name-field="groupName" limit="6" selected-item="{{group}}" filter-condition="[[groupFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.GROUP"></yun-complete>
        <yun-complete id="merId" name="merId" label="门店" url="/master/list" col-name="merchant" code-field="merId" name-field="merDetail.merName" limit="6" selected-item="{{merchant}}" filter-condition="[[merchantFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.MERCHANT"></yun-complete>
        <paper-input label="订单号" name="orderNum" value="{{cond.orderNum::input}}" data-msg-id="SCANPAY_TRADE_LIST.ORDER_NO"></paper-input>
        <paper-input label="关联订单号" name="origOrderNum" value="{{cond.origOrderNum::input}}" data-msg-id="SCANPAY_TRADE_LIST.ORIGIN_ORDER_NO"></paper-input>
        <paper-input label="终端号" name="terminalId" value="{{cond.terminalId::input}}" data-msg-id="SCANPAY_TRADE_LIST.TERMINAL"></paper-input>
        <paper-input label="应答码" name="respcd" value="{{cond.respcd::input}}" data-msg-id="SCANPAY_TRADE_LIST.RESPONSE_CODE"></paper-input>
        <x-select items="[[busicds]]" name="busicd" selected-item="{{busicd}}" label="交易类型" data-msg-id="SCANPAY_TRADE_LIST.TRANS_TYPE" is-locale></x-select>
        <x-select items="[[transStatusMap]]" name="transStatus" selected-item="{{transStatus}}" label="交易状态" data-msg-id="SCANPAY_TRADE_LIST.TRANS_STATUS" is-locale></x-select>
        <paper-button class="colorful" raised on-tap="queryAction">
          <i18n-msg msgid="BUTTON.QUERY">查询</i18n-msg>
        </paper-button>
        <div class="paper-button-1">
          <a style="display:block; width:100%; height:100%; text-decoration:none;color:#fff;" target="iframeForDownload" href$="{{reportUri}}">
            <i18n-msg msgid="SCANPAY_TRADE_LIST.DOWNLOADREPORT">下载报表</i18n-msg>
          </a>
        </div>
      </div>
      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.INDEX">序号</i18n-msg>
            </div>
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.RESPONSE_CODE">应答码</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.MERCHANT_NO">门店代码</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.MERCHANT_NAME">门店名称</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.ORDER_NO">订单号</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.TERMINAL">终端</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.TRANS_TYPE">交易类型</i18n-msg>
            </div>
            <div class="th right">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.AMOUNT">金额</i18n-msg>
            </div>
            <div class="th center">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.CURRENCY">币种</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.CHANNEL">渠道</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.TRANS_STATUS">交易状态</i18n-msg>
            </div>
            <div class="th left">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.REFUND">退款</i18n-msg>
            </div>
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.TRANS_TIME">交易时间</i18n-msg>
            </div>
            <div class="th" hidden$="{{!isDatagramAccessible}}">报文</div>
          </div>
        </div>
        <div class='tbody'>
          <template is="dom-repeat" items="{{trades}}">
            <div class="tr">
              <div class="td center">{{addOneFilter(index)}}</div>
              <div class="td" align="center">
                <div style="display: inline-block;position: relative; cursor: pointer;" class$="{{getRespCodeColor(item.respcd)}}">
                  <span class="abbr">{{item.respcd}}</span>
                  <paper-tooltip class="nowrap" position="right">{{item.errorDetail}}</paper-tooltip>
                </div>
              </div>
              <div class="td">
                <span hidden$="{{isAdmin}}">{{item.merId}}</span>
                <a on-tap="showMerchantViewHandler" hidden$="{{!isAdmin}}">{{item.merId}}</a>
              </div>
              <div class="td">{{item.merName}}</div>
              <div class="td left">
                <a on-tap="showTradeViewHandler">{{item.orderNum}}</a>
              </div>
              <div class="td">{{item.terminalid}}</div>
              <div class="td left">
                <i18n-msg msgid$="{{busicdFilter(item.busicd)}}"></i18n-msg>
              </div>
              <div class="td right">
                <span>{{_currencyFilter(item.transAmt, item.currency)}}</span>
              </div>
              <div class="td center">
                <span>{{item.currency}}</span>
              </div>
              <div class="td">
                <i18n-msg msgid$="{{chanFilter(item.chanCode)}}">{{chanFilter(item.chanCode)}}</i18n-msg>
              </div>
              <div class="td">
                <template is="dom-if" if="{{isCloseTrans(item.transStatus)}}">
                  <div style="display: inline-block;position: relative;">
                    <span class="abbr" data-title$="{{_computeTransCloseReason(item.refundStatus)}}">
                      <i18n-msg msgid$="{{transStatusFilter(item.transStatus)}}"></i18n-msg>
                    </span>
                    <paper-tooltip position="right">
                      <i18n-msg msgid$="{{_computeTransCloseReason(item.refundStatus)}}"></i18n-msg>
                    </paper-tooltip>
                  </div>
                </template>
                <template is="dom-if" if="{{!isCloseTrans(item.transStatus)}}">
                  <i18n-msg msgid$="{{transStatusFilter(item.transStatus)}}"></i18n-msg>
                </template>
              </div>
              <div class="td">
                <i18n-msg msgid$="{{refundStatusFilter(item.refundStatus)}}"></i18n-msg>
              </div>
              <div class="td center">{{item.transTime}}</div>
              <div class="td center" hidden$="{{!isDatagramAccessible}}">
                <iron-icon icon="receipt" on-tap="showTradeMessageEvent"></iron-icon>
              </div>
            </div>
          </template>
        </div>
        <div class="tfoot">
          <div class="tr pagination">
            <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="queryAction"></x-pagination>
          </div>
        </div>
      </div>
    </form>
    <trade-view id="tradeView" item="{{transItem}}" user="{{user}}"></trade-view>
    <trade-message id="tradeMessage" item="{{transItem}}" user="{{user}}"></trade-message>
    <merchant-view id="merchantView" mer-id="{{merId}}" on-editor="handleItemEditedEvent"></merchant-view>
    <x-ajax id="queryCurrentUserAjax" auto method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleQueryCurrentUserResponse"></x-ajax>
    <iron-localstorage name="USERTYPE" value="{{userType}}" on-iron-localstorage-load="handleUserType" on-iron-localstorage-load-empty="handleNoUserType"></iron-localstorage>
  </template>
  <script>
    var TRANS_TYPE_MAP = {
      'PURC': '下单支付',
      'REFD': '退款',
      'CANC': '取消'
    };
    // 币种精度表
    var CURRENCY_DECIMAL_MAP = {
      'GBP': {
        key: 'GBP',
        currency: 'British Sterling',
        decimal: 2
      },
      'HKD': {
        key: 'HKD',
        currency: 'Hong Kong Dollar',
        decimal: 2
      },
      'CNY': {
        key: 'CNY',
        currency: 'Chinese RMB',
        decimal: 2
      },
      'JPY': {
        key: 'JPY',
        currency: 'Japanese Yen',
        decimal: 0
      },
      'USD': {
        key: 'USD',
        currency: 'U.S. Dollar',
        decimal: 2
      }
    };
    Polymer({
      is: 'trade-list',
      properties: {
        cond: {
          type: Object,
          value: function() {
            return {
              utcOffset: moment().utcOffset(),
              total: 0,
              page: 1,
              size: 20
            };
          }
        },
        time: {
          type: Object,
          value: function() {
            var startTime = moment();
            startTime.hour(0);
            startTime.minute(0);
            startTime.second(0);

            var endTime = moment();
            endTime.hour(23);
            endTime.minute(59);
            endTime.second(59);
            return {
              startTime: startTime.toDate(),
              startTimeString: moment(startTime).format('YYYY-MM-DD HH:mm:ss'),
              endTime: endTime.toDate(),
              endTimeString: moment(endTime).format('YYYY-MM-DD HH:mm:ss')
            }
          }
        },
        isDatagramAccessible: {
          type: Boolean,
          value: false
        },
        dataRoute: {
          type: String,
          value: 'trade.list',
          notify: true
        },
        trades: {
          type: Array,
          value: []
        },
        busicd: {
          type: Object
        },
        busicds: {
          type: Array,
          value: (function() {
            var busicds = [],
              map = {};
            for (var k in TRANS_TYPE_MAP) {
              if (!map[k.toUpperCase()]) {
                map[k.toUpperCase()] = TRANS_TYPE_MAP[k];
              }
            }
            Object.keys(map).forEach(function(v) {
              busicds.push({
                key: v,
                value: ('TRANS_TYPE.' + v.toUpperCase())
              });
            });
            return busicds;
          })()
        },
        transStatus: {
          type: Object
        },
        tomorrow: {
          type: Date
        },
        transStatusMap: {
          type: Array,
          value: [{
            key: '30',
            value: 'TRANS_STATUS.SUCCESS',
            valueCN: '成功'
          }, {
            key: '20',
            value: 'TRANS_STATUS.FAIL',
            valueCN: '失败'
          }, {
            key: '40',
            value: 'TRANS_STATUS.CLOSED',
            valueCN: '已关闭'
          }, {
            key: '10',
            value: 'TRANS_STATUS.IN_PROCESS',
            valueCN: '处理中'
          }, ]
        },
        user: Object,
      },
      ready: function() {
        this.busicd = {};
        this.trades = [];
        this.transStatus = {};
        this.refundStatusMap = {
          0: 'SCANPAY_TRADE_LIST.NO_REFUND',
          1: 'SCANPAY_TRADE_LIST.ALREADY_REFUND',
          2: 'SCANPAY_TRADE_LIST.PART_REFUND',
          3: 'SCANPAY_TRADE_LIST.CLOSE_BY_MERCHANT',
          4: 'SCANPAY_TRADE_LIST.CLOSE_BY_SYSTEM_AS_OVERTIME'
        };
        this.isAdmin = false;

        // 过滤条件初始化
        this.set('subAgentFilterCondition', {});
        this.set('groupFilterCondition', {});
        this.set('merchantFilterCondition', {});

        // 明天的时间
        var tomorrowMoment = moment();
        tomorrowMoment.second(0);
        tomorrowMoment.minute(0);
        tomorrowMoment.hour(0);
        tomorrowMoment.add(1, 'days');
        tomorrowMoment.add(-1, 'seconds');
        this.set('tomorrow', tomorrowMoment.toDate());
      },
      attached: function() {
        this.fire('rerender-i18n', {
          from: 'trade-list'
        });
      },
      observers: [
        '_watchAgentChange(agent.code)',
        '_watchSubAgentChange(subAgent.code)',
        '_watchGroupChange(group.code)',
        '_watchMerchantChange(merchant.code)',
        '_watchBusicdChange(busicd.key)',
        '_watchCondChange(cond.*)',
        '_watchTransStatusChange(transStatus.key)',
        '_watchUserChanged(user.*)',
        '_watchTimeChanged(time.startTime, time.endTime)'
      ],
      _watchTimeChanged: function(startTime, endTime) {
        this.set('time.startTimeString', moment(startTime).format('YYYY-MM-DD HH:mm:ss'));
        this.set('time.endTimeString', moment(endTime).format('YYYY-MM-DD HH:mm:ss'));
        this.set('cond.startTime', Util.toCSTDateTime(moment(this.time.startTime).format('YYYY-MM-DD HH:mm:ss')));
        this.set('cond.endTime', Util.toCSTDateTime(moment(this.time.endTime).format('YYYY-MM-DD HH:mm:ss')));
      },
      _watchAgentChange: function(key) {
        this.set('cond.agentCode', key);
        this.set('subAgentFilterCondition.agentCode', key);
        this.set('groupFilterCondition.agentCode', key);
        this.set('merchantFilterCondition.agentCode', key);

        this.$.subAgentCode.clear();
        this.$.groupCode.clear();
        this.$.merId.clear();
      },
      _watchSubAgentChange: function(key) {
        this.set('cond.subAgentCode', key);
        this.set('groupFilterCondition.subAgentCode', key);
        this.set('merchantFilterCondition.subAgentCode', key);
        this.$.groupCode.clear();
        this.$.merId.clear();
      },
      _watchGroupChange: function(key) {
        this.set('cond.groupCode', key);
        this.set('merchantFilterCondition.groupCode', key);
        this.$.merId.clear();
      },
      _watchMerchantChange: function(key) {
        this.set('cond.merId', key);
      },
      _watchBusicdChange: function(key) {
        this.cond.busicd = key;
      },
      _watchCondChange: function(newValue) {
        if (newValue.path !== 'cond.page') {
          this.set('cond.page', 1);
        }

        var filename = "Trans_" + this.cond.startTime + "_" + this.cond.endTime + ".xlsx";
        filename = filename.replace(/-/g, '');
        this.reportUri = '/master/trade/report?' + Util.query(this.cond) + '&filename=' + filename;
      },
      // 交易状态选择框改变
      _watchTransStatusChange: function(key) {
        this.cond.transStatus = key;
      },
      _watchUserChanged: function(value) {
        // 权限判断
        if (value) {
          var user = value.base;
          if (user.userType === 'agent') {
            this.set('cond.agentCode', user.agentCode);
            this.agent = {
              code: user.agentCode,
              value: user.agentCode,
            };
            this.agentDisabled = true;
          } else if (user.userType === 'subAgent') {
            this.set('cond.subAgentCode', user.subAgentCode);
            this.set('subAgent.code', user.subAgentCode);
            this.agentDisabled = true;
            this.$.subAgentCode.setAttribute('disabled', true);
          } else if (user.userType === 'group') {
            this.set('cond.groupCode', user.groupCode);
            this.set('group.code', user.groupCode);
            this.agentDisabled = true;
            this.$.subAgentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
          } else if (user.userType === 'merchant') {
            this.set('cond.merId', user.merId);
            this.agentDisabled = true;
            this.$.subAgentCode.setAttribute('disabled', true);
            this.$.groupCode.setAttribute('disabled', true);
            this.$.merId.setAttribute('disabled', true);
          } else if (user.userType === 'admin') {
            this.isAdmin = true;
            this.agentDisabled = false;
            this.$.subAgentCode.removeAttribute('disabled');
            this.$.groupCode.removeAttribute('disabled');
            this.$.merId.removeAttribute('disabled');
          } else if (user.userType === 'genAdmin') {
            this.isAdmin = false;
          }
        }
      },
      handleUserType: function() {
        if (this.userType === 'admin' || this.userType === 'genAdmin') {
          this.isDatagramAccessible = true;
          return;
        }
        this.isDatagramAccessible = false;
      },
      handleNoUserType: function() {
        this.isDatagramAccessible = false;
      },
      queryAction: function() {
        this.$.formSearch.submit();
      },
      // 发送查询交易的ajax请求
      submitForm: function() {
        this.trades = [];
      },
      // 当前用户查询的响应事件
      handleQueryCurrentUserResponse: function(e) {
        var response = e.detail.response;
        if (response.status !== 0) {
          Util.toast(response.message, 3000);
          return;
        }

        this.set('user', response.data);
      },
      // ajax请求响应处理
      handleSearchResponse: function(e) {
        var response = e.detail;
        if (response.status !== 0) {
          if (response.message) {
            Util.toast(response.message, 3000);
          } else {
            Util.toast('SCANPAY_TRADE_LIST.TOAST.SYSTEM_ERROR', 3000, true);

          }
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }

        var pagination = response.data;
        if (!pagination.data || pagination.data.length === 0) {
          Util.toast('SCANPAY_TRADE_LIST.TOAST.NOT_FOUND', 3000, true);
          this.set('cond.total', 0);
          this.set('cond.page', 0);
          return;
        }

        var items = pagination.data.slice(0);
        this.trades = [];
        // 如果没有币种，默认为人民币
        for (var i = 0, l = items.length; i < l; i++) {
          var item = items[i];
          if (!item.currency) {
            item.currency = 'CNY';
          }
          item.payTime = Util.toLocaleDateTime(item.payTime);
          item.transTime = Util.toLocaleDateTime(item.transTime);
          item.updateTime = Util.toLocaleDateTime(item.updateTime);
          this.push('trades', item);
        }

        this.set('cond.total', pagination.total);
        this.set('cond.page', pagination.page);
      },
      chanFilter: function(chanCode) {
        var map = {
          'ALP': {
            i18nID: 'CHANNEL.ALIPAY',
            value: '支付宝'
          },
          'WXP': {
            i18nID: 'CHANNEL.WECHAT',
            value: '微信'
          }
        };
        if (map[chanCode]) {
          return map[chanCode].i18nID;
        }
        return chanCode;
      },
      busicdFilter: function(busicd) {
        return 'TRANS_TYPE.' + busicd.toUpperCase();
      },
      _currencyFilter: function(money, currency) {
        if (!currency || currency === '') {
          currency = 'CNY';
        }

        var decInfo = CURRENCY_DECIMAL_MAP[currency];
        if (!decInfo) {
          decInfo = CURRENCY_DECIMAL_MAP['CNY'];
        }

        var amount = (money / Math.pow(10, decInfo.decimal)).toFixed(decInfo.decimal);
        return Util.beautifyAmount(amount);
      },
      transStatusFilter: function(status) {
        var map = {
          '10': {
            i18nID: 'TRANS_STATUS.IN_PROCESS',
            value: '处理中'
          },
          '20': {
            i18nID: 'TRANS_STATUS.FAIL',
            value: '失败'
          },
          '30': {
            i18nID: 'TRANS_STATUS.SUCCESS',
            value: '成功'
          },
          '40': {
            i18nID: 'TRANS_STATUS.CLOSED',
            value: '已关闭'
          }
        };
        if (map[status]) {
          return map[status].i18nID;
        }
        return status;
      },
      addOneFilter: function(index) {
        return index + 1;
      },
      // 应答码着色
      getRespCodeColor: function(value) {
        if (value === '00') {
          return 'green';
        }
        if (value === '96') {
          return 'red';
        }
        return 'primary';
      },
      showTradeViewHandler: function(e) {
        this.transItem = e.model.item;
        this.$.tradeView.open();
      },
      refundStatusFilter: function(status) {
        var map = {
          1: 'SCANPAY_TRADE_LIST.ALREADY_REFUND',
          2: 'SCANPAY_TRADE_LIST.PART_REFUND'
        };
        return map[status];
      },
      isCloseTrans: function(status) {
        return status === '40';
      },
      _computeTransCloseReason: function(status) {
        return this.refundStatusMap[status];
      },
      isShowTooltip: function(value) {
        if (value === '00') {
          return true;
        } else {
          return false;
        }
      },
      showTradeMessageEvent: function(e) {
        this.transItem = e.model.item;
        this.$.tradeMessage.open();
      },
      // 弹框显示门店详情
      showMerchantViewHandler: function(e) {
        if (this.user.userType === 'admin') {
          this.merId = e.model.item.merId;
          this.$.merchantView.open();
        }
      },
      handleItemEditedEvent: function() {
        document.querySelector('#appRouter').go('/config/merchant/' + this.merId);
      },
    });
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<dom-module id="password-editor">
  <style>
    :host {
      display: block;
    }

    .content {
      width: 300px;
      height: 300px;
    }
  </style>
  <template>
    <div class="content">
      <paper-input id="userName" label="用户名" value="{{userName::input}}" required disabled data-msg-id="PASSWORDMODIFICATION.USERNAME"></paper-input>
      <paper-input id="password" label="原密码" value="{{password::input}}" required type="password" required error-message="必填项" data-msg-id="PASSWORDMODIFICATION.OLDPASSWORD" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
      <paper-input id="newPwd" label="新密码" value="{{newPwd::input}}" type="password" required error-message="必填项" data-msg-id="PASSWORDMODIFICATION.NEWPASSWORD" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
      <paper-input id="newPwdRepeat" label="重复新密码" value="{{newPwdRepeat::input}}" type="password" required error-message="必填项" data-msg-id="PASSWORDMODIFICATION.CONFIRMPASSWORD" data-error-msg-id="PASSWORDMODIFICATION.REQUIREDITEM"></paper-input>
      <paper-button class="paper-button-1" style="color:#ffffff;margin-top:20px;" on-tap="handleSaveTapped">
        <i18n-msg msgid="BUTTON.UPDATE">更新</i18n-msg>
      </paper-button>
    </div>

    <x-ajax id="updatePwdAjax" method="POST" url="/master/user/updatePwd" handle-as="json" on-response="handleSaveResponse"></x-ajax>
    <x-ajax id="queryCurrentUserAjax" auto method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleQueryCurrentUserResponse"></x-ajax>
  </template>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'password-editor',
        properties: {
          userName: String
        },
        attached: function() {
          this.fire('rerender-i18n', {
            from: 'password-editor'
          });
        },
        isUserConfigEmpty: function() {
          if (this.$.userName.validate() && this.$.password.validate() && this.$.newPwd.validate() && this.$.newPwdRepeat.validate()) {
            return false;
          } else {
            return true;
          }
        },
        // 保存
        handleSaveTapped: function() {
          // 去掉空字符串
          this.set('password', this.password.trim());
          this.set('newPwd', this.newPwd.trim());

          if (this.isUserConfigEmpty()) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NOT_EMPTY_FOR_REQUIRED_ITEMS', 3000, true);
            return;
          }

          if (this.newPwd !== this.newPwdRepeat) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_NOT_MATCH', 3000, true);
            return;
          }

          // 新旧密码不一样
          if (this.newPwd === this.password) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_MUST_NOT_EQUAL_WITH_OLD_PASSWORD', 2000, true);
            return;
          }

          // 新密码复杂度校验
          if (this.newPwd.length < 8) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_LEAST_LENGTH', 5000, true);
            return;
          }
          if (this.newPwd.length >= 20) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_LONGEST_LENGTH', 5000, true);
            return;
          }

          if (!/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[a-zA-Z\d#\$@\.\_]{8,50}$/.test(this.newPwd)) {
            Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_MUST_BE_COMPLICATED', 5000, true);
            return;
          }

          // 密码加密
          var data = {
            userName: this.userName,
            password: Util.RSAEncrypt(this.password),
            newPwd: Util.RSAEncrypt(this.newPwd)
          };
          this.$.updatePwdAjax.body = JSON.stringify(data);
          this.$.updatePwdAjax.generateRequest();

        },
        // 更新密码后响应事件
        handleSaveResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            switch (response.message) {
              case 'OLD_PASSWORD_NOT_MATCH':
                Util.toast('PASSWORDMODIFICATION.TOAST.OLD_PASSWORD_NOT_MATCH', 3000, true);
                return;
                break;
              case 'PASSWORD_LENGTH_NOT_ENOUGH':
                Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_LEAST_LENGTH', 3000, true);
                return;
                break;
              case 'PASSWORD_LENGTH_TWO_LONG':
                Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_LONGEST_LENGTH', 3000, true);
                return;
                break;
              case 'PASSWORD_NOT_COMPLICATED_ENOUGH':
                Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_MUST_BE_COMPLICATED', 3000, true);
                return;
                break;
              case 'NEW_PASSWORD_IS_EQUAL_WITH_OLD_PASSWORD':
                Util.toast('PASSWORDMODIFICATION.TOAST.NEW_PASSWORD_MUST_NOT_EQUAL_WITH_OLD_PASSWORD', 3000, true);
                return;
                break;
              default:
                Util.toast('SCANPAY_TRADE_LIST.TOAST.SYSTEM_ERROR', 3000, true);
                return
            }
          }
          Util.toast('PASSWORDMODIFICATION.TOAST.MIDIFICATION_PASSWORD_SUCCESS', 3000, true);
        },
        // 当前用户查询的响应事件
        handleQueryCurrentUserResponse: function(e) {

          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          if (response.data) {
            this.set('userName', response.data.userName);
          }

        },
      });
    })();
  </script>
</dom-module>

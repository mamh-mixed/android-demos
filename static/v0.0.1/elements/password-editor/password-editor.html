<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<dom-module id="password-editor">
  <style>
    :host {
      display: block;
    }

    .content {
      width: 300px;
      height: 300px;
      /*border: 1px solid #e3e3e3;*/
    }
  </style>
  <template>
    <div class="content">
      <paper-input id="userName" label="用户名" value="{{userName::input}}" required error-message="必填项" disabled></paper-input>
      <paper-input id="password" label="原密码" value="{{password::input}}" required type="password" required error-message="必填项"></paper-input>
      <paper-input id="newPwd" label="新密码" value="{{newPwd::input}}" type="password" required error-message="必填项"></paper-input>
      <paper-input id="newPwdRepeat" label="重复新密码" value="{{newPwdRepeat::input}}" type="password" required error-message="必填项"></paper-input>

      <paper-button class="paper-button-1" style="color:#ffffff;margin-top:20px;" on-tap="handleSaveTapped">保存</paper-button>
    </div>


    <x-ajax id="updatePwdAjax" method="POST" url="/master/user/updatePwd" handle-as="json" on-response="handleSaveResponse"></x-ajax>
    <x-ajax id="queryCurrentUserAjax" auto method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleQueryCurrentUserResponse"></x-ajax>
  </template>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'password-editor',
        properties: {
          userName: String
        },
        isUserConfigEmpty: function() {
          if (this.$.userName.validate() && this.$.password.validate() && this.$.newPwd.validate() && this.$.newPwdRepeat.validate()) {
            return false;
          } else {
            return true;
          }
        },
        // 保存
        handleSaveTapped: function() {
          if (this.isUserConfigEmpty()) {
            Util.toast('必填项不能为空', 3000);
            return;
          }
          if (this.newPwd !== this.newPwdRepeat) {
            Util.toast('新密码不一致', 3000);
            return;
          }
          this.userPwd = {
            userName: this.userName,
            password: this.password,
            newPwd: this.newPwd
          };
          this.$.updatePwdAjax.body = JSON.stringify(this.userPwd);
          this.$.updatePwdAjax.generateRequest();

        },
        // 更新密码后响应事件
        handleSaveResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          Util.toast(response.message, 3000);
        },
        // 当前用户查询的响应事件
        handleQueryCurrentUserResponse: function(e) {

          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          if (response.data) {
            this.set('userName', response.data.userName);
          }

        },
      });
    })();
  </script>
</dom-module>

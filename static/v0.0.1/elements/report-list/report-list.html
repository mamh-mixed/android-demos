<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../x-form/x-form.html">
<link rel="import" href="../x-select/x-select.html">
<link rel="import" href="../yun-complete/yun-complete.html">
<link rel="import" href="../yun-date-time-picker/yun-date-time-picker.html">
<dom-module id="report-list">
  <style>
    :host {
      display: block;
    }

    .thead .th.rowspan-cell {
      padding: 0 !important;
      position: relative;
    }

    .rowspan-top {
      position: relative;
      left: -50%;
      line-height: 30px;
    }

    .rowspan-bottom {
      border-top: 1px solid #ddd;
      line-height: 30px;
      padding-right: 6px;
    }
  </style>
  <template>
    <form is="x-form" id="formSearch" method="GET" action="/master/trade/stat" on-iron-form-submit="submitForm" on-iron-form-response="handelQueryResponse">
      <div class="condition search-condition">
        <input type="hidden" name="startTime" value="{{cond.startTime}}" />
        <yun-date-time-picker label="* 开始日期" locale="ja" date-time="{{startTime}}" moment="{{time.startTime}}" max-date="{{time.endTime}}" data-msg-id="SCANPAY_TRADE_STATS.DATE_FROM" locale-msg-id="DATE_PICKER.LOCALE"></yun-date-time-picker>
        <input type="hidden" name="endTime" value="{{cond.endTime}}" />
        <yun-date-time-picker label="* 结束日期" locale="ja" date-time="{{endTime}}" moment="{{time.endTime}}" min-date="{{time.startTime}}" max-date="{{tomorrow}}" data-msg-id="SCANPAY_TRADE_STATS.DATE_TO" locale-msg-id="DATE_PICKER.LOCALE"></yun-date-time-picker>
        <yun-complete id="agentCode" name="agentCode" label="代理" url="/master/list" col-name="agent" code-field="agentCode" name-field="agentName" limit="6" selected-item="{{agent}}" disabled="{{agentDisabled}}" data-msg-id="SCANPAY_TRADE_LIST.AGENT"></yun-complete>
        <yun-complete id="subAgentCode" name="subAgentCode" label="公司" url="/master/list" col-name="subAgent" code-field="subAgentCode" name-field="subAgentName" limit="6" selected-item="{{subAgent}}" filter-condition="[[subAgentFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.SUBAGENT"></yun-complete>
        <yun-complete id="groupCode" name="groupCode" label="商户" url="/master/list" col-name="group" code-field="groupCode" name-field="groupName" limit="6" selected-item="{{group}}" filter-condition="[[groupFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.GROUP"></yun-complete>
        <yun-complete id="merId" name="merId" label="门店" url="/master/list" col-name="merchant" code-field="merId" name-field="merDetail.merName" limit="6" selected-item="{{merchant}}" filter-condition="[[merchantFilterCondition]]" data-msg-id="SCANPAY_TRADE_LIST.MERCHANT"></yun-complete>
        <paper-checkbox id="isAggregateByGroup" on-change="handleIsAggregateByGroupCheckboxChangeEvent">
          <i18n-msg msgid="SCANPAY_TRADE_STATS.AGGREGATE_BY_GROUP">按商户汇总</i18n-msg>
        </paper-checkbox>
        <input type="hidden" name="isAggregateByGroup" value="{{cond.isAggregateByGroup}}">
        <paper-button class="colorful" raised on-tap="handleQueryTapped">
          <i18n-msg msgid="BUTTON.QUERY">查询</i18n-msg>
        </paper-button>
      </div>

      <div class="data-grid table">
        <div class="thead">
          <div class="tr">
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_LIST.INDEX">序号</i18n-msg>
            </div>
            <div class="th left">
              <span hidden="{{cond.isAggregateByGroup}}">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.MERCHANT_NO">门店代码</i18n-msg>
              </span>
              <span hidden="{{!cond.isAggregateByGroup}}">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.GROUP_NO">商户代码</i18n-msg>
              </span>
            </div>
            <div class="th left" hidden="{{!cond.isAggregateByGroup}}">
              <i18n-msg msgid="SCANPAY_TRADE_STATS.GROUP_NAME">商户名称</i18n-msg>
            </div>
            <div class="th left" hidden="{{cond.isAggregateByGroup}}">
              <i18n-msg msgid="SCANPAY_TRADE_STATS.MERCHANT_NAME">门店名称</i18n-msg>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">&nbsp;</div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.TRANS_COUNT">笔数</i18n-msg>
              </div>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.SUMMARY">汇总</i18n-msg>
              </div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.AMOUNT">金额(元)</i18n-msg>
              </div>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">&nbsp;</div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.TRANS_COUNT">笔数</i18n-msg>
              </div>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">
                <i18n-msg msgid="CHANNEL.ALIPAY">支付宝</i18n-msg>
              </div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.AMOUNT">金额(元)</i18n-msg>
              </div>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">&nbsp;</div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.TRANS_COUNT">笔数</i18n-msg>
              </div>
            </div>
            <div class="th rowspan-cell">
              <div class="rowspan-top">
                <i18n-msg msgid="CHANNEL.WECHAT">微信</i18n-msg>
              </div>
              <div class="rowspan-bottom right">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.AMOUNT">金额(元)</i18n-msg>
              </div>
            </div>
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_STATS.AGENT_NAME">代理名称</i18n-msg>
            </div>
            <div class="th">
              <i18n-msg msgid="SCANPAY_TRADE_STATS.DOWNLOAD">下载</i18n-msg>
            </div>
          </div>
        </div>
        <div class="tbody">
          <template is="dom-repeat" items="{{records}}">
            <div class="tr">
              <div class="td center">
                <span>{{addOneFilter(index)}}</span>
              </div>
              <div class="td left">
                <span>{{item.merId}}</span>
              </div>
              <div class="td" hidden="{{!cond.isAggregateByGroup}}">
                <span>{{item.groupName}}</span>
              </div>
              <div class="td" hidden="{{cond.isAggregateByGroup}}">
                <span>{{item.merName}}</span>
              </div>
              <div class="td right">
                <span>{{item.totalTransNum}}</span>
              </div>
              <div class="td right">
                <span>{{_computeAmount(item.totalTransAmt)}}</span>
              </div>
              <div class="td right">
                <span>{{item.alp.transNum}}</span>
              </div>
              <div class="td right">
                <span>{{_computeAmount(item.alp.transAmt)}}</span>
              </div>
              <div class="td right">
                <span>{{item.wxp.transNum}}</span>
              </div>
              <div class="td right">
                <span>{{_computeAmount(item.wxp.transAmt)}}</span>
              </div>
              <div class="td center">
                <span>{{item.agentName}}</span>
              </div>
              <div class="td center">
                <a target="iframeForDownload" href="{{_computeDownLoadUrl(item)}}" alt="点我下载明细">
                  <i18n-msg msgid="SCANPAY_TRADE_STATS.DOWNLOAD_DETAIL">下载明细</i18n-msg>
                </a>
              </div>
            </div>
          </template>
        </div>
        <div class="tfoot">
          <div class="tr pagination">
            <x-pagination total="{{cond.total}}" size="{{cond.size}}" page="{{cond.page}}" on-page-change="handleQueryTapped"></x-pagination>
          </div>
          <div class="tr hover">
            <div class="td"></div>
            <div class="td"></div>
            <div class="td" hidden="{{!cond.isAggregateByGroup}}"></div>
            <div class="td" hidden="{{cond.isAggregateByGroup}}"></div>
            <div class="td right">
              <span>{{summary.totalTransNum}}</span>
            </div>
            <div class="td right">
              <span>{{_computeAmount(summary.totalTransAmt)}}</span>
            </div>
            <div class="td right">
              <span>{{summary.alp.transNum}}</span>
            </div>
            <div class="td right">
              <span>{{_computeAmount(summary.alp.transAmt)}}</span>
            </div>
            <div class="td right">
              <span>{{summary.wxp.transNum}}</span>
            </div>
            <div class="td right">
              <span>{{_computeAmount(summary.wxp.transAmt)}}</span>
            </div>
            <div class="td"></div>
            <div class="td center">
              <a href$="{{summaryReportUri}}" alt="点我下载当前所有商户交易汇总" target="iframeForDownload" hidden$="{{!isSummaryDownloadAvailable}}">
                <i18n-msg msgid="SCANPAY_TRADE_STATS.DOWNLOAD_SUMMARY">下载汇总</i18n-msg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </form>
    <x-ajax id="queryCurrentUserAjax" auto method="GET" url="/master/session/find" handle-as="json" debounce-duration="1000" on-response="handleQueryCurrentUserResponse"></x-ajax>
  </template>
  <script>
    // 币种精度表
    var CURRENCY_DECIMAL_MAP = {
      'GBP': {
        key: 'GBP',
        currency: 'British Sterling',
        decimal: 2
      },
      'HKD': {
        key: 'HKD',
        currency: 'Hong Kong Dollar',
        decimal: 2
      },
      'CNY': {
        key: 'CNY',
        currency: 'Chinese RMB',
        decimal: 2
      },
      'JPY': {
        key: 'JPY',
        currency: 'Japanese Yen',
        decimal: 0
      },
      'USD': {
        key: 'USD',
        currency: 'U.S. Dollar',
        decimal: 2
      }
    };
    (function() {
      Polymer({
        is: 'report-list',
        properties: {
          cond: {
            type: Object,
            value: function() {
              return {
                utcOffset: moment().utcOffset(),
                page: 1,
                size: 20,
                total: 0
              }
            }
          },
          tomorrow: {
            type: Date
          },
          isSummaryDownloadAvailable: {
            type: Boolean,
            value: false
          },
          time: {
            type: Object,
            value: function() {
              var startTime = moment().add(-1, 'd');
              startTime.hour(0);
              startTime.minute(0);
              startTime.second(0);

              var endTime = moment().add(-1, 'd');
              endTime.hour(23);
              endTime.minute(59);
              endTime.second(59);
              return {
                startTime: startTime.toDate(),
                startTimeString: moment(startTime).format('YYYY-MM-DD HH:mm:ss'),
                endTime: endTime.toDate(),
                endTimeString: moment(endTime).format('YYYY-MM-DD HH:mm:ss')
              }
            }
          },
          user: Object,
        },
        ready: function() {
          this.set('agent', {});
          // 过滤条件初始化
          this.set('subAgentFilterCondition', {});
          this.set('groupFilterCondition', {});
          this.set('merchantFilterCondition', {});

          // 明天的时间
          var tomorrowMoment = moment();
          tomorrowMoment.second(0);
          tomorrowMoment.minute(0);
          tomorrowMoment.hour(0);
          tomorrowMoment.add(1, 'days');
          tomorrowMoment.add(-1, 'seconds');
          this.set('tomorrow', tomorrowMoment.toDate());
        },
        attached: function() {
          this.fire('rerender-i18n', {
            from: 'report-list'
          });
        },
        observers: [
          '_watchAgentChange(agent.code)',
          '_watchSubAgentChange(subAgent.code)',
          '_watchGroupChange(group.code)',
          '_watchMerchantChange(merchant.code)',
          '_watchCondChange(cond.*)',
          '_watchUserChanged(user.*)',
          '_watchTimeChanged(time.startTime, time.endTime)'
        ],
        _watchAgentChange: function(key) {
          this.set('cond.agentCode', key);
          this.set('subAgentFilterCondition.agentCode', key);
          this.set('groupFilterCondition.agentCode', key);
          this.set('merchantFilterCondition.agentCode', key);

          this.$.subAgentCode.clear();
          this.$.groupCode.clear();
        },
        _watchSubAgentChange: function(key) {
          this.set('cond.subAgentCode', key);
          this.set('groupFilterCondition.subAgentCode', key);
          this.set('merchantFilterCondition.subAgentCode', key);
          this.$.groupCode.clear();
        },
        _watchGroupChange: function(key) {
          this.set('cond.groupCode', key);
          this.set('merchantFilterCondition.groupCode', key);
        },
        _watchMerchantChange: function(key) {
          this.set('cond.merId', key);
        },
        // 发送查询交易的ajax请求
        submitForm: function() {
          // this.trades = [];
          this.set('cond.page', 1);
          this.records = [];
        },
        // 查询交易报表事件
        handleQueryTapped: function() {
          this.$.formSearch.submit();
        },
        generateAjaxRequest: function() {},
        // 查询交易报表的响应事件
        handelQueryResponse: function(e) {
          var response = e.detail;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          var pagination = response.data;
          this.set('summary', pagination.data);
          if (pagination.count <= 0) {
            Util.toast('SCANPAY_TRADE_LIST.TOAST.NOT_FOUND', 3000, true);
            return;
          }
          this.currency = pagination.data.currency || 'JPY';
          this.records = pagination.data.data.slice(0);
          this.set('cond.total', pagination.total);
          this.set('cond.page', pagination.page);
          if (this.records.length === 0) {
            Util.toast('SCANPAY_TRADE_LIST.TOAST.NOT_FOUND', 3000, true);
          }

          this.isSummaryDownloadAvailable = true;
        },
        // 当前用户查询的响应事件
        handleQueryCurrentUserResponse: function(e) {
          var response = e.detail.response;
          if (response.status !== 0) {
            Util.toast(response.message, 3000);
            return;
          }
          this.set('user', response.data);
        },
        _watchTimeChanged: function(startTime, endTime) {
          this.set('time.startTimeString', moment(startTime).format('YYYY-MM-DD HH:mm:ss'));
          this.set('time.endTimeString', moment(endTime).format('YYYY-MM-DD HH:mm:ss'));
          this.set('cond.startTime', Util.toCSTDateTime(moment(this.time.startTime).format('YYYY-MM-DD HH:mm:ss')));
          this.set('cond.endTime', Util.toCSTDateTime(moment(this.time.endTime).format('YYYY-MM-DD HH:mm:ss')));
        },
        _watchCondChange: function() {
          var filename = "Summary_" + this.cond.startTime + "_" + this.cond.endTime + ".xlsx";
          filename = filename.replace(/-/g, '');
          this.summaryReportUri = '/master/trade/stat/report?' + Util.query(this.cond) + '&filename=' + filename;
          this.isSummaryDownloadAvailable = false;
        },
        _watchUserChanged: function(value) {
          if (value) {
            var user = value.base;
            if (user.userType === 'agent') {
              this.set('cond.agentCode', user.agentCode);
              this.set('agent.code', user.agentCode);
              this.agentDisabled = true;
            } else if (user.userType === 'subAgent') {
              this.set('cond.subAgentCode', user.subAgentCode);
              this.set('subAgent.code', user.subAgentCode);
              this.agentDisabled = true;
              this.$.subAgentCode.setAttribute('disabled', true);
            } else if (user.userType === 'group') {
              this.set('cond.groupCode', user.groupCode);
              this.set('group.code', user.groupCode);
              this.agentDisabled = true;
              this.$.subAgentCode.setAttribute('disabled', true);
              this.$.groupCode.setAttribute('disabled', true);
            } else if (user.userType === 'merchant') {
              this.set('cond.merId', user.merId);
              this.agentDisabled = true;
              this.$.subAgentCode.setAttribute('disabled', true);
              this.$.groupCode.setAttribute('disabled', true);
              this.$.merId.setAttribute('disabled', true);
            } else if (user.userType === 'admin') {
              this.agentDisabled = false;
              this.$.subAgentCode.removeAttribute('disabled');
              this.$.groupCode.removeAttribute('disabled');
              this.$.merId.removeAttribute('disabled');
            }
          }
        },
        getYesterdayISODate: function() {
          var now = new Date();
          var yesterday = new Date(now.valueOf() - 24 * 60 * 60 * 1000);
          return yesterday.format('yyyy-MM-dd');
        },
        // 修饰金额的方法
        _computeAmount: function(amount) {
          var currency = this.currency;
          if (!currency || currency === '') {
            currency = 'JPY';
          }

          var decInfo = CURRENCY_DECIMAL_MAP[currency];
          if (!decInfo) {
            decInfo = CURRENCY_DECIMAL_MAP['JPY'];
          }
          amount = (amount / Math.pow(10, decInfo.decimal)).toFixed(decInfo.decimal);
          return Util.beautifyAmount(amount);
        },
        // 整理下载报表的url
        _computeDownLoadUrl: function(item) {
          var filename = "Detail_" + this.cond.startTime + "_" + this.cond.endTime + ".xlsx";
          filename = filename.replace(/-/g, '');
          var obj = {};
          for (var i = 0, arr = Object.keys(this.cond), l = arr.length; i < l; i++) {
            var v = arr[i];
            obj[v] = this.cond[v];
          }
          obj.merId = item.merId;
          obj.filename = filename;
          return '/master/trade/report?' + Util.query(obj) + '&from=summary';
        },
        addOneFilter: function(index) {
          return index + 1;
        },
        // 按商户汇总统计的复选框改变事件
        handleIsAggregateByGroupCheckboxChangeEvent: function(e) {
          this.set('cond.isAggregateByGroup', e.target.checked);
          this.handleQueryTapped();
        }
      });
    })();
  </script>
</dom-module>

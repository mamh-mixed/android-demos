<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>创建绑定关系</title>
</head>
<body>

<template is="auto-binding" id="userFormTpl">

    <core-ajax id="postAjax" method="POST"
               ajax.contentType='application/json' handleAs="json"
               on-core-response="{{onResponse2}}"></core-ajax>

    <template repeat="{{e in elems}}">
        <paper-input-decorator floatingLabel label="{{e.label}}"  class="custom" autoValidate="{{e.autoValidate}}" error="{{e.error}}">
            <core-tooltip label="{{e.tooltip}}" position="top">
                <input id="{{e.id}}" is="core-input" name="{{e.name}}" maxlength="{{e.maxlength}}"
                       required="{{e.required}}" value="{{e.value}}">
            </core-tooltip>
            <paper-char-counter class="counter" target="{{e.id}}" ></paper-char-counter>
        </paper-input-decorator>
    </template>

    <paper-button id="submitForm" class="colored" raised on-core-click="{{send()}}">Send Message</paper-button>

    <paper-toast id="toast2" role="alert" text="{{rcvd}}">
        <div style="color: #eeff41;" onclick="console.log('RETRY')">Retry</div>
    </paper-toast>

</template>

<script>
    (function() {
        "use strict";

        var userFormTpl = document.querySelector('#userFormTpl');
        var postAjax;

        userFormTpl.addEventListener('template-bound', function(e) {
            postAjax = document.querySelector('#postAjax');
            var button = document.querySelector('#submitForm');
            button.addEventListener('click', send);
            postAjax.addEventListener("core-response", function(e, detail, sender) {
                userFormTpl.rcvd = JSON.stringify(e.detail.response);
            });

        });

        userFormTpl.elems = [
            {
                id: 'bindingId', name: "bindingId",
                label: "银行卡绑定ID",
                tooltip: '建立绑定关系时的银行卡绑定ID',
                value: "",
                required: true, maxlength: "32",
                autoValidate: true, error: "必填，最长 32 个字符"
            }
        ];

        function send() {
            postAjax.url = "/quickpay/bindingEnquiry?merId=CIL0001";
            postAjax.body = {};
            for (var i = 0; i < userFormTpl.elems.length; i++) {
                postAjax.body[userFormTpl.elems[i].name] = userFormTpl.elems[i].value;
            }
            postAjax.body = JSON.stringify(postAjax.body);
            var hash = CryptoJS.SHA1(postAjax.body + '8B584AC4157F0A61');
            postAjax.headers='{"X-Sign": "' + hash +'"}';

            // console.log( postAjax.url);
            // console.log( postAjax.body);
            postAjax.go();

            var el = document.querySelector('#toast2');
            el.show();
        }

    })();
</script>
</body>
</html>
